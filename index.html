<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<meta name="theme-color" content="#0a0a0a">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black">
<title>X-ZONE</title>
<link rel="manifest" href="manifest.json">
<link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'><rect width='32' height='32' fill='%23080808'/><text x='50%25' y='56%25' dominant-baseline='middle' text-anchor='middle' fill='%23c9a84c' font-size='20' font-family='serif' font-style='italic'>X</text></svg>">
<link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 180 180'><rect width='180' height='180' fill='%23080808'/><text x='50%25' y='56%25' dominant-baseline='middle' text-anchor='middle' fill='%23c9a84c' font-size='110' font-family='serif' font-style='italic'>X</text></svg>">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800&family=Playfair+Display:ital,wght@0,700;1,400&family=DM+Mono:wght@300;400;500&display=swap" rel="stylesheet">
<style>
:root {
  --gold: #c9a84c;
  --gold-light: #f0d080;
  --gold-dark: #8a6820;
  --bg: #080808;
  --bg2: #0f0f0f;
  --bg3: #161616;
  --bg4: #1e1e1e;
  --border: rgba(201,168,76,0.15);
  --border-bright: rgba(201,168,76,0.4);
  --text: #e8e8e8;
  --text-muted: #888;
  --danger: #c0392b;
  --success: #27ae60;
  --font-ui: 'Syne', sans-serif;
  --font-display: 'Playfair Display', serif;
  --font-mono: 'DM Mono', monospace;
}
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
html { font-size: 16px; }
body { background: var(--bg); color: var(--text); font-family: var(--font-ui); min-height: 100vh; overflow-x: hidden; }
::-webkit-scrollbar { width: 4px; }
::-webkit-scrollbar-track { background: var(--bg2); }
::-webkit-scrollbar-thumb { background: var(--gold-dark); border-radius: 2px; }
body::before {
  content: '';
  position: fixed; inset: 0;
  background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)' opacity='0.04'/%3E%3C/svg%3E");
  pointer-events: none; z-index: 0; opacity: 0.5;
}
.page { display: none; min-height: 100vh; position: relative; z-index: 1; }
.page.active { display: flex; flex-direction: column; }

/* ===== AUTH ===== */
#auth-page {
  align-items: center; justify-content: center; padding: 20px;
  background: radial-gradient(ellipse at 50% 0%, rgba(201,168,76,0.08) 0%, transparent 60%);
}
.auth-logo { text-align: center; margin-bottom: 40px; }
.auth-logo .logo-text {
  font-family: var(--font-display); font-size: clamp(3rem,12vw,5rem);
  color: var(--gold); letter-spacing: -2px; line-height: 1;
  text-shadow: 0 0 60px rgba(201,168,76,0.3);
}
.auth-logo .tagline {
  font-family: var(--font-mono); font-size: 11px; color: var(--text-muted);
  letter-spacing: 4px; text-transform: uppercase; margin-top: 8px;
}
.auth-card {
  background: var(--bg2); border: 1px solid var(--border); border-radius: 16px;
  padding: clamp(24px,6vw,40px); width: 100%; max-width: 420px;
  box-shadow: 0 40px 80px rgba(0,0,0,0.6), 0 0 0 1px rgba(201,168,76,0.05);
}
.auth-tabs {
  display: flex; gap: 4px; background: var(--bg3); border-radius: 10px;
  padding: 4px; margin-bottom: 28px;
}
.auth-tab {
  flex: 1; padding: 10px; border: none; background: transparent;
  color: var(--text-muted); font-family: var(--font-ui); font-size: 13px;
  font-weight: 600; cursor: pointer; border-radius: 7px; transition: all 0.2s;
}
.auth-tab.active { background: var(--gold); color: var(--bg); }
.form-group { margin-bottom: 16px; }
.form-label {
  display: block; font-family: var(--font-mono); font-size: 11px;
  color: var(--gold); letter-spacing: 2px; text-transform: uppercase; margin-bottom: 8px;
}
.form-input {
  width: 100%; background: var(--bg3); border: 1px solid var(--border);
  color: var(--text); font-family: var(--font-ui); font-size: 14px;
  padding: 12px 16px; border-radius: 10px; outline: none; transition: border-color 0.2s;
}
.form-input:focus { border-color: var(--gold); }
.form-input::placeholder { color: var(--text-muted); }
.btn {
  width: 100%; padding: 14px; border: none; border-radius: 10px;
  font-family: var(--font-ui); font-size: 14px; font-weight: 700; cursor: pointer;
  transition: all 0.2s; letter-spacing: 1px; text-transform: uppercase;
}
.btn-gold { background: linear-gradient(135deg,var(--gold-dark),var(--gold),var(--gold-light)); color: var(--bg); }
.btn-gold:hover { transform: translateY(-1px); box-shadow: 0 8px 24px rgba(201,168,76,0.3); }
.btn-gold:active { transform: translateY(0); }
.btn-outline { background: transparent; border: 1px solid var(--border-bright); color: var(--gold); margin-top: 10px; }
.btn-outline:hover { background: rgba(201,168,76,0.08); }
.fingerprint-btn {
  width: 100%; display: flex; align-items: center; justify-content: center; gap: 10px;
  padding: 14px; background: var(--bg3); border: 1px dashed var(--border-bright);
  border-radius: 10px; color: var(--gold); font-family: var(--font-ui); font-size: 14px;
  font-weight: 600; cursor: pointer; transition: all 0.2s; margin-top: 16px;
}
.fingerprint-btn:hover { background: rgba(201,168,76,0.05); }
.fingerprint-icon { font-size: 22px; animation: pulse 2s infinite; }
@keyframes pulse { 0%,100% { opacity:1; } 50% { opacity:0.5; } }
.auth-form { display: none; }
.auth-form.active { display: block; }

/* ===== APP SHELL ===== */
#app-page { flex-direction: column; max-width: 100vw; }
.topbar {
  position: fixed; top: 0; left: 0; right: 0; height: 56px;
  background: rgba(8,8,8,0.95); backdrop-filter: blur(20px);
  border-bottom: 1px solid var(--border); display: flex; align-items: center;
  padding: 0 16px; gap: 12px; z-index: 100;
}
.topbar-logo { font-family: var(--font-display); font-size: 22px; color: var(--gold); font-style: italic; flex-shrink: 0; }
.topbar-section { flex: 1; font-family: var(--font-mono); font-size: 11px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 2px; text-align: center; }
.topbar-actions { display: flex; align-items: center; gap: 8px; flex-shrink: 0; }
.icon-btn {
  width: 36px; height: 36px; background: var(--bg3); border: 1px solid var(--border);
  border-radius: 8px; color: var(--text-muted); cursor: pointer;
  display: flex; align-items: center; justify-content: center; font-size: 16px;
  transition: all 0.2s; flex-shrink: 0;
}
.icon-btn:hover { border-color: var(--gold); color: var(--gold); }
.notif-dot { position: relative; }
.notif-dot::after {
  content: ''; position: absolute; top: 6px; right: 6px; width: 7px; height: 7px;
  background: var(--gold); border-radius: 50%; border: 1px solid var(--bg);
}
.bottom-nav {
  position: fixed; bottom: 0; left: 0; right: 0; height: 60px;
  background: rgba(8,8,8,0.98); backdrop-filter: blur(20px);
  border-top: 1px solid var(--border); display: flex; align-items: stretch; z-index: 100;
}
.nav-item {
  flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center;
  gap: 4px; cursor: pointer; transition: all 0.2s; padding: 8px 0; border: none;
  background: none; color: var(--text-muted); position: relative;
}
.nav-item.active { color: var(--gold); }
.nav-item.active::before {
  content: ''; position: absolute; top: 0; left: 30%; right: 30%;
  height: 2px; background: var(--gold); border-radius: 0 0 4px 4px;
}
.nav-icon { font-size: 20px; }
.nav-label { font-family: var(--font-mono); font-size: 9px; letter-spacing: 1px; text-transform: uppercase; }
.content { margin-top: 56px; margin-bottom: 60px; flex: 1; overflow-y: auto; }
.section { display: none; }
.section.active { display: block; }

/* ===== FLUX ===== */
.flux-header { padding: 16px; border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; gap: 12px; }
.section-title { font-family: var(--font-display); font-size: clamp(18px,5vw,22px); color: var(--gold); font-style: italic; }
.compose-area { padding: 16px; background: var(--bg2); border-bottom: 1px solid var(--border); }
.compose-inner { background: var(--bg3); border: 1px solid var(--border); border-radius: 12px; padding: 12px; }
.compose-textarea {
  width: 100%; background: transparent; border: none; color: var(--text);
  font-family: var(--font-ui); font-size: 14px; resize: none; outline: none;
  min-height: 60px; line-height: 1.5;
}
.compose-textarea::placeholder { color: var(--text-muted); }
.compose-actions {
  display: flex; align-items: center; gap: 8px; margin-top: 10px;
  border-top: 1px solid var(--border); padding-top: 10px; flex-wrap: wrap;
}
.compose-meta { font-family: var(--font-mono); font-size: 10px; color: var(--text-muted); flex: 1; min-width: 120px; }
.compose-meta span { color: var(--gold); }
.mini-btn {
  padding: 8px 12px; background: var(--bg4); border: 1px solid var(--border);
  border-radius: 8px; color: var(--text-muted); font-size: 14px; cursor: pointer;
  transition: all 0.2s; white-space: nowrap;
}
.mini-btn:hover { border-color: var(--gold); color: var(--gold); }
.send-btn {
  padding: 8px 16px; background: var(--gold); border: none; border-radius: 8px;
  color: var(--bg); font-family: var(--font-ui); font-size: 12px; font-weight: 700;
  cursor: pointer; letter-spacing: 1px; text-transform: uppercase; transition: all 0.2s;
}
.send-btn:hover { background: var(--gold-light); }
.posts-feed { padding: 8px; }

/* POST CARD */
.post-card {
  background: var(--bg2); border: 1px solid var(--border); border-radius: 12px;
  padding: 14px; margin-bottom: 8px; transition: border-color 0.2s;
  animation: slideIn 0.3s ease;
}
@keyframes slideIn { from { opacity:0; transform:translateY(-10px); } to { opacity:1; transform:translateY(0); } }
@keyframes slideOut { to { opacity:0; transform:translateY(-10px) scale(0.98); max-height:0; padding:0; margin:0; overflow:hidden; } }
.post-card:hover { border-color: var(--border-bright); }
.post-header { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; }
.post-avatar {
  width: 34px; height: 34px; border-radius: 50%;
  background: linear-gradient(135deg,var(--gold-dark),var(--bg3));
  border: 1px solid var(--border-bright); display: flex; align-items: center; justify-content: center;
  font-family: var(--font-mono); font-size: 11px; color: var(--gold); flex-shrink: 0; font-weight: 500;
}
.post-meta { flex: 1; min-width: 0; }
.post-pseudo { font-size: 13px; font-weight: 700; color: var(--text); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.post-time { font-family: var(--font-mono); font-size: 10px; color: var(--text-muted); }
.post-text { font-size: 14px; line-height: 1.6; color: var(--text); word-break: break-word; margin-bottom: 10px; }
.post-image { width: 100%; border-radius: 8px; max-height: 300px; object-fit: cover; margin-bottom: 10px; cursor: pointer; }
.post-video-wrap { position: relative; width: 100%; border-radius: 10px; overflow: hidden; margin-bottom: 10px; background: #000; cursor: pointer; }
.post-video { width: 100%; max-height: 480px; object-fit: cover; display: block; border-radius: 10px; }
.video-overlay {
  position: absolute; inset: 0; display: flex; align-items: center; justify-content: center;
  background: rgba(0,0,0,0.2); opacity: 0; transition: opacity 0.25s; border-radius: 10px; pointer-events: none;
}
.post-video-wrap.paused .video-overlay { opacity: 1; }
.play-icon {
  width: 54px; height: 54px; background: rgba(0,0,0,0.6); border-radius: 50%;
  display: flex; align-items: center; justify-content: center; font-size: 22px; color: white;
  backdrop-filter: blur(4px); border: 2px solid rgba(255,255,255,0.3);
}
.video-mute-btn {
  position: absolute; bottom: 38px; right: 10px; width: 30px; height: 30px;
  background: rgba(0,0,0,0.6); border: 1px solid rgba(255,255,255,0.2); border-radius: 50%;
  color: white; font-size: 13px; cursor: pointer; display: flex; align-items: center; justify-content: center;
  backdrop-filter: blur(4px); z-index: 5; transition: background 0.2s;
}
.video-mute-btn:hover { background: rgba(201,168,76,0.7); }
.video-duration {
  position: absolute; bottom: 38px; left: 10px; font-family: var(--font-mono); font-size: 10px;
  color: white; background: rgba(0,0,0,0.5); padding: 2px 6px; border-radius: 4px; pointer-events: none;
}
.video-progress { position: absolute; bottom: 0; left: 0; right: 0; height: 4px; background: rgba(255,255,255,0.15); cursor: pointer; z-index: 5; }
.video-progress-fill { height: 100%; background: linear-gradient(90deg,var(--gold-dark),var(--gold)); width: 0%; pointer-events: none; }
.delete-post-btn {
  background: none; border: none; color: var(--text-muted); cursor: pointer;
  padding: 4px 8px; border-radius: 6px; transition: all 0.2s;
  display: flex; align-items: center; gap: 4px; font-family: var(--font-mono); font-size: 11px; margin-left: auto;
}
.delete-post-btn:hover { color: var(--danger); background: rgba(192,57,43,0.1); }
.post-actions { display: flex; align-items: center; gap: 16px; }
.vote-btn {
  background: none; border: none; color: var(--text-muted); font-size: 13px; cursor: pointer;
  display: flex; align-items: center; gap: 5px; font-family: var(--font-mono); transition: color 0.2s; padding: 4px 0;
}
.vote-btn:hover { color: var(--gold); }
.vote-btn.active-up { color: #4ade80; }
.vote-btn.active-down { color: #f87171; }
.post-score { font-family: var(--font-mono); font-size: 12px; color: var(--gold); margin: 0 4px; }

/* ===== FACTIONS ===== */
.factions-header { padding: 16px; border-bottom: 1px solid var(--border); }
.search-bar { display: flex; gap: 8px; margin-top: 12px; }
.search-input {
  flex: 1; background: var(--bg3); border: 1px solid var(--border); color: var(--text);
  font-family: var(--font-ui); font-size: 13px; padding: 10px 14px; border-radius: 10px;
  outline: none; transition: border-color 0.2s;
}
.search-input:focus { border-color: var(--gold); }
.search-input::placeholder { color: var(--text-muted); }
.factions-grid { display: grid; grid-template-columns: repeat(auto-fill,minmax(min(100%,180px),1fr)); gap: 10px; padding: 16px; }
.faction-card {
  background: var(--bg2); border: 1px solid var(--border); border-radius: 12px;
  padding: 16px; cursor: pointer; transition: all 0.2s; position: relative; overflow: hidden;
}
.faction-card::before {
  content: ''; position: absolute; top: 0; left: 0; right: 0; height: 2px;
  background: linear-gradient(90deg,transparent,var(--gold),transparent); opacity: 0; transition: opacity 0.2s;
}
.faction-card:hover { border-color: var(--border-bright); transform: translateY(-2px); }
.faction-card:hover::before { opacity: 1; }
.faction-emoji { font-size: 28px; margin-bottom: 8px; }
.faction-name { font-size: 14px; font-weight: 700; color: var(--text); margin-bottom: 4px; }
.faction-tag { font-family: var(--font-mono); font-size: 10px; color: var(--gold); }
.faction-members { font-family: var(--font-mono); font-size: 10px; color: var(--text-muted); margin-top: 8px; }
.create-faction-btn {
  display: flex; align-items: center; justify-content: center; flex-direction: column; gap: 8px;
  background: transparent; border: 1px dashed var(--border-bright); border-radius: 12px;
  padding: 16px; cursor: pointer; transition: all 0.2s; color: var(--gold); font-family: var(--font-ui);
  font-size: 12px; font-weight: 600; text-transform: uppercase; letter-spacing: 1px;
}
.create-faction-btn:hover { background: rgba(201,168,76,0.05); }

/* ===== MARKET ===== */
.market-header { padding: 16px; border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; gap: 12px; }
.market-grid { display: grid; grid-template-columns: repeat(auto-fill,minmax(min(100%,160px),1fr)); gap: 10px; padding: 16px; }
.listing-card { background: var(--bg2); border: 1px solid var(--border); border-radius: 12px; overflow: hidden; cursor: pointer; transition: all 0.2s; }
.listing-card:hover { border-color: var(--border-bright); transform: translateY(-2px); }
.listing-img {
  width: 100%; aspect-ratio: 1; object-fit: cover; background: var(--bg3);
  display: flex; align-items: center; justify-content: center; font-size: 32px; color: var(--border);
}
.listing-img img { width: 100%; height: 100%; object-fit: cover; }
.listing-body { padding: 10px; }
.listing-title { font-size: 12px; font-weight: 700; color: var(--text); margin-bottom: 4px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.listing-price { font-family: var(--font-mono); font-size: 12px; color: var(--gold); display: flex; align-items: center; gap: 4px; }
.listing-badge {
  display: inline-block; padding: 2px 6px; background: rgba(201,168,76,0.15);
  border: 1px solid var(--border-bright); border-radius: 4px; font-family: var(--font-mono);
  font-size: 9px; color: var(--gold); margin-top: 5px;
}

/* ===== PROFIL ===== */
.profile-section {
  padding: 24px 16px 16px; display: flex; flex-direction: column; align-items: center;
  text-align: center; border-bottom: 1px solid var(--border);
}
.profile-avatar {
  width: 80px; height: 80px; border-radius: 50%;
  background: linear-gradient(135deg,var(--gold-dark) 0%,var(--bg3) 100%);
  border: 2px solid var(--gold); display: flex; align-items: center; justify-content: center;
  font-family: var(--font-display); font-size: 28px; color: var(--gold); margin-bottom: 12px;
  box-shadow: 0 0 30px rgba(201,168,76,0.2);
}
.profile-name { font-family: var(--font-display); font-size: 22px; color: var(--gold); font-style: italic; }
.profile-pseudo { font-family: var(--font-mono); font-size: 12px; color: var(--text-muted); margin-top: 4px; }
.profile-id { font-family: var(--font-mono); font-size: 10px; color: var(--border-bright); margin-top: 8px; padding: 4px 12px; background: var(--bg3); border-radius: 20px; }
.profile-stats { display: flex; gap: 24px; margin-top: 16px; }
.stat { text-align: center; }
.stat-num { font-family: var(--font-mono); font-size: 20px; color: var(--gold); font-weight: 500; }
.stat-label { font-size: 11px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; }
.profile-menu { padding: 16px; display: flex; flex-direction: column; gap: 8px; }
.menu-item {
  display: flex; align-items: center; gap: 14px; padding: 14px 16px; background: var(--bg2);
  border: 1px solid var(--border); border-radius: 12px; cursor: pointer; transition: all 0.2s;
  text-decoration: none; color: var(--text); font-size: 14px; font-weight: 600;
}
.menu-item:hover { border-color: var(--border-bright); }
.menu-item-icon { font-size: 18px; width: 24px; text-align: center; }
.menu-item-arrow { margin-left: auto; color: var(--text-muted); font-size: 12px; }
.menu-item.danger { color: var(--danger); border-color: rgba(192,57,43,0.2); }
.menu-item.danger:hover { border-color: rgba(192,57,43,0.5); background: rgba(192,57,43,0.05); }

/* ===== MODAL ===== */
.modal-overlay {
  position: fixed; inset: 0; background: rgba(0,0,0,0.85); backdrop-filter: blur(8px);
  z-index: 200; display: none; align-items: flex-end; justify-content: center; padding: 16px;
}
.modal-overlay.active { display: flex; animation: fadeIn 0.2s ease; }
@keyframes fadeIn { from { opacity:0; } to { opacity:1; } }
.modal {
  background: var(--bg2); border: 1px solid var(--border-bright); border-radius: 20px 20px 16px 16px;
  padding: 24px; width: 100%; max-width: 480px; max-height: 90vh; overflow-y: auto;
  animation: slideUp 0.3s ease;
}
@keyframes slideUp { from { transform:translateY(40px); opacity:0; } to { transform:translateY(0); opacity:1; } }
.modal-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px; }
.modal-title { font-family: var(--font-display); font-size: 20px; color: var(--gold); font-style: italic; }
.modal-close {
  width: 32px; height: 32px; background: var(--bg3); border: 1px solid var(--border);
  border-radius: 8px; color: var(--text-muted); cursor: pointer; display: flex;
  align-items: center; justify-content: center; font-size: 16px; transition: all 0.2s;
}
.modal-close:hover { color: var(--gold); border-color: var(--gold); }

/* TOAST */
.toast-container {
  position: fixed; top: 70px; left: 50%; transform: translateX(-50%); z-index: 300;
  display: flex; flex-direction: column; gap: 8px; pointer-events: none;
  width: calc(100% - 32px); max-width: 360px;
}
.toast {
  background: var(--bg3); border: 1px solid var(--border-bright); border-radius: 10px;
  padding: 12px 16px; font-size: 13px; color: var(--text); display: flex; align-items: center; gap: 10px;
  animation: toastIn 0.3s ease forwards; box-shadow: 0 8px 24px rgba(0,0,0,0.4);
}
.toast.success { border-color: rgba(39,174,96,0.5); }
.toast.error { border-color: rgba(192,57,43,0.5); }
@keyframes toastIn { from { opacity:0; transform:translateY(-16px); } to { opacity:1; transform:translateY(0); } }
@keyframes toastOut { to { opacity:0; transform:translateY(-16px); } }

/* UPLOAD PREVIEW */
.upload-preview { display: none; position: relative; margin-bottom: 10px; }
.upload-preview img { width: 100%; max-height: 200px; object-fit: cover; border-radius: 8px; }
.upload-preview.active { display: block; }
.remove-upload {
  position: absolute; top: 8px; right: 8px; width: 28px; height: 28px;
  background: rgba(0,0,0,0.7); border: 1px solid var(--border); border-radius: 50%;
  color: var(--text); cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 14px;
}
.loading { display: flex; align-items: center; justify-content: center; padding: 40px; color: var(--text-muted); font-family: var(--font-mono); font-size: 12px; letter-spacing: 2px; }
.spinner { width: 20px; height: 20px; border: 2px solid var(--border); border-top-color: var(--gold); border-radius: 50%; animation: spin 0.8s linear infinite; margin-right: 10px; }
@keyframes spin { to { transform:rotate(360deg); } }
.empty-state { text-align: center; padding: 60px 20px; color: var(--text-muted); }
.empty-icon { font-size: 48px; margin-bottom: 12px; opacity: 0.5; }
.empty-title { font-size: 16px; font-weight: 600; margin-bottom: 6px; }
.empty-sub { font-size: 13px; }
.img-viewer { position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 400; display: none; align-items: center; justify-content: center; }
.img-viewer.active { display: flex; }
.img-viewer img { max-width: 100%; max-height: 100%; object-fit: contain; }
.img-viewer-close { position: absolute; top: 16px; right: 16px; font-size: 28px; color: white; cursor: pointer; background: none; border: none; }
.faction-detail { display: none; }
.faction-detail.active { display: block; }
.faction-detail-header { padding: 20px 16px 16px; border-bottom: 1px solid var(--border); background: linear-gradient(180deg,rgba(201,168,76,0.05) 0%,transparent 100%); }
.back-btn { display: flex; align-items: center; gap: 8px; background: none; border: none; color: var(--text-muted); font-family: var(--font-ui); font-size: 13px; cursor: pointer; margin-bottom: 12px; padding: 0; }
.back-btn:hover { color: var(--gold); }
.crypto-address { font-family: var(--font-mono); font-size: 11px; background: var(--bg3); border: 1px solid var(--border); padding: 10px 12px; border-radius: 8px; word-break: break-all; color: var(--gold); margin-top: 8px; cursor: pointer; transition: border-color 0.2s; }
.crypto-address:hover { border-color: var(--gold); }
.tag { display: inline-block; padding: 3px 8px; background: rgba(201,168,76,0.1); border: 1px solid var(--border); border-radius: 20px; font-family: var(--font-mono); font-size: 10px; color: var(--gold); margin: 2px; }
.filter-tabs { display: flex; gap: 6px; padding: 12px 16px; border-bottom: 1px solid var(--border); overflow-x: auto; -webkit-overflow-scrolling: touch; }
.filter-tab { padding: 6px 12px; background: var(--bg3); border: 1px solid var(--border); border-radius: 20px; color: var(--text-muted); font-family: var(--font-mono); font-size: 11px; cursor: pointer; white-space: nowrap; transition: all 0.2s; flex-shrink: 0; }
.filter-tab.active { background: rgba(201,168,76,0.15); border-color: var(--gold); color: var(--gold); }
.install-banner { position: fixed; bottom: 70px; left: 16px; right: 16px; background: var(--bg2); border: 1px solid var(--border-bright); border-radius: 12px; padding: 14px 16px; display: flex; align-items: center; gap: 12px; z-index: 99; box-shadow: 0 8px 32px rgba(0,0,0,0.4); animation: slideUp 0.3s ease; }
.install-banner.hidden { display: none; }
.install-banner-text { flex: 1; font-size: 13px; }
.install-banner-title { font-weight: 700; color: var(--gold); font-size: 13px; }
.install-banner-sub { font-size: 11px; color: var(--text-muted); margin-top: 2px; }
.install-btn { padding: 8px 14px; background: var(--gold); border: none; border-radius: 8px; color: var(--bg); font-family: var(--font-ui); font-size: 12px; font-weight: 700; cursor: pointer; flex-shrink: 0; }
.install-close { background: none; border: none; color: var(--text-muted); cursor: pointer; font-size: 18px; flex-shrink: 0; }
.notif-panel { position: fixed; top: 56px; right: 0; width: min(320px,100vw); max-height: calc(100vh - 56px); background: var(--bg2); border-left: 1px solid var(--border); border-bottom: 1px solid var(--border); overflow-y: auto; z-index: 150; transform: translateX(100%); transition: transform 0.3s ease; }
.notif-panel.open { transform: translateX(0); }
.notif-header { padding: 16px; border-bottom: 1px solid var(--border); font-family: var(--font-display); font-size: 18px; color: var(--gold); font-style: italic; }
.notif-item { padding: 14px 16px; border-bottom: 1px solid var(--border); font-size: 13px; transition: background 0.2s; }
.notif-item:hover { background: var(--bg3); }
.notif-item.unread { border-left: 2px solid var(--gold); }
.notif-item-meta { font-family: var(--font-mono); font-size: 10px; color: var(--text-muted); margin-top: 4px; }

/* ===== MESSAGES ===== */
.msg-badge { position: absolute; top: 4px; right: 4px; min-width: 16px; height: 16px; background: var(--gold); border-radius: 8px; font-family: var(--font-mono); font-size: 9px; color: var(--bg); display: none; align-items: center; justify-content: center; font-weight: 700; padding: 0 3px; border: 1px solid var(--bg); }
.msg-badge.show { display: flex; }
.conv-list { padding: 8px; }
.conv-item { display: flex; align-items: center; gap: 12px; padding: 12px 14px; background: var(--bg2); border: 1px solid var(--border); border-radius: 12px; margin-bottom: 8px; cursor: pointer; transition: all 0.2s; position: relative; }
.conv-item:hover { border-color: var(--border-bright); }
.conv-item.unread { border-left: 3px solid var(--gold); }
.conv-avatar { width: 42px; height: 42px; border-radius: 50%; background: linear-gradient(135deg,var(--gold-dark),var(--bg3)); border: 1px solid var(--border-bright); display: flex; align-items: center; justify-content: center; font-family: var(--font-mono); font-size: 14px; color: var(--gold); flex-shrink: 0; font-weight: 500; }
.conv-info { flex: 1; min-width: 0; }
.conv-name { font-size: 13px; font-weight: 700; color: var(--text); display: flex; align-items: center; gap: 6px; }
.conv-preview { font-size: 12px; color: var(--text-muted); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin-top: 2px; }
.conv-time { font-family: var(--font-mono); font-size: 10px; color: var(--text-muted); flex-shrink: 0; align-self: flex-start; }
.chat-input { flex: 1; background: var(--bg3); border: 1px solid var(--border); color: var(--text); font-family: var(--font-ui); font-size: 13px; padding: 10px 14px; border-radius: 22px; outline: none; resize: none; max-height: 100px; overflow-y: auto; line-height: 1.4; transition: border-color 0.2s; }
.chat-input:focus { border-color: var(--gold); }
.chat-input::placeholder { color: var(--text-muted); }
.chat-send-btn { width: 40px; height: 40px; background: var(--gold); border: none; border-radius: 50%; color: var(--bg); font-size: 16px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s; flex-shrink: 0; }
.chat-send-btn:hover { background: var(--gold-light); transform: scale(1.05); }
.chat-send-btn:active { transform: scale(0.95); }
.chat-attach-btn { width: 36px; height: 36px; background: var(--bg3); border: 1px solid var(--border); border-radius: 50%; color: var(--text-muted); font-size: 16px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s; flex-shrink: 0; }
.chat-attach-btn:hover { border-color: var(--gold); color: var(--gold); }
.msg-bubble-wrap { display: flex; gap: 8px; animation: slideIn 0.2s ease; }
.msg-bubble-wrap.mine { flex-direction: row-reverse; }
.msg-avatar-sm { width: 28px; height: 28px; border-radius: 50%; background: linear-gradient(135deg,var(--gold-dark),var(--bg3)); border: 1px solid var(--border-bright); display: flex; align-items: center; justify-content: center; font-family: var(--font-mono); font-size: 10px; color: var(--gold); flex-shrink: 0; align-self: flex-end; }
.msg-bubble { max-width: 72%; padding: 10px 14px; border-radius: 18px; font-size: 13px; line-height: 1.5; word-break: break-word; position: relative; }
.msg-bubble-wrap:not(.mine) .msg-bubble { background: var(--bg3); border: 1px solid var(--border); border-bottom-left-radius: 4px; color: var(--text); }
.msg-bubble-wrap.mine .msg-bubble { background: linear-gradient(135deg,var(--gold-dark),#a07828); color: #fff; border-bottom-right-radius: 4px; }
.msg-time { font-family: var(--font-mono); font-size: 9px; color: rgba(255,255,255,0.5); margin-top: 4px; text-align: right; }
.msg-bubble-wrap:not(.mine) .msg-time { color: var(--text-muted); text-align: left; }
.msg-image { max-width: 100%; border-radius: 12px; margin-bottom: 4px; cursor: pointer; display: block; }
.msg-date-sep { text-align: center; font-family: var(--font-mono); font-size: 10px; color: var(--text-muted); margin: 8px 0; letter-spacing: 1px; }
#section-msgs { display: none; flex-direction: column; }
#section-msgs.active { display: flex; }
.msgs-tabs { display: flex; background: var(--bg3); border-bottom: 1px solid var(--border); flex-shrink: 0; }
.msgs-tab { flex: 1; padding: 12px; border: none; background: transparent; color: var(--text-muted); font-family: var(--font-mono); font-size: 11px; cursor: pointer; transition: all 0.2s; letter-spacing: 1px; text-transform: uppercase; border-bottom: 2px solid transparent; display: flex; align-items: center; justify-content: center; gap: 6px; }
.msgs-tab.active { color: var(--gold); border-bottom-color: var(--gold); background: rgba(201,168,76,0.05); }
.post-pseudo-clickable { cursor: pointer; transition: color 0.2s; }
.post-pseudo-clickable:hover { color: var(--gold); }
.user-list-item { display: flex; align-items: center; gap: 12px; padding: 12px 16px; cursor: pointer; border-bottom: 1px solid var(--border); transition: background 0.15s; position: relative; }
.user-list-item:hover { background: var(--bg3); }
.user-list-avatar { width: 44px; height: 44px; border-radius: 50%; background: linear-gradient(135deg,var(--gold-dark),var(--bg3)); border: 1px solid var(--border-bright); display: flex; align-items: center; justify-content: center; font-family: var(--font-display); font-size: 16px; color: var(--gold); flex-shrink: 0; font-weight: 700; }
.user-list-info { flex: 1; min-width: 0; }
.user-list-pseudo { font-size: 14px; font-weight: 700; color: var(--text); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.user-list-name { font-family: var(--font-mono); font-size: 11px; color: var(--text-muted); margin-top: 2px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.user-list-arrow { color: var(--text-muted); font-size: 18px; flex-shrink: 0; }
.user-list-unread { width: 20px; height: 20px; background: var(--gold); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-family: var(--font-mono); font-size: 10px; color: var(--bg); font-weight: 700; flex-shrink: 0; }
.user-section-label { padding: 8px 16px 4px; font-family: var(--font-mono); font-size: 10px; color: var(--text-muted); letter-spacing: 2px; text-transform: uppercase; background: var(--bg); }

/* ANON ROOM */
.anon-room-wrap { display: flex; flex-direction: column; height: calc(100vh - 116px); border-top: 1px solid var(--border); }
.anon-room-header { padding: 12px 16px; background: var(--bg2); border-bottom: 1px solid var(--border); display: flex; align-items: center; gap: 10px; flex-shrink: 0; }
.anon-room-title { font-family: var(--font-display); font-size: 17px; color: var(--gold); font-style: italic; flex: 1; }
.room-online { display: flex; align-items: center; gap: 5px; font-family: var(--font-mono); font-size: 10px; color: #4ade80; }
.room-online::before { content: ''; width: 7px; height: 7px; border-radius: 50%; background: #4ade80; animation: pulse 2s infinite; }
.anon-room-messages { flex: 1; overflow-y: auto; padding: 10px 12px; display: flex; flex-direction: column; gap: 6px; }
.room-msg { display: flex; gap: 8px; animation: slideIn 0.2s ease; }
.room-msg.mine { flex-direction: row-reverse; }
.room-avatar { width: 28px; height: 28px; border-radius: 50%; background: var(--bg3); border: 1px solid var(--border); display: flex; align-items: center; justify-content: center; font-family: var(--font-mono); font-size: 9px; color: var(--text-muted); flex-shrink: 0; align-self: flex-end; }
.room-bubble { max-width: 75%; padding: 8px 12px; border-radius: 16px; font-size: 13px; line-height: 1.5; word-break: break-word; }
.room-msg:not(.mine) .room-bubble { background: var(--bg3); border: 1px solid var(--border); border-bottom-left-radius: 4px; color: var(--text); }
.room-msg.mine .room-bubble { background: linear-gradient(135deg,var(--gold-dark),#a07828); color: white; border-bottom-right-radius: 4px; }
.room-sender { font-family: var(--font-mono); font-size: 9px; margin-bottom: 3px; opacity: 0.7; }
.room-msg.mine .room-sender { text-align: right; }
.room-time { font-family: var(--font-mono); font-size: 9px; opacity: 0.5; margin-top: 3px; text-align: right; }
.room-msg:not(.mine) .room-time { text-align: left; }
.anon-room-input { padding: 10px 12px; border-top: 1px solid var(--border); display: flex; align-items: flex-end; gap: 8px; background: var(--bg2); flex-shrink: 0; }

/* USER POPUP */
.user-popup-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.7); backdrop-filter: blur(6px); z-index: 250; display: none; align-items: flex-end; justify-content: center; padding: 16px; }
.user-popup-overlay.active { display: flex; animation: fadeIn 0.2s ease; }
.user-popup { background: var(--bg2); border: 1px solid var(--border-bright); border-radius: 20px; padding: 24px; width: 100%; max-width: 400px; animation: slideUp 0.3s ease; }
.user-popup-avatar { width: 64px; height: 64px; border-radius: 50%; background: linear-gradient(135deg,var(--gold-dark),var(--bg3)); border: 2px solid var(--gold); display: flex; align-items: center; justify-content: center; font-family: var(--font-display); font-size: 24px; color: var(--gold); margin: 0 auto 12px; }
.user-popup-name { text-align: center; font-family: var(--font-display); font-size: 20px; color: var(--gold); font-style: italic; margin-bottom: 4px; }
.user-popup-pseudo { text-align: center; font-family: var(--font-mono); font-size: 12px; color: var(--text-muted); margin-bottom: 20px; }
.user-popup-actions { display: flex; flex-direction: column; gap: 10px; }
.popup-msg-btn { display: flex; align-items: center; justify-content: center; gap: 10px; padding: 14px; background: linear-gradient(135deg,var(--gold-dark),var(--gold)); border: none; border-radius: 12px; color: var(--bg); font-family: var(--font-ui); font-size: 14px; font-weight: 700; cursor: pointer; transition: all 0.2s; letter-spacing: 1px; }
.popup-msg-btn:hover { transform: translateY(-1px); box-shadow: 0 8px 24px rgba(201,168,76,0.3); }
.popup-close-btn { padding: 12px; background: var(--bg3); border: 1px solid var(--border); border-radius: 12px; color: var(--text-muted); font-family: var(--font-ui); font-size: 13px; cursor: pointer; transition: all 0.2s; text-align: center; }
.popup-close-btn:hover { border-color: var(--border-bright); }

/* ===== WELCOME/GOODBYE BANNER ===== */
.xz-entry-banner {
  position: fixed; top: 0; left: 0; right: 0; z-index: 9999;
  display: flex; align-items: center; gap: 14px; padding: 14px 20px;
  transform: translateY(-100%);
  transition: transform 0.45s cubic-bezier(0.34,1.56,0.64,1);
  font-family: 'Syne', sans-serif; cursor: pointer;
}
.xz-entry-banner.show { transform: translateY(0); }
.xz-entry-banner.welcome {
  background: linear-gradient(135deg,#0a0a08,#100e00);
  border-bottom: 1px solid rgba(201,168,76,0.5);
  box-shadow: 0 4px 30px rgba(201,168,76,0.15);
}
.xz-entry-banner.goodbye {
  background: linear-gradient(135deg,#0a0a12,#12101a);
  border-bottom: 1px solid rgba(150,100,255,0.4);
  box-shadow: 0 4px 30px rgba(150,100,255,0.15);
}
.xz-banner-icon {
  width: 42px; height: 42px; border-radius: 50%;
  display: flex; align-items: center; justify-content: center; font-size: 20px; flex-shrink: 0;
  animation: xzIconPulse 2s ease infinite;
}
.welcome .xz-banner-icon { background: radial-gradient(circle,rgba(201,168,76,0.25) 0%,transparent 70%); border: 1px solid rgba(201,168,76,0.4); }
.goodbye .xz-banner-icon { background: radial-gradient(circle,rgba(150,100,255,0.25) 0%,transparent 70%); border: 1px solid rgba(150,100,255,0.4); }
@keyframes xzIconPulse {
  0%,100% { box-shadow: 0 0 0 0 rgba(201,168,76,0.3); }
  50% { box-shadow: 0 0 0 8px transparent; }
}
.goodbye .xz-banner-icon { animation-name: xzIconPulseP; }
@keyframes xzIconPulseP {
  0%,100% { box-shadow: 0 0 0 0 rgba(150,100,255,0.3); }
  50% { box-shadow: 0 0 0 8px transparent; }
}
.xz-banner-content { flex: 1; min-width: 0; }
.xz-banner-title { font-size: 11px; font-weight: 700; letter-spacing: 2px; text-transform: uppercase; margin-bottom: 2px; }
.welcome .xz-banner-title { color: #c9a84c; }
.goodbye .xz-banner-title { color: #a078ff; }
.xz-banner-text { font-size: 13px; color: #d0d0d0; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.xz-banner-tag { font-family: 'DM Mono', monospace; font-size: 10px; flex-shrink: 0; }
.welcome .xz-banner-tag { color: rgba(201,168,76,0.5); }
.goodbye .xz-banner-tag { color: rgba(150,100,255,0.5); }
.xz-banner-close { width: 26px; height: 26px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 50%; color: #888; cursor: pointer; font-size: 12px; display: flex; align-items: center; justify-content: center; flex-shrink: 0; transition: all 0.2s; }
.xz-banner-close:hover { color: #c9a84c; }

@media (max-width: 380px) {
  .factions-grid { grid-template-columns: 1fr 1fr; }
  .market-grid { grid-template-columns: 1fr 1fr; }
  .profile-stats { gap: 16px; }
  .compose-actions { gap: 6px; }
  .post-actions { gap: 10px; }
}
@media (max-width: 320px) {
  .topbar-section { display: none; }
  .market-grid { grid-template-columns: 1fr; }
}
</style>
</head>
<body>

<!-- WELCOME/GOODBYE BANNER -->
<div class="xz-entry-banner welcome" id="entryBanner">
  <div class="xz-banner-icon" id="bannerIcon">‚ö°</div>
  <div class="xz-banner-content">
    <div class="xz-banner-title" id="bannerTitle">X‚ÄîZONE</div>
    <div class="xz-banner-text" id="bannerText">Bienvenue dans la zone</div>
  </div>
  <div class="xz-banner-tag">X‚ÄîZONE</div>
  <button class="xz-banner-close" id="bannerClose">‚úï</button>
</div>

<!-- IMAGE VIEWER -->
<div class="img-viewer" id="imgViewer">
  <button class="img-viewer-close" onclick="closeImageViewer()">‚úï</button>
  <img id="imgViewerSrc" src="" alt="">
</div>

<!-- TOAST CONTAINER -->
<div class="toast-container" id="toastContainer"></div>

<!-- NOTIF PANEL -->
<div class="notif-panel" id="notifPanel">
  <div class="notif-header">Notifications</div>
  <div id="notifList"><div class="loading"><div class="spinner"></div></div></div>
</div>

<!-- INSTALL BANNER -->
<div class="install-banner hidden" id="installBanner">
  <div class="install-banner-text">
    <div class="install-banner-title">üì± Installer X-ZONE</div>
    <div class="install-banner-sub">Acc√®s instantan√©, fonctionne hors ligne</div>
  </div>
  <button class="install-btn" onclick="installPWA()">Installer</button>
  <button class="install-close" onclick="document.getElementById('installBanner').classList.add('hidden')">‚úï</button>
</div>

<!-- ===== AUTH PAGE ===== -->
<div id="auth-page" class="page active">
  <div class="auth-logo">
    <div class="logo-text">X‚ÄîZONE</div>
    <div class="tagline">// Espace Libre & Anonyme</div>
  </div>
  <div class="auth-card">
    <div class="auth-tabs">
      <button class="auth-tab active" onclick="switchAuthTab('login')">Connexion</button>
      <button class="auth-tab" onclick="switchAuthTab('register')">Cr√©er un compte</button>
    </div>
    <div class="auth-form active" id="loginForm">
      <div class="form-group">
        <label class="form-label">Pseudonyme</label>
        <input type="text" class="form-input" id="loginPseudo" placeholder="Votre pseudo..." autocomplete="username">
      </div>
      <div class="form-group">
        <label class="form-label">Mot de passe</label>
        <input type="password" class="form-input" id="loginPassword" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="current-password">
      </div>
      <button class="btn btn-gold" onclick="login()">Entrer dans la zone</button>
      <button class="fingerprint-btn" onclick="loginWithFingerprint()">
        <span class="fingerprint-icon">ü™™</span>
        Connexion par empreinte digitale
      </button>
    </div>
    <div class="auth-form" id="registerForm">
      <div class="form-group">
        <label class="form-label">Pr√©nom</label>
        <input type="text" class="form-input" id="regPrenom" placeholder="Votre pr√©nom..." autocomplete="given-name">
      </div>
      <div class="form-group">
        <label class="form-label">Nom</label>
        <input type="text" class="form-input" id="regNom" placeholder="Votre nom..." autocomplete="family-name">
      </div>
      <div class="form-group">
        <label class="form-label">Pseudonyme</label>
        <input type="text" class="form-input" id="regPseudo" placeholder="Choisissez un pseudo..." autocomplete="username">
      </div>
      <div class="form-group">
        <label class="form-label">Mot de passe</label>
        <input type="password" class="form-input" id="regPassword" placeholder="Minimum 6 caract√®res..." autocomplete="new-password">
      </div>
      <button class="btn btn-gold" onclick="register()">Rejoindre X-ZONE</button>
    </div>
  </div>
</div>

<!-- ===== APP PAGE ===== -->
<div id="app-page" class="page">
  <div class="topbar">
    <div class="topbar-logo">X</div>
    <div class="topbar-section" id="topbarSection">Le Flux</div>
    <div class="topbar-actions">
      <button class="icon-btn notif-dot" onclick="toggleNotif()" title="Notifications">üîî</button>
      <button class="icon-btn" onclick="toggleSearch()" title="Rechercher">üîç</button>
    </div>
  </div>

  <div class="content">
    <!-- FLUX -->
    <div class="section active" id="section-flux">
      <div class="filter-tabs">
        <button class="filter-tab active" onclick="setFilter('all',this)">üî• Tout</button>
        <button class="filter-tab" onclick="setFilter('top',this)">‚≠ê Top</button>
        <button class="filter-tab" onclick="setFilter('media',this)">üì∏ M√©dias</button>
        <button class="filter-tab" onclick="setFilter('latest',this)">üïê R√©cent</button>
      </div>
      <div class="compose-area">
        <div class="compose-inner">
          <div class="upload-preview" id="uploadPreview">
            <img id="uploadPreviewImg" src="" alt="">
            <button class="remove-upload" onclick="removeUpload()">‚úï</button>
          </div>
          <textarea class="compose-textarea" id="postText" placeholder="Exprimez-vous librement..."></textarea>
          <div class="compose-actions">
            <span class="compose-meta">ID: <span id="sessionId">‚Äî</span></span>
            <button class="mini-btn" onclick="document.getElementById('imageUploadInput').click()">üì∏</button>
            <button class="mini-btn" onclick="document.getElementById('videoUploadInput').click()">üé¨</button>
            <input type="file" id="imageUploadInput" accept="image/*" style="display:none" onchange="handleImageSelect(event)">
            <input type="file" id="videoUploadInput" accept="video/*" style="display:none" onchange="handleVideoSelect(event)">
            <button class="send-btn" onclick="submitPost()">Poster</button>
          </div>
        </div>
      </div>
      <div class="posts-feed" id="postsFeed">
        <div class="loading"><div class="spinner"></div>Chargement...</div>
      </div>
    </div>

    <!-- FACTIONS -->
    <div class="section" id="section-factions">
      <div class="faction-detail" id="factionDetail"></div>
      <div id="factionsMain">
        <div class="factions-header">
          <div class="section-title">Factions</div>
          <div class="search-bar">
            <input type="text" class="search-input" id="factionSearch" placeholder="#tag ou nom..." oninput="filterFactions(this.value)">
          </div>
        </div>
        <div class="factions-grid" id="factionsGrid">
          <div class="loading"><div class="spinner"></div></div>
        </div>
      </div>
    </div>

    <!-- MARKET -->
    <div class="section" id="section-market">
      <div class="market-header">
        <div class="section-title">Black Market</div>
        <button class="mini-btn" onclick="openModal('createListingModal')">+ Annonce</button>
      </div>
      <div class="filter-tabs">
        <button class="filter-tab active" onclick="setMarketFilter('all',this)">Tout</button>
        <button class="filter-tab" onclick="setMarketFilter('BTC',this)">‚Çø Bitcoin</button>
        <button class="filter-tab" onclick="setMarketFilter('XMR',this)">‚¨° Monero</button>
        <button class="filter-tab" onclick="setMarketFilter('verified',this)">‚úî V√©rifi√©s</button>
      </div>
      <div class="market-grid" id="marketGrid">
        <div class="loading" style="grid-column:1/-1"><div class="spinner"></div>Chargement...</div>
      </div>
    </div>

    <!-- PROFIL -->
    <div class="section" id="section-profil">
      <div class="profile-section">
        <div class="profile-avatar" id="profileAvatarDisplay">?</div>
        <div class="profile-name" id="profileNameDisplay">‚Äî</div>
        <div class="profile-pseudo" id="profilePseudoDisplay">@‚Äî</div>
        <div class="profile-id" id="profileIdDisplay">ID: ‚Äî</div>
        <div class="profile-stats">
          <div class="stat"><div class="stat-num" id="statPosts">0</div><div class="stat-label">Posts</div></div>
          <div class="stat"><div class="stat-num" id="statVotes">0</div><div class="stat-label">Votes</div></div>
          <div class="stat"><div class="stat-num" id="statFactions">0</div><div class="stat-label">Factions</div></div>
        </div>
      </div>
      <div class="profile-menu">
        <div class="menu-item" onclick="openModal('notifSettingsModal')"><span class="menu-item-icon">üîî</span>Notifications Push<span class="menu-item-arrow">‚Ä∫</span></div>
        <div class="menu-item" onclick="openModal('changePasswordModal')"><span class="menu-item-icon">üîê</span>Changer le mot de passe<span class="menu-item-arrow">‚Ä∫</span></div>
        <div class="menu-item" onclick="setupFingerprint()"><span class="menu-item-icon">ü™™</span>Configurer l'empreinte digitale<span class="menu-item-arrow">‚Ä∫</span></div>
        <div class="menu-item" onclick="openModal('aboutModal')"><span class="menu-item-icon">‚ÑπÔ∏è</span>√Ä propos de X-ZONE<span class="menu-item-arrow">‚Ä∫</span></div>
        <div class="menu-item danger" onclick="logout()"><span class="menu-item-icon">üö™</span>D√©connexion</div>
      </div>
    </div>

    <!-- MESSAGES -->
    <div class="section" id="section-msgs" style="flex-direction:column">
      <div class="msgs-tabs">
        <button class="msgs-tab active" id="tabInbox" onclick="switchMsgsTab('inbox')">üí¨ Inbox</button>
        <button class="msgs-tab" id="tabRoom" onclick="switchMsgsTab('room')">üåê Salon Anonyme</button>
      </div>
      <div id="inboxTab" style="flex:1;display:flex;flex-direction:column;overflow:hidden">
        <div style="padding:10px 16px 6px;display:flex;align-items:center;gap:10px">
          <input type="text" class="search-input" id="inboxSearch" placeholder="üîç  Rechercher un utilisateur..." oninput="filterInboxUsers(this.value)" style="flex:1;font-size:13px">
        </div>
        <div id="allUsersList" style="flex:1;overflow-y:auto">
          <div class="loading"><div class="spinner"></div>Chargement...</div>
        </div>
      </div>

      <!-- CHAT FULLSCREEN -->
      <div id="chatFullscreen" style="display:none;position:fixed;inset:0;background:var(--bg);z-index:500;flex-direction:column;">
        <div style="height:56px;background:rgba(8,8,8,0.97);backdrop-filter:blur(20px);border-bottom:1px solid var(--border);display:flex;align-items:center;padding:0 16px;gap:12px;flex-shrink:0;">
          <button onclick="closeChatFullscreen()" style="width:34px;height:34px;background:var(--bg3);border:1px solid var(--border);border-radius:50%;color:var(--text);font-size:18px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all 0.2s;flex-shrink:0;" onmouseover="this.style.borderColor='var(--gold)';this.style.color='var(--gold)'" onmouseout="this.style.borderColor='var(--border)';this.style.color='var(--text)'">‚úï</button>
          <div style="width:38px;height:38px;border-radius:50%;background:linear-gradient(135deg,var(--gold-dark),var(--bg3));border:1px solid var(--border-bright);display:flex;align-items:center;justify-content:center;font-family:var(--font-mono);font-size:13px;color:var(--gold);flex-shrink:0;" id="chatFsAvatar">?</div>
          <div style="flex:1;min-width:0">
            <div style="font-size:14px;font-weight:700;color:var(--text);white-space:nowrap;overflow:hidden;text-overflow:ellipsis" id="chatFsName">‚Äî</div>
            <div style="font-family:var(--font-mono);font-size:10px;color:var(--text-muted)" id="chatFsSub">‚Äî</div>
          </div>
        </div>
        <div id="chatFsMessages" style="flex:1;overflow-y:auto;padding:12px;display:flex;flex-direction:column;gap:8px;">
          <div class="loading"><div class="spinner"></div></div>
        </div>
        <div style="padding:10px 12px;border-top:1px solid var(--border);display:flex;align-items:flex-end;gap:8px;background:var(--bg2);flex-shrink:0;">
          <button class="chat-attach-btn" onclick="document.getElementById('chatFsImgInput').click()">üìé</button>
          <input type="file" id="chatFsImgInput" accept="image/*" style="display:none" onchange="sendFsImageMsg(event)">
          <textarea class="chat-input" id="chatFsInput" placeholder="Message..." rows="1" onkeydown="handleFsChatKey(event)" oninput="this.style.height='auto';this.style.height=this.scrollHeight+'px'"></textarea>
          <button class="chat-send-btn" onclick="sendFsMessage()">‚û§</button>
        </div>
      </div>

      <!-- SALON ANONYME -->
      <div id="roomTab" style="display:none;flex:1;flex-direction:column;overflow:hidden">
        <div class="anon-room-wrap">
          <div class="anon-room-header">
            <div>
              <div class="anon-room-title">üåê Salon Global</div>
              <div style="font-family:var(--font-mono);font-size:10px;color:var(--text-muted)">Tout le monde est <span style="color:var(--gold)">Anonyme</span></div>
            </div>
            <div class="room-online" id="roomOnlineCount">0 en ligne</div>
          </div>
          <div class="anon-room-messages" id="roomMessages">
            <div class="loading"><div class="spinner"></div></div>
          </div>
          <div class="anon-room-input">
            <textarea class="chat-input" id="roomInput" placeholder="Message anonyme..." rows="1" onkeydown="handleRoomKey(event)" oninput="this.style.height='auto';this.style.height=this.scrollHeight+'px'"></textarea>
            <button class="chat-send-btn" onclick="sendRoomMessage()">‚û§</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <nav class="bottom-nav">
    <button class="nav-item active" onclick="switchSection('flux',this)"><span class="nav-icon">‚ö°</span><span class="nav-label">Flux</span></button>
    <button class="nav-item" onclick="switchSection('factions',this)"><span class="nav-icon">üè¥</span><span class="nav-label">Factions</span></button>
    <button class="nav-item" onclick="switchSection('market',this)"><span class="nav-icon">üõí</span><span class="nav-label">Market</span></button>
    <button class="nav-item" onclick="switchSection('msgs',this)" style="position:relative"><span class="nav-icon">üí¨</span><span class="nav-label">Messages</span><span class="msg-badge" id="msgNavBadge">0</span></button>
    <button class="nav-item" onclick="switchSection('profil',this)"><span class="nav-icon">üë§</span><span class="nav-label">Profil</span></button>
  </nav>
</div>

<!-- ===== MODALS ===== -->
<div class="user-popup-overlay" id="userPopupOverlay" onclick="if(event.target===this)closeUserPopup()">
  <div class="user-popup">
    <div class="user-popup-avatar" id="popupAvatar">?</div>
    <div class="user-popup-name" id="popupName">‚Äî</div>
    <div class="user-popup-pseudo" id="popupPseudo">@‚Äî</div>
    <div class="user-popup-actions">
      <button class="popup-msg-btn" onclick="popupStartConv()">üí¨ Envoyer un message</button>
      <button class="popup-close-btn" onclick="closeUserPopup()">Fermer</button>
    </div>
  </div>
</div>

<div class="modal-overlay" id="createFactionModal">
  <div class="modal">
    <div class="modal-header"><span class="modal-title">Cr√©er une Faction</span><button class="modal-close" onclick="closeModal('createFactionModal')">‚úï</button></div>
    <div class="form-group"><label class="form-label">Nom de la faction</label><input type="text" class="form-input" id="factionName" placeholder="Ex: Crypto Cartel"></div>
    <div class="form-group"><label class="form-label">Emoji</label><input type="text" class="form-input" id="factionEmoji" placeholder="üè¥" maxlength="2"></div>
    <div class="form-group"><label class="form-label">Tags (s√©par√©s par des espaces)</label><input type="text" class="form-input" id="factionTags" placeholder="#crypto #trading #anon"></div>
    <div class="form-group"><label class="form-label">Description</label><textarea class="form-input" id="factionDesc" rows="3" placeholder="D√©crivez votre faction..." style="resize:vertical"></textarea></div>
    <button class="btn btn-gold" onclick="createFaction()">Cr√©er la Faction</button>
  </div>
</div>

<div class="modal-overlay" id="createListingModal">
  <div class="modal">
    <div class="modal-header"><span class="modal-title">Nouvelle Annonce</span><button class="modal-close" onclick="closeModal('createListingModal')">‚úï</button></div>
    <div class="form-group"><label class="form-label">Titre</label><input type="text" class="form-input" id="listingTitle" placeholder="Ce que vous vendez..."></div>
    <div class="form-group"><label class="form-label">Description</label><textarea class="form-input" id="listingDesc" rows="3" placeholder="D√©tails..." style="resize:vertical"></textarea></div>
    <div class="form-group"><label class="form-label">Prix</label><input type="text" class="form-input" id="listingPrice" placeholder="Ex: 0.001 BTC ou 5 XMR"></div>
    <div class="form-group"><label class="form-label">Crypto accept√©e</label><select class="form-input" id="listingCrypto" style="cursor:pointer"><option value="BTC">‚Çø Bitcoin (BTC)</option><option value="XMR">‚¨° Monero (XMR)</option></select></div>
    <div class="form-group"><label class="form-label">Adresse crypto</label><input type="text" class="form-input" id="listingAddress" placeholder="Votre adresse de r√©ception..."></div>
    <div class="form-group">
      <label class="form-label">Image (optionnel)</label>
      <button class="mini-btn" style="width:100%;padding:12px" onclick="document.getElementById('listingImgInput').click()">üì∏ Ajouter une image</button>
      <input type="file" id="listingImgInput" accept="image/*" style="display:none" onchange="handleListingImage(event)">
      <div id="listingImgPreview" style="display:none;margin-top:8px"><img id="listingImgPreviewImg" style="width:100%;border-radius:8px;max-height:160px;object-fit:cover"></div>
    </div>
    <button class="btn btn-gold" onclick="createListing()">Publier l'annonce</button>
  </div>
</div>

<div class="modal-overlay" id="notifSettingsModal">
  <div class="modal">
    <div class="modal-header"><span class="modal-title">Notifications</span><button class="modal-close" onclick="closeModal('notifSettingsModal')">‚úï</button></div>
    <p style="color:var(--text-muted);font-size:13px;margin-bottom:20px">Activez les notifications push pour √™tre alert√© des nouveaux posts et messages dans vos factions.</p>
    <button class="btn btn-gold" onclick="requestPushPermission()">Activer les notifications</button>
    <button class="btn btn-outline" onclick="disablePush()" style="margin-top:10px">D√©sactiver</button>
  </div>
</div>

<div class="modal-overlay" id="changePasswordModal">
  <div class="modal">
    <div class="modal-header"><span class="modal-title">Changer mot de passe</span><button class="modal-close" onclick="closeModal('changePasswordModal')">‚úï</button></div>
    <div class="form-group"><label class="form-label">Ancien mot de passe</label><input type="password" class="form-input" id="oldPassword" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"></div>
    <div class="form-group"><label class="form-label">Nouveau mot de passe</label><input type="password" class="form-input" id="newPassword" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"></div>
    <button class="btn btn-gold" onclick="changePassword()">Mettre √† jour</button>
  </div>
</div>

<div class="modal-overlay" id="aboutModal">
  <div class="modal">
    <div class="modal-header"><span class="modal-title">√Ä propos</span><button class="modal-close" onclick="closeModal('aboutModal')">‚úï</button></div>
    <p style="font-family:var(--font-display);font-size:32px;color:var(--gold);font-style:italic;margin-bottom:16px">X‚ÄîZONE</p>
    <p style="color:var(--text-muted);font-size:13px;line-height:1.7">Plateforme de communication libre et anonyme. Z√©ro log. Z√©ro censure. Powered by cryptographie et d√©centralisation.</p>
    <div style="margin-top:16px;font-family:var(--font-mono);font-size:11px;color:var(--border-bright)">v2.0.0 ‚Äî Build 2025<br>üîí AES-256 Encrypted<br>üåê PWA Ready<br>‚Çø Crypto Native</div>
  </div>
</div>

<div class="modal-overlay" id="listingDetailModal">
  <div class="modal">
    <div class="modal-header"><span class="modal-title" id="ldTitle">‚Äî</span><button class="modal-close" onclick="closeModal('listingDetailModal')">‚úï</button></div>
    <div id="ldImage" style="margin-bottom:16px;display:none"><img id="ldImg" style="width:100%;border-radius:10px;max-height:240px;object-fit:cover"></div>
    <p id="ldDesc" style="font-size:14px;color:var(--text-muted);margin-bottom:16px;line-height:1.6"></p>
    <div style="display:flex;align-items:center;gap:8px;margin-bottom:12px"><span style="font-family:var(--font-mono);font-size:18px;color:var(--gold)" id="ldPrice"></span><span class="listing-badge" id="ldCrypto"></span></div>
    <div style="font-family:var(--font-mono);font-size:12px;color:var(--text-muted);margin-bottom:6px">Adresse de paiement :</div>
    <div class="crypto-address" id="ldAddress" onclick="copyAddress()" title="Cliquer pour copier"></div>
    <div style="font-family:var(--font-mono);font-size:10px;color:var(--text-muted);margin-top:8px">üìã Cliquer pour copier l'adresse</div>
    <div style="font-family:var(--font-mono);font-size:10px;color:var(--border-bright);margin-top:8px" id="ldSeller"></div>
    <div style="display:flex;gap:8px;margin-top:16px" id="ldStars"></div>
  </div>
</div>

<!-- ===== SCRIPTS ===== -->
<script type="module">
import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js';
import { getFirestore, collection, doc, addDoc, getDoc, getDocs, setDoc, updateDoc, query, orderBy, limit, onSnapshot, serverTimestamp, where, increment } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js';

const firebaseConfig = {
  apiKey: "AIzaSyDHRxGdHpM2RFtvGMhXOu3slrT2JlmyNLM",
  authDomain: "data-fae4a.firebaseapp.com",
  databaseURL: "https://data-fae4a-default-rtdb.firebaseio.com",
  projectId: "data-fae4a",
  storageBucket: "data-fae4a.firebasestorage.app",
  messagingSenderId: "1077301559347",
  appId: "1:1077301559347:web:3405ab3bc8e1010d9e6346",
  measurementId: "G-C631QW9NDN"
};

const CLOUDINARY = { cloudName: 'djxcqczh1', uploadPreset: 'database' };
const VAPID_PUBLIC = 'BLCbphULBOAUvzpAvs3LjmotBJiuKc_grJmqVyxDX-z8HZo46tECs5kvJU8C9ORGUKBAQRUJesF1b96EuQ885aI';

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// ===== STATE =====
let currentUser = null;
let currentFilter = 'all';
let currentMarketFilter = 'all';
let uploadedImageUrl = null;
let uploadedVideoUrl = null;
let listingImageUrl = null;
let unsubPosts = null;
let deferredPrompt = null;
let videoObserver = null;
let globalMuted = true;
let currentConvId = null;
let currentPeerId = null;
let unsubMessages = null;
let allUsersCache = [];
let popupUserId = null;
let popupUserPseudo = null;
let unsubRoom = null;
const ROOM_ID = 'global_salon';

// ===== WELCOME / GOODBYE SYSTEM =====
const WELCOME_MESSAGES = [
  { icon: '‚ö°', title: 'Bienvenue dans la Zone', text: 'Content de te revoir. La zone t\'a attendu.' },
  { icon: 'üî•', title: 'Tu es de retour', text: 'X-ZONE s\'illumine √† ton arriv√©e. Entre.' },
  { icon: 'üè¥', title: 'La Zone t\'accueille', text: 'Tes factions t\'ont manqu√©. Sois le bienvenu.' },
  { icon: 'üåô', title: 'Dans l\'ombre, tu arrives', text: 'La zone ne dort jamais. Toi non plus.' },
  { icon: 'üîí', title: 'Connexion s√©curis√©e', text: 'Ton identit√© est prot√©g√©e. Tu peux parler librement.' },
  { icon: 'üëÅ', title: 'On t\'avait presque oubli√©', text: 'Mais la zone a une bonne m√©moire. Bienvenue.' },
];

const GOODBYE_MESSAGES = [
  { icon: 'üåë', title: 'Tu quittes la Zone', text: 'Reviens vite ‚Äî la zone ne sera pas la m√™me sans toi.' },
  { icon: 'üôè', title: 'Merci d\'√™tre pass√©', text: 'Ta pr√©sence a compt√©. √Ä tr√®s bient√¥t sur X-ZONE.' },
  { icon: 'üîê', title: 'Session termin√©e', text: 'Tes donn√©es restent chiffr√©es. Prends soin de toi.' },
  { icon: '‚ö°', title: 'La Zone se souvient', text: 'Tu pars, mais X-ZONE t\'attend. Reviens.' },
  { icon: 'üåô', title: 'Bonne nuit, membre', text: 'Repose-toi. La zone sera l√† √† ton r√©veil.' },
  { icon: 'üè¥', title: '√Ä bient√¥t, fr√®re', text: 'Ta faction a besoin de toi. Ne tarde pas trop.' },
];

let bannerTimeout = null;

function showEntryBanner(type) {
  const pool = type === 'welcome' ? WELCOME_MESSAGES : GOODBYE_MESSAGES;
  const msg = pool[Math.floor(Math.random() * pool.length)];
  const banner = document.getElementById('entryBanner');

  // Reset classes
  banner.className = `xz-entry-banner ${type}`;
  document.getElementById('bannerIcon').textContent = msg.icon;
  document.getElementById('bannerTitle').textContent = msg.title;
  document.getElementById('bannerText').textContent = msg.text;

  // Clear any existing timeout
  clearTimeout(bannerTimeout);

  // Trigger show
  requestAnimationFrame(() => {
    requestAnimationFrame(() => {
      banner.classList.add('show');
    });
  });

  // Auto-dismiss
  bannerTimeout = setTimeout(() => dismissEntryBanner(), type === 'welcome' ? 4500 : 3500);
}

function dismissEntryBanner() {
  const banner = document.getElementById('entryBanner');
  banner.classList.remove('show');
}

document.getElementById('bannerClose').addEventListener('click', dismissEntryBanner);
document.getElementById('entryBanner').addEventListener('click', e => {
  if (e.target !== document.getElementById('bannerClose')) dismissEntryBanner();
});

// Welcome/goodbye sounds using Web Audio API
function playWelcomeSound() {
  try {
    const ctx = new (window.AudioContext || window.webkitAudioContext)();
    const t = ctx.currentTime;
    [261, 329, 392, 523].forEach((freq, i) => {
      const osc = ctx.createOscillator();
      const gain = ctx.createGain();
      osc.type = 'sine';
      osc.frequency.value = freq;
      const s = t + i * 0.08;
      gain.gain.setValueAtTime(0, s);
      gain.gain.linearRampToValueAtTime(0.12, s + 0.05);
      gain.gain.exponentialRampToValueAtTime(0.001, s + 0.4);
      osc.connect(gain); gain.connect(ctx.destination);
      osc.start(s); osc.stop(s + 0.4);
    });
    setTimeout(() => ctx.close(), 1200);
  } catch(e) {}
}

function playGoodbyeSound() {
  try {
    const ctx = new (window.AudioContext || window.webkitAudioContext)();
    const t = ctx.currentTime;
    [523, 392, 329, 261].forEach((freq, i) => {
      const osc = ctx.createOscillator();
      const gain = ctx.createGain();
      osc.type = 'sine';
      osc.frequency.value = freq;
      const s = t + i * 0.1;
      gain.gain.setValueAtTime(0, s);
      gain.gain.linearRampToValueAtTime(0.1, s + 0.05);
      gain.gain.exponentialRampToValueAtTime(0.001, s + 0.5);
      osc.connect(gain); gain.connect(ctx.destination);
      osc.start(s); osc.stop(s + 0.5);
    });
    setTimeout(() => ctx.close(), 1500);
  } catch(e) {}
}

// Detect tab hide/show for goodbye/welcome
document.addEventListener('visibilitychange', () => {
  if (!currentUser) return;
  if (document.visibilityState === 'hidden') {
    showEntryBanner('goodbye');
    playGoodbyeSound();
    sessionStorage.setItem('xzone_last_exit', Date.now().toString());
  } else if (document.visibilityState === 'visible') {
    const lastExit = parseInt(sessionStorage.getItem('xzone_last_exit') || '0');
    if (Date.now() - lastExit > 60000) {
      setTimeout(() => { showEntryBanner('welcome'); playWelcomeSound(); }, 600);
    }
  }
});

window.addEventListener('pagehide', () => {
  if (currentUser) sessionStorage.setItem('xzone_last_exit', Date.now().toString());
});

// ===== NOTIFICATION SOUND ENGINE (X-ZONE signature) =====
function playXZoneNotifSound() {
  try {
    const ctx = new (window.AudioContext || window.webkitAudioContext)();
    const t = ctx.currentTime;
    // Layer 1: deep impact
    const o1 = ctx.createOscillator(), g1 = ctx.createGain();
    o1.type = 'sine'; o1.frequency.setValueAtTime(180, t); o1.frequency.exponentialRampToValueAtTime(90, t+0.15);
    g1.gain.setValueAtTime(0.4, t); g1.gain.exponentialRampToValueAtTime(0.001, t+0.3);
    o1.connect(g1); g1.connect(ctx.destination); o1.start(t); o1.stop(t+0.3);
    // Layer 2: alert beep
    const o2 = ctx.createOscillator(), g2 = ctx.createGain();
    o2.type = 'square'; o2.frequency.setValueAtTime(880, t+0.05); o2.frequency.setValueAtTime(1100, t+0.15); o2.frequency.setValueAtTime(880, t+0.25);
    g2.gain.setValueAtTime(0, t); g2.gain.setValueAtTime(0.15, t+0.05); g2.gain.exponentialRampToValueAtTime(0.001, t+0.4);
    o2.connect(g2); g2.connect(ctx.destination); o2.start(t+0.05); o2.stop(t+0.4);
    // Layer 3: golden shimmer
    const o3 = ctx.createOscillator(), g3 = ctx.createGain();
    o3.type = 'triangle'; o3.frequency.setValueAtTime(440, t+0.2); o3.frequency.exponentialRampToValueAtTime(660, t+0.45);
    g3.gain.setValueAtTime(0, t+0.2); g3.gain.setValueAtTime(0.2, t+0.25); g3.gain.exponentialRampToValueAtTime(0.001, t+0.6);
    o3.connect(g3); g3.connect(ctx.destination); o3.start(t+0.2); o3.stop(t+0.6);
    setTimeout(() => ctx.close(), 800);
  } catch(e) {}
}

// In-app notification banner (every 2h while app is open)
function checkInAppScheduledNotif() {
  const now = new Date();
  const h = now.getHours(), m = now.getMinutes(), s = now.getSeconds();
  if (h % 2 === 0 && m === 0 && s <= 30 && currentUser) {
    const key = h;
    const last = parseInt(sessionStorage.getItem('xzone_last_inapp_notif') || '-1');
    if (last !== key) {
      sessionStorage.setItem('xzone_last_inapp_notif', String(key));
      showScheduledToast(h);
      playXZoneNotifSound();
    }
  }
}

function showScheduledToast(hour) {
  const msgs = [
    '‚ö° Le Flux s\'embrase ‚Äî nouveaux posts en live',
    'üí¨ Des messages t\'attendent dans la zone',
    'üè¥ Tes factions sont actives en ce moment',
    'üõí Nouvelles annonces crypto sur le Market',
    'üåê Le Salon Anonyme est en feu',
  ];
  const text = hour === 22
    ? 'üåô 22h sur X-ZONE ‚Äî secrets et v√©rit√©s circulent'
    : msgs[Math.floor(Math.random() * msgs.length)];
  showToast(text, 'info');
}

setInterval(checkInAppScheduledNotif, 30000);

// SW message handler
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.addEventListener('message', e => {
    if (e.data?.type === 'PLAY_NOTIF_SOUND') playXZoneNotifSound();
    if (e.data?.type === 'NAVIGATE') {
      const url = new URL(e.data.url, location.origin);
      const section = url.searchParams.get('section');
      const tab = url.searchParams.get('tab');
      if (section && document.getElementById('section-' + section)) {
        const labels = { flux:'Flux', factions:'Factions', market:'Market', msgs:'Messages', profil:'Profil' };
        const btn = Array.from(document.querySelectorAll('.nav-item')).find(b => b.textContent.trim().includes(labels[section]||''));
        if (btn) switchSection(section, btn);
        if (section === 'msgs' && tab) setTimeout(() => switchMsgsTab(tab), 300);
      }
    }
  });
}

// SW keep-alive
setInterval(() => {
  if (navigator.serviceWorker.controller)
    navigator.serviceWorker.controller.postMessage({ type: 'PING' });
}, 20 * 60 * 1000);

// ===== UTILS =====
window.showToast = function(msg, type='info') {
  const c = document.getElementById('toastContainer');
  const t = document.createElement('div');
  t.className = `toast ${type}`;
  const icons = { success:'‚úÖ', error:'‚ùå', info:'‚ÑπÔ∏è' };
  t.innerHTML = `<span>${icons[type]||'‚ÑπÔ∏è'}</span><span>${msg}</span>`;
  c.appendChild(t);
  setTimeout(() => { t.style.animation = 'toastOut 0.3s ease forwards'; setTimeout(() => t.remove(), 300); }, 3000);
};

window.openModal = function(id) { document.getElementById(id).classList.add('active'); };
window.closeModal = function(id) { document.getElementById(id).classList.remove('active'); };
document.querySelectorAll('.modal-overlay').forEach(o => { o.addEventListener('click', e => { if (e.target === o) o.classList.remove('active'); }); });

function generateId() { return Math.random().toString(36).substring(2,9).toUpperCase(); }
function hashPassword(pwd) {
  let hash = 0;
  for (let i = 0; i < pwd.length; i++) { const c = pwd.charCodeAt(i); hash = ((hash<<5)-hash)+c; hash=hash&hash; }
  return Math.abs(hash).toString(16);
}
function timeAgo(ts) {
  if (!ts) return 'maintenant';
  const date = ts.toDate ? ts.toDate() : new Date(ts);
  const diff = (Date.now() - date.getTime()) / 1000;
  if (diff < 60) return '√† l\'instant';
  if (diff < 3600) return `il y a ${Math.floor(diff/60)}min`;
  if (diff < 86400) return `il y a ${Math.floor(diff/3600)}h`;
  return `il y a ${Math.floor(diff/86400)}j`;
}
function escapeHtml(text) {
  if (!text) return '';
  const map = {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'};
  return text.replace(/[&<>"']/g, m => map[m]);
}
function getAnonName(userId) { return `User-${(userId||'').substring(0,4).toUpperCase()}`; }
function getConvId(uid1, uid2) { return [uid1, uid2].sort().join('_'); }
function getRoomAnonName() {
  let name = sessionStorage.getItem('xzone_room_name');
  if (!name) {
    const adj = ['Shadow','Ghost','Phantom','Void','Cipher','Spectre','Echo','Wraith','Noir','Dark','Silent','Zero','Null','Flux'];
    const noun = ['Wolf','Fox','Crow','Mask','Blade','Storm','Node','Pulse','Wave','Fire','Ice','Dust','Wind','Byte'];
    name = `${adj[Math.floor(Math.random()*adj.length)]}${noun[Math.floor(Math.random()*noun.length)]}${Math.floor(Math.random()*99)}`;
    sessionStorage.setItem('xzone_room_name', name);
  }
  return name;
}

// ===== AUTH =====
window.switchAuthTab = function(tab) {
  document.querySelectorAll('.auth-tab').forEach((t,i) => t.classList.toggle('active', (i===0&&tab==='login')||(i===1&&tab==='register')));
  document.getElementById('loginForm').classList.toggle('active', tab==='login');
  document.getElementById('registerForm').classList.toggle('active', tab==='register');
};
document.getElementById('loginForm').classList.add('active');

window.register = async function() {
  const prenom = document.getElementById('regPrenom').value.trim();
  const nom = document.getElementById('regNom').value.trim();
  const pseudo = document.getElementById('regPseudo').value.trim();
  const password = document.getElementById('regPassword').value;
  if (!prenom||!nom||!pseudo||!password) return showToast('Tous les champs sont requis','error');
  if (password.length < 6) return showToast('Mot de passe trop court (min 6)','error');
  try {
    const snap = await getDocs(query(collection(db,'users'), where('pseudo','==',pseudo)));
    if (!snap.empty) return showToast('Ce pseudo est d√©j√† pris','error');
    const userId = generateId()+generateId();
    const userData = { prenom, nom, pseudo, passwordHash: hashPassword(password), userId, createdAt: serverTimestamp(), posts:0, votes:0, factions:0 };
    await setDoc(doc(db,'users',userId), userData);
    localStorage.setItem('xzone_user_id', userId);
    localStorage.setItem('xzone_pseudo', pseudo);
    await loginUser({ ...userData, id: userId });
    showToast(`Bienvenue dans X-ZONE, @${pseudo}!`,'success');
  } catch(e) { console.error(e); showToast('Erreur lors de la cr√©ation du compte','error'); }
};

window.login = async function() {
  const pseudo = document.getElementById('loginPseudo').value.trim();
  const password = document.getElementById('loginPassword').value;
  if (!pseudo||!password) return showToast('Remplissez tous les champs','error');
  try {
    const snap = await getDocs(query(collection(db,'users'), where('pseudo','==',pseudo)));
    if (snap.empty) return showToast('Pseudo introuvable','error');
    const userDoc = snap.docs[0];
    const userData = userDoc.data();
    if (userData.passwordHash !== hashPassword(password)) return showToast('Mot de passe incorrect','error');
    localStorage.setItem('xzone_user_id', userDoc.id);
    localStorage.setItem('xzone_pseudo', pseudo);
    await loginUser({ ...userData, id: userDoc.id });
    showToast(`Content de te revoir, @${pseudo}!`,'success');
  } catch(e) { console.error(e); showToast('Erreur de connexion','error'); }
};

window.loginWithFingerprint = async function() {
  const storedUserId = localStorage.getItem('xzone_user_id');
  if (!storedUserId) return showToast('Aucun compte enregistr√© sur cet appareil','error');
  if (!window.PublicKeyCredential) return showToast('Biom√©trie non support√©e sur ce navigateur','error');
  try {
    const storedCredId = localStorage.getItem('xzone_cred_id');
    if (!storedCredId) return showToast('Configurez d\'abord l\'empreinte dans votre profil','error');
    const credential = await navigator.credentials.get({ publicKey: { challenge: new Uint8Array(32), allowCredentials: [{ type:'public-key', id: Uint8Array.from(atob(storedCredId), c => c.charCodeAt(0)) }], userVerification:'required', timeout:60000 } });
    if (credential) {
      const snap = await getDoc(doc(db,'users',storedUserId));
      if (!snap.exists()) return showToast('Utilisateur introuvable','error');
      const userData = snap.data();
      await loginUser({ ...userData, id: storedUserId });
      showToast(`Connect√© via empreinte, @${userData.pseudo}!`,'success');
    }
  } catch(e) { console.error(e); showToast('√âchec de l\'authentification biom√©trique','error'); }
};

window.setupFingerprint = async function() {
  if (!window.PublicKeyCredential) return showToast('Biom√©trie non support√©e','error');
  if (!currentUser) return;
  try {
    const credential = await navigator.credentials.create({ publicKey: { challenge: new Uint8Array(32), rp: { name:'X-ZONE', id: location.hostname||'localhost' }, user: { id: new TextEncoder().encode(currentUser.id), name: currentUser.pseudo, displayName: `${currentUser.prenom} ${currentUser.nom}` }, pubKeyCredParams: [{ type:'public-key', alg:-7 }], authenticatorSelection: { userVerification:'required', authenticatorAttachment:'platform' }, timeout:60000 } });
    if (credential) { localStorage.setItem('xzone_cred_id', btoa(String.fromCharCode(...new Uint8Array(credential.rawId)))); showToast('Empreinte digitale configur√©e!','success'); }
  } catch(e) { console.error(e); showToast('Impossible de configurer la biom√©trie','error'); }
};

async function loginUser(userData) {
  currentUser = userData;
  const initial = (userData.prenom||'?')[0].toUpperCase();
  document.getElementById('profileAvatarDisplay').textContent = initial;
  document.getElementById('profileNameDisplay').textContent = `${userData.prenom} ${userData.nom}`;
  document.getElementById('profilePseudoDisplay').textContent = `@${userData.pseudo}`;
  document.getElementById('profileIdDisplay').textContent = `ID: ${userData.userId||userData.id}`;
  document.getElementById('sessionId').textContent = userData.pseudo;
  document.getElementById('statPosts').textContent = userData.posts||0;
  document.getElementById('statVotes').textContent = userData.votes||0;
  document.getElementById('statFactions').textContent = userData.factions||0;

  document.getElementById('auth-page').classList.remove('active');
  document.getElementById('app-page').classList.add('active');

  // üéâ MESSAGE DE BIENVENUE
  setTimeout(() => { showEntryBanner('welcome'); playWelcomeSound(); }, 700);

  loadPosts(); loadFactions(); loadMarket(); loadNotifications();
  await tryRegisterPush();
  watchUnreadCount();
}

window.logout = function() {
  // üëã MESSAGE D'AU REVOIR
  showEntryBanner('goodbye');
  playGoodbyeSound();

  setTimeout(() => {
    if (unsubPosts) unsubPosts();
    currentUser = null;
    localStorage.removeItem('xzone_user_id');
    document.getElementById('app-page').classList.remove('active');
    document.getElementById('auth-page').classList.add('active');
    showToast('√Ä bient√¥t sur X-ZONE üëã','info');
  }, 500);
};

async function autoLogin() {
  const savedId = localStorage.getItem('xzone_user_id');
  if (!savedId) return;
  try {
    const snap = await getDoc(doc(db,'users',savedId));
    if (snap.exists()) await loginUser({ ...snap.data(), id: savedId });
  } catch(e) { console.error(e); }
}

// ===== POSTS =====
window.submitPost = async function() {
  if (!currentUser) return;
  const text = document.getElementById('postText').value.trim();
  if (!text && !uploadedImageUrl && !uploadedVideoUrl) return showToast('√âcrivez quelque chose!','error');
  try {
    await addDoc(collection(db,'posts'), { text, imageUrl: uploadedImageUrl||null, videoUrl: uploadedVideoUrl||null, pseudo: currentUser.pseudo, userId: currentUser.id, score:0, upvotes:0, downvotes:0, createdAt: serverTimestamp() });
    document.getElementById('postText').value = '';
    removeUpload();
    await updateDoc(doc(db,'users',currentUser.id), { posts: increment(1) });
    document.getElementById('statPosts').textContent = parseInt(document.getElementById('statPosts').textContent)+1;
    showToast('Post publi√©!','success');
  } catch(e) { console.error(e); showToast('Erreur lors de la publication','error'); }
};

function loadPosts() {
  if (unsubPosts) unsubPosts();
  const q = query(collection(db,'posts'), orderBy('createdAt','desc'), limit(50));
  unsubPosts = onSnapshot(q, snap => {
    let posts = snap.docs.map(d => ({ id:d.id, ...d.data() }));
    if (currentFilter==='top') posts.sort((a,b) => (b.score||0)-(a.score||0));
    else if (currentFilter==='media') posts = posts.filter(p => p.imageUrl||p.videoUrl);
    renderPosts(posts);
  });
}

function renderPosts(posts) {
  const feed = document.getElementById('postsFeed');
  if (!posts.length) { feed.innerHTML = `<div class="empty-state"><div class="empty-icon">‚ö°</div><div class="empty-title">Aucun post</div><div class="empty-sub">Soyez le premier √† publier</div></div>`; return; }
  const userVotes = JSON.parse(localStorage.getItem('xzone_votes')||'{}');
  feed.innerHTML = posts.map(p => {
    const initial = (p.pseudo||'?')[0].toUpperCase();
    const myVote = userVotes[p.id];
    const isOwner = currentUser && p.userId === currentUser.id;
    const mediaHtml = p.videoUrl
      ? `<div class="post-video-wrap paused" id="vwrap-${p.id}" onclick="toggleVideo('${p.id}')"><video class="post-video" id="vid-${p.id}" src="${p.videoUrl}" loop playsinline preload="metadata" muted></video><div class="video-overlay"><div class="play-icon">‚ñ∂</div></div><div class="video-duration" id="vdur-${p.id}">0:00</div><button class="video-mute-btn" id="vmute-${p.id}" onclick="event.stopPropagation();toggleMute('${p.id}')">üîá</button><div class="video-progress" onclick="event.stopPropagation();seekVideo(event,'${p.id}')"><div class="video-progress-fill" id="vprog-${p.id}"></div></div></div>`
      : p.imageUrl ? `<img class="post-image" src="${p.imageUrl}" alt="" onclick="openImageViewer('${p.imageUrl}')">` : '';
    return `<div class="post-card" data-id="${p.id}">
      <div class="post-header">
        <div class="post-avatar" ${!isOwner?`style="cursor:pointer" onclick="openUserPopup('${p.userId}','${p.pseudo}')"`:''}>${initial}</div>
        <div class="post-meta">
          <div class="post-pseudo ${!isOwner?'post-pseudo-clickable':''}" ${!isOwner?`onclick="openUserPopup('${p.userId}','${p.pseudo}')"`:''}">@${p.pseudo||'anon'}</div>
          <div class="post-time">${timeAgo(p.createdAt)}</div>
        </div>
        ${isOwner?`<button class="delete-post-btn" onclick="deletePost('${p.id}')">üóë Supprimer</button>`:''}
      </div>
      ${p.text?`<div class="post-text">${escapeHtml(p.text)}</div>`:''}
      ${mediaHtml}
      <div class="post-actions">
        <button class="vote-btn ${myVote==='up'?'active-up':''}" onclick="vote('${p.id}','up')">‚ñ≤ <span>${p.upvotes||0}</span></button>
        <span class="post-score">${p.score||0}</span>
        <button class="vote-btn ${myVote==='down'?'active-down':''}" onclick="vote('${p.id}','down')">‚ñº <span>${p.downvotes||0}</span></button>
        <button class="vote-btn" style="margin-left:auto" onclick="sharePost('${p.id}')">‚Üó</button>
      </div>
    </div>`;
  }).join('');
  initVideoObserver();
  posts.filter(p=>p.videoUrl).forEach(p=>bindVideoEvents(p.id));
}

window.vote = async function(postId, type) {
  const votes = JSON.parse(localStorage.getItem('xzone_votes')||'{}');
  if (votes[postId]===type) return;
  const delta = type==='up'?1:-1;
  const prevDelta = votes[postId]?(votes[postId]==='up'?-1:1):0;
  votes[postId] = type;
  localStorage.setItem('xzone_votes', JSON.stringify(votes));
  try {
    const updates = { score: increment(delta+prevDelta) };
    if (type==='up') updates.upvotes = increment(1); else updates.downvotes = increment(1);
    if (prevDelta) { if (type==='up') updates.downvotes=increment(-1); else updates.upvotes=increment(-1); }
    await updateDoc(doc(db,'posts',postId), updates);
  } catch(e) { console.error(e); }
};

window.sharePost = function(postId) {
  if (navigator.share) navigator.share({ title:'X-ZONE', text:'Regarde ce post!', url: window.location.href });
  else { navigator.clipboard.writeText(window.location.href+'?post='+postId); showToast('Lien copi√©!','success'); }
};

window.setFilter = function(filter, el) {
  currentFilter = filter;
  document.querySelectorAll('#section-flux .filter-tab').forEach(t=>t.classList.remove('active'));
  el.classList.add('active'); loadPosts();
};

window.deletePost = async function(postId) {
  if (!currentUser||!confirm('Supprimer ce post d√©finitivement?')) return;
  try {
    const { deleteDoc } = await import('https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js');
    await deleteDoc(doc(db,'posts',postId));
    const card = document.querySelector(`.post-card[data-id="${postId}"]`);
    if (card) { card.style.animation='slideOut 0.3s ease forwards'; setTimeout(()=>card.remove(),300); }
    showToast('Post supprim√©','success');
    await updateDoc(doc(db,'users',currentUser.id), { posts: increment(-1) });
    const el = document.getElementById('statPosts');
    if (el) el.textContent = Math.max(0, parseInt(el.textContent)-1);
  } catch(e) { console.error(e); showToast('Erreur suppression','error'); }
};

// ===== UPLOAD =====
window.handleImageSelect = async function(e) {
  const file = e.target.files[0]; if (!file) return;
  showToast('Upload en cours...','info');
  try { uploadedImageUrl = await uploadToCloudinary(file); document.getElementById('uploadPreviewImg').src=uploadedImageUrl; document.getElementById('uploadPreview').classList.add('active'); showToast('Image upload√©e!','success'); }
  catch(err) { showToast('Erreur upload image','error'); }
};

window.removeUpload = function() {
  uploadedImageUrl=null; uploadedVideoUrl=null;
  document.getElementById('uploadPreview').classList.remove('active');
  document.getElementById('uploadPreviewImg').src='';
  document.getElementById('imageUploadInput').value='';
  document.getElementById('videoUploadInput').value='';
};

async function uploadToCloudinary(file) {
  const fd = new FormData();
  fd.append('file', file); fd.append('upload_preset', CLOUDINARY.uploadPreset);
  const res = await fetch(`https://api.cloudinary.com/v1_1/${CLOUDINARY.cloudName}/image/upload`, { method:'POST', body:fd });
  const data = await res.json();
  if (!data.secure_url) throw new Error('Upload failed');
  return data.secure_url;
}

window.handleListingImage = async function(e) {
  const file = e.target.files[0]; if (!file) return;
  try { listingImageUrl = await uploadToCloudinary(file); document.getElementById('listingImgPreviewImg').src=listingImageUrl; document.getElementById('listingImgPreview').style.display='block'; }
  catch(e) { showToast('Erreur upload','error'); }
};

window.handleVideoSelect = async function(e) {
  const file = e.target.files[0]; if (!file) return;
  if (file.size > 100*1024*1024) return showToast('Vid√©o trop lourde (max 100MB)','error');
  showToast('Upload vid√©o en cours...','info');
  try {
    const fd = new FormData(); fd.append('file',file); fd.append('upload_preset',CLOUDINARY.uploadPreset); fd.append('resource_type','video');
    const res = await fetch(`https://api.cloudinary.com/v1_1/${CLOUDINARY.cloudName}/video/upload`, { method:'POST', body:fd });
    const data = await res.json();
    if (!data.secure_url) throw new Error('Upload failed');
    uploadedVideoUrl = data.secure_url; uploadedImageUrl=null;
    document.getElementById('uploadPreviewImg').src = data.secure_url.replace('/upload/','/upload/so_0,f_jpg/');
    document.getElementById('uploadPreview').classList.add('active');
    showToast('Vid√©o upload√©e!','success');
  } catch(err) { console.error(err); showToast('Erreur upload vid√©o','error'); }
};

// ===== VIDEO PLAYER =====
function initVideoObserver() {
  if (videoObserver) videoObserver.disconnect();
  videoObserver = new IntersectionObserver(entries => {
    entries.forEach(entry => {
      const wrap = entry.target, vid = wrap.querySelector('video');
      if (!vid) return;
      if (entry.intersectionRatio >= 0.6) { vid.muted=globalMuted; vid.play().then(()=>{ wrap.classList.remove('paused'); updateMuteButtons(); }).catch(()=>{}); }
      else { vid.pause(); wrap.classList.add('paused'); }
    });
  }, { threshold:[0,0.3,0.6,1.0] });
  document.querySelectorAll('.post-video-wrap').forEach(w=>videoObserver.observe(w));
}

function bindVideoEvents(postId) {
  const vid = document.getElementById('vid-'+postId); if (!vid) return;
  vid.dataset.id = postId;
  vid.addEventListener('timeupdate', ()=>{
    if (!vid.duration) return;
    const p = document.getElementById('vprog-'+postId); if (p) p.style.width = (vid.currentTime/vid.duration*100)+'%';
    const d = document.getElementById('vdur-'+postId); if (d) { const r=vid.duration-vid.currentTime; d.textContent=`-${Math.floor(r/60)}:${Math.floor(r%60).toString().padStart(2,'0')}`; }
  });
  vid.addEventListener('ended', ()=>{ vid.currentTime=0; vid.play(); });
}

function updateMuteButtons() { document.querySelectorAll('[id^="vmute-"]').forEach(b=>{ b.textContent=globalMuted?'üîá':'üîä'; }); }

window.toggleVideo = function(postId) {
  const vid=document.getElementById('vid-'+postId), wrap=document.getElementById('vwrap-'+postId);
  if (!vid||!wrap) return;
  if (vid.paused) { vid.muted=globalMuted; vid.play(); wrap.classList.remove('paused'); }
  else { vid.pause(); wrap.classList.add('paused'); }
};

window.toggleMute = function(postId) {
  globalMuted=!globalMuted;
  document.querySelectorAll('.post-video').forEach(v=>{ v.muted=globalMuted; });
  updateMuteButtons();
};

window.seekVideo = function(e, postId) {
  const vid=document.getElementById('vid-'+postId), bar=e.currentTarget;
  if (!vid||!vid.duration) return;
  const rect=bar.getBoundingClientRect();
  vid.currentTime = ((e.clientX-rect.left)/rect.width)*vid.duration;
};

// ===== IMAGE VIEWER =====
window.openImageViewer = function(url) { document.getElementById('imgViewerSrc').src=url; document.getElementById('imgViewer').classList.add('active'); };
window.closeImageViewer = function() { document.getElementById('imgViewer').classList.remove('active'); };

// ===== FACTIONS =====
async function loadFactions() {
  try {
    const snap = await getDocs(collection(db,'factions'));
    renderFactions(snap.docs.map(d=>({ id:d.id, ...d.data() })));
  } catch(e) { console.error(e); }
}

function renderFactions(factions) {
  document.getElementById('factionsGrid').innerHTML = `
    <button class="create-faction-btn" onclick="openModal('createFactionModal')"><span style="font-size:24px">+</span><span>Cr√©er une Faction</span></button>
    ${factions.map(f=>`<div class="faction-card" onclick="openFaction('${f.id}')"><div class="faction-emoji">${f.emoji||'üè¥'}</div><div class="faction-name">${escapeHtml(f.name||'')}</div><div class="faction-tag">${(f.tags||'').split(' ').slice(0,2).map(t=>`<span class="tag">${t}</span>`).join('')}</div><div class="faction-members">üë• ${f.members||1} membres</div></div>`).join('')}`;
}

window.filterFactions = function(q) {
  const ql=q.toLowerCase();
  document.querySelectorAll('.faction-card:not(.create-faction-btn)').forEach(c=>{ c.style.display=c.textContent.toLowerCase().includes(ql)?'':'none'; });
};

window.openFaction = async function(factionId) {
  try {
    const snap=await getDoc(doc(db,'factions',factionId)); if (!snap.exists()) return;
    const f=snap.data();
    const postsSnap=await getDocs(query(collection(db,'factions',factionId,'posts'), orderBy('createdAt','desc'), limit(30)));
    const posts=postsSnap.docs.map(d=>({ id:d.id, ...d.data() }));
    const detail=document.getElementById('factionDetail');
    detail.innerHTML=`<div class="faction-detail-header"><button class="back-btn" onclick="closeFaction()">‚Üê Retour</button><div style="display:flex;align-items:center;gap:12px"><span style="font-size:36px">${f.emoji||'üè¥'}</span><div><div style="font-size:18px;font-weight:700">${escapeHtml(f.name)}</div><div style="font-size:12px;color:var(--text-muted)">${f.tags||''}</div></div></div><p style="font-size:13px;color:var(--text-muted);margin-top:10px;line-height:1.5">${escapeHtml(f.description||'')}</p></div>
    <div class="compose-area"><div class="compose-inner"><textarea class="compose-textarea" id="factionPostText" placeholder="Poster dans cette faction..."></textarea><div class="compose-actions"><button class="send-btn" onclick="submitFactionPost('${factionId}')">Poster</button></div></div></div>
    <div class="posts-feed" id="factionPostsFeed">${posts.length?posts.map(p=>`<div class="post-card"><div class="post-header"><div class="post-avatar">${(p.pseudo||'?')[0].toUpperCase()}</div><div class="post-meta"><div class="post-pseudo">@${p.pseudo||'anon'}</div><div class="post-time">${timeAgo(p.createdAt)}</div></div></div>${p.text?`<div class="post-text">${escapeHtml(p.text)}</div>`:''}</div>`).join(''):'<div class="empty-state"><div class="empty-icon">üè¥</div><div class="empty-title">Aucun post</div></div>'}</div>`;
    detail.classList.add('active');
    document.getElementById('factionsMain').style.display='none';
  } catch(e) { console.error(e); }
};

window.closeFaction = function() { document.getElementById('factionDetail').classList.remove('active'); document.getElementById('factionsMain').style.display=''; };

window.submitFactionPost = async function(factionId) {
  const text=document.getElementById('factionPostText').value.trim(); if (!text) return;
  try { await addDoc(collection(db,'factions',factionId,'posts'), { text, pseudo:currentUser.pseudo, userId:currentUser.id, createdAt:serverTimestamp() }); document.getElementById('factionPostText').value=''; openFaction(factionId); showToast('Post√©!','success'); }
  catch(e) { showToast('Erreur','error'); }
};

window.createFaction = async function() {
  const name=document.getElementById('factionName').value.trim();
  const emoji=document.getElementById('factionEmoji').value||'üè¥';
  const tags=document.getElementById('factionTags').value.trim();
  const description=document.getElementById('factionDesc').value.trim();
  if (!name) return showToast('Nom requis','error');
  try {
    await addDoc(collection(db,'factions'), { name, emoji, tags, description, ownerId:currentUser.id, ownerPseudo:currentUser.pseudo, members:1, createdAt:serverTimestamp() });
    closeModal('createFactionModal'); loadFactions(); showToast(`Faction "${name}" cr√©√©e!`,'success');
    ['factionName','factionEmoji','factionTags','factionDesc'].forEach(id=>document.getElementById(id).value='');
  } catch(e) { console.error(e); showToast('Erreur cr√©ation faction','error'); }
};

// ===== MARKET =====
async function loadMarket() {
  try {
    const snap=await getDocs(query(collection(db,'listings'), orderBy('createdAt','desc'), limit(40)));
    let listings=snap.docs.map(d=>({ id:d.id, ...d.data() }));
    if (currentMarketFilter!=='all') { if (currentMarketFilter==='verified') listings=listings.filter(l=>l.verified); else listings=listings.filter(l=>l.crypto===currentMarketFilter); }
    renderMarket(listings);
  } catch(e) { console.error(e); }
}

function renderMarket(listings) {
  const grid=document.getElementById('marketGrid');
  if (!listings.length) { grid.innerHTML=`<div class="empty-state" style="grid-column:1/-1"><div class="empty-icon">üõí</div><div class="empty-title">Aucune annonce</div><div class="empty-sub">Soyez le premier √† vendre</div></div>`; return; }
  grid.innerHTML=listings.map(l=>`<div class="listing-card" onclick="openListing(${JSON.stringify(l).replace(/"/g,'&quot;')})"><div class="listing-img">${l.imageUrl?`<img src="${l.imageUrl}" alt="">`:'üè∑Ô∏è'}</div><div class="listing-body"><div class="listing-title">${escapeHtml(l.title||'')}</div><div class="listing-price">${l.crypto==='BTC'?'‚Çø':'‚¨°'} ${escapeHtml(l.price||'')}</div>${l.verified?'<div class="listing-badge">‚úî V√âRIFI√â</div>':''}</div></div>`).join('');
}

window.openListing = function(listing) {
  document.getElementById('ldTitle').textContent=listing.title||'';
  document.getElementById('ldDesc').textContent=listing.description||'';
  document.getElementById('ldPrice').textContent=listing.price||'';
  document.getElementById('ldCrypto').textContent=listing.crypto||'';
  document.getElementById('ldAddress').textContent=listing.address||'‚Äî';
  document.getElementById('ldSeller').textContent=`Vendeur: @${listing.sellerPseudo||'anon'}`;
  document.getElementById('ldImage').style.display=listing.imageUrl?'block':'none';
  if (listing.imageUrl) document.getElementById('ldImg').src=listing.imageUrl;
  const stars=listing.rating||0;
  document.getElementById('ldStars').innerHTML=[1,2,3,4,5].map(i=>`<span style="font-size:20px;cursor:pointer;color:${i<=stars?'var(--gold)':'var(--border)'}" onclick="rateListing('${listing.id}',${i})">${i<=stars?'‚òÖ':'‚òÜ'}</span>`).join('');
  openModal('listingDetailModal');
};

window.rateListing = async function(id, stars) { try { await updateDoc(doc(db,'listings',id),{rating:stars}); showToast(`Not√© ${stars}/5`,'success'); } catch(e){} };
window.copyAddress = function() { navigator.clipboard.writeText(document.getElementById('ldAddress').textContent).then(()=>showToast('Adresse copi√©e!','success')); };
window.setMarketFilter = function(filter, el) { currentMarketFilter=filter; document.querySelectorAll('#section-market .filter-tab').forEach(t=>t.classList.remove('active')); el.classList.add('active'); loadMarket(); };

window.createListing = async function() {
  const title=document.getElementById('listingTitle').value.trim();
  const desc=document.getElementById('listingDesc').value.trim();
  const price=document.getElementById('listingPrice').value.trim();
  const crypto=document.getElementById('listingCrypto').value;
  const address=document.getElementById('listingAddress').value.trim();
  if (!title||!price||!address) return showToast('Titre, prix et adresse requis','error');
  try {
    await addDoc(collection(db,'listings'), { title, description:desc, price, crypto, address, imageUrl:listingImageUrl||null, sellerId:currentUser.id, sellerPseudo:currentUser.pseudo, verified:false, rating:0, createdAt:serverTimestamp() });
    closeModal('createListingModal'); loadMarket(); showToast('Annonce publi√©e!','success');
    ['listingTitle','listingDesc','listingPrice','listingAddress'].forEach(id=>document.getElementById(id).value='');
    listingImageUrl=null; document.getElementById('listingImgPreview').style.display='none';
  } catch(e) { console.error(e); showToast('Erreur publication annonce','error'); }
};

// ===== NAVIGATION =====
window.switchSection = function(section, el) {
  document.querySelectorAll('.section').forEach(s=>s.classList.remove('active'));
  document.querySelectorAll('.nav-item').forEach(n=>n.classList.remove('active'));
  document.getElementById('section-'+section).classList.add('active');
  el.classList.add('active');
  const labels = { flux:'Le Flux', factions:'Factions', market:'Black Market', msgs:'Messages', profil:'Profil' };
  document.getElementById('topbarSection').textContent=labels[section]||'';
  if (section==='msgs') switchMsgsTab('inbox');
};

window.toggleSearch = function() { showToast('Utilisez la barre de recherche dans Factions','info'); };

// ===== NOTIFICATIONS =====
async function loadNotifications() {
  const list=document.getElementById('notifList');
  try {
    const snap=await getDocs(query(collection(db,'notifications'), where('userId','==',currentUser.id), orderBy('createdAt','desc'), limit(20)));
    const notifs=snap.docs.map(d=>({ id:d.id, ...d.data() }));
    if (!notifs.length) { list.innerHTML='<div class="loading" style="font-size:12px">Aucune notification</div>'; return; }
    list.innerHTML=notifs.map(n=>`<div class="notif-item ${n.read?'':'unread'}"><div>${escapeHtml(n.message||'')}</div><div class="notif-item-meta">${timeAgo(n.createdAt)}</div></div>`).join('');
  } catch(e) { list.innerHTML='<div class="loading" style="font-size:12px">Aucune notification</div>'; }
}

window.toggleNotif = function() {
  document.getElementById('notifPanel').classList.toggle('open');
  setTimeout(()=>{ document.addEventListener('click', function h(e) { if (!document.getElementById('notifPanel').contains(e.target)&&!e.target.closest('.icon-btn')) { document.getElementById('notifPanel').classList.remove('open'); document.removeEventListener('click',h); } }); }, 10);
};

// ===== PUSH NOTIFICATIONS =====
async function tryRegisterPush() {
  if (!('serviceWorker' in navigator)||!('PushManager' in window)) return;
  if (Notification.permission==='denied') return;
  if (Notification.permission==='granted') { await registerPushSubscription(); return; }
  if (!localStorage.getItem('xzone_push_asked')) {
    setTimeout(async()=>{
      const p=await Notification.requestPermission();
      localStorage.setItem('xzone_push_asked','1');
      if (p==='granted') { await registerPushSubscription(); showToast('üîî Notifications activ√©es!','success'); }
    }, 2500);
  }
}

window.requestPushPermission = async function() {
  if (!('serviceWorker' in navigator)||!('PushManager' in window)) return showToast('Notifications non support√©es','error');
  const p=await Notification.requestPermission();
  localStorage.setItem('xzone_push_asked','1');
  if (p==='granted') { await registerPushSubscription(); showToast('üîî Notifications activ√©es!','success'); closeModal('notifSettingsModal'); }
  else if (p==='denied') showToast('Permission refus√©e','error');
};

async function registerPushSubscription() {
  try {
    const reg=await navigator.serviceWorker.ready;
    const existing=await reg.pushManager.getSubscription();
    if (existing) await existing.unsubscribe();
    const sub=await reg.pushManager.subscribe({ userVisibleOnly:true, applicationServerKey:urlBase64ToUint8Array(VAPID_PUBLIC) });
    await setDoc(doc(db,'push_subscriptions',currentUser.id), { subscription:JSON.stringify(sub), endpoint:sub.endpoint, userId:currentUser.id, pseudo:currentUser.pseudo, updatedAt:serverTimestamp() });
  } catch(e) { console.error('Push registration failed:',e); }
}

window.disablePush = async function() {
  try { const reg=await navigator.serviceWorker.ready; const sub=await reg.pushManager.getSubscription(); if (sub) await sub.unsubscribe(); showToast('Notifications d√©sactiv√©es','info'); closeModal('notifSettingsModal'); }
  catch(e) { console.error(e); }
};

function urlBase64ToUint8Array(base64String) {
  const padding='='.repeat((4-base64String.length%4)%4);
  const base64=(base64String+padding).replace(/-/g,'+').replace(/_/g,'/');
  const rawData=window.atob(base64);
  const outputArray=new Uint8Array(rawData.length);
  for (let i=0;i<rawData.length;++i) outputArray[i]=rawData.charCodeAt(i);
  return outputArray;
}

window.changePassword = async function() {
  const oldPwd=document.getElementById('oldPassword').value, newPwd=document.getElementById('newPassword').value;
  if (!oldPwd||!newPwd) return showToast('Remplissez tous les champs','error');
  if (newPwd.length<6) return showToast('Nouveau mot de passe trop court','error');
  if (hashPassword(oldPwd)!==currentUser.passwordHash) return showToast('Ancien mot de passe incorrect','error');
  try { await updateDoc(doc(db,'users',currentUser.id),{passwordHash:hashPassword(newPwd)}); currentUser.passwordHash=hashPassword(newPwd); closeModal('changePasswordModal'); showToast('Mot de passe mis √† jour!','success'); document.getElementById('oldPassword').value=''; document.getElementById('newPassword').value=''; }
  catch(e) { showToast('Erreur','error'); }
};

// ===== PWA =====
window.addEventListener('beforeinstallprompt', e=>{ e.preventDefault(); deferredPrompt=e; setTimeout(()=>document.getElementById('installBanner').classList.remove('hidden'),3000); });
window.installPWA = function() { if (!deferredPrompt) return; deferredPrompt.prompt(); deferredPrompt.userChoice.then(r=>{ deferredPrompt=null; document.getElementById('installBanner').classList.add('hidden'); if (r.outcome==='accepted') showToast('X-ZONE install√©!','success'); }); };

// ===== SERVICE WORKER =====
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('sw.js').then(reg=>console.log('‚úÖ SW registered',reg.scope)).catch(e=>console.log('SW not found:',e));
}

// ===== KEYBOARD =====
document.addEventListener('keydown', e=>{
  if (e.key==='Escape') { document.querySelectorAll('.modal-overlay.active').forEach(m=>m.classList.remove('active')); document.getElementById('imgViewer').classList.remove('active'); document.getElementById('notifPanel').classList.remove('open'); }
  if (e.ctrlKey&&e.key==='Enter' && document.getElementById('section-flux').classList.contains('active')) submitPost();
});

// ===== MESSAGES =====
async function loadConversations() {
  const container=document.getElementById('allUsersList');
  container.innerHTML='<div class="loading"><div class="spinner"></div>Chargement...</div>';
  try {
    const usersSnap=await getDocs(collection(db,'users'));
    allUsersCache=usersSnap.docs.map(d=>({ id:d.id, ...d.data() })).filter(u=>u.id!==currentUser.id);
    const convsSnap=await getDocs(query(collection(db,'conversations'), where('participants','array-contains',currentUser.id)));
    const convsMap={};
    let totalUnread=0;
    convsSnap.docs.forEach(d=>{ const data=d.data(); const peerId=data.participants.find(p=>p!==currentUser.id); if (peerId) { convsMap[peerId]={ id:d.id, ...data }; totalUnread+=((data.unread&&data.unread[currentUser.id])||0); } });
    updateMsgBadge(totalUnread);
    renderUsersList(allUsersCache, convsMap);
  } catch(e) { console.error(e); container.innerHTML='<div class="empty-state"><div class="empty-icon">‚ö†Ô∏è</div><div class="empty-title">Erreur chargement</div></div>'; }
}

function renderUsersList(users, convsMap) {
  const container=document.getElementById('allUsersList');
  if (!users.length) { container.innerHTML='<div class="empty-state"><div class="empty-icon">üë•</div><div class="empty-title">Aucun utilisateur</div></div>'; return; }
  const withConv=users.filter(u=>convsMap[u.id]).sort((a,b)=>((convsMap[b.id]?.lastAt?.toMillis?.())||0)-((convsMap[a.id]?.lastAt?.toMillis?.())||0));
  const withoutConv=users.filter(u=>!convsMap[u.id]).sort((a,b)=>(a.pseudo||'').localeCompare(b.pseudo||''));
  let html='';
  if (withConv.length) { html+='<div class="user-section-label">Conversations r√©centes</div>'; html+=withConv.map(u=>renderUserItem(u,convsMap[u.id])).join(''); }
  if (withoutConv.length) { html+='<div class="user-section-label">Tous les membres</div>'; html+=withoutConv.map(u=>renderUserItem(u,null)).join(''); }
  container.innerHTML=html;
}

function renderUserItem(u, conv) {
  const initial=(u.pseudo||'?')[0].toUpperCase();
  const unread=(conv?.unread&&conv.unread[currentUser.id])||0;
  const preview=conv?.lastMsg?escapeHtml(conv.lastMsg.substring(0,35)+(conv.lastMsg.length>35?'‚Ä¶':'')):'<span style="color:var(--text-muted);font-style:italic">D√©marrer une conversation</span>';
  const convId=conv?conv.id:getConvId(currentUser.id,u.id);
  return `<div class="user-list-item" onclick="openChatFullscreen('${convId}','${u.id}','${escapeHtml(u.pseudo||'anon')}')"><div class="user-list-avatar">${initial}</div><div class="user-list-info"><div class="user-list-pseudo">@${escapeHtml(u.pseudo||'anon')}</div><div class="user-list-name">${preview}</div></div>${unread>0?`<div class="user-list-unread">${unread}</div>`:'<div class="user-list-arrow">‚Ä∫</div>'}</div>`;
}

window.filterInboxUsers = function(q) {
  const s=q.toLowerCase().trim();
  if (!s) { loadConversations(); return; }
  renderUsersList(allUsersCache.filter(u=>(u.pseudo||'').toLowerCase().includes(s)||(u.prenom||'').toLowerCase().includes(s)), {});
};

function updateMsgBadge(count) {
  const badge=document.getElementById('msgNavBadge'); if (!badge) return;
  if (count>0) { badge.textContent=count>99?'99+':count; badge.classList.add('show'); } else badge.classList.remove('show');
}

window.openChatFullscreen = async function(convId, peerId, pseudo) {
  currentConvId=convId; currentPeerId=peerId;
  const initial=(pseudo||'?')[0].toUpperCase();
  document.getElementById('chatFsAvatar').textContent=initial;
  document.getElementById('chatFsName').textContent='@'+(pseudo||'anon');
  document.getElementById('chatFsSub').textContent='Message priv√© ¬∑ chiffr√©';
  const fs=document.getElementById('chatFullscreen');
  fs.style.display='flex'; fs.style.transform='translateX(100%)'; fs.style.transition='transform 0.3s ease';
  requestAnimationFrame(()=>requestAnimationFrame(()=>{ fs.style.transform='translateX(0)'; }));
  try {
    await setDoc(doc(db,'conversations',convId), { participants:[currentUser.id,peerId], lastMsg:'', lastAt:serverTimestamp() }, { merge:true });
    const upd={}; upd[`unread.${currentUser.id}`]=0;
    await updateDoc(doc(db,'conversations',convId), upd);
  } catch(e) {}
  loadMessageFs(convId);
  setTimeout(()=>document.getElementById('chatFsInput').focus(), 400);
};

function loadMessageFs(convId) {
  if (unsubMessages) unsubMessages();
  document.getElementById('chatFsMessages').innerHTML='<div class="loading"><div class="spinner"></div></div>';
  unsubMessages=onSnapshot(query(collection(db,'conversations',convId,'messages'), orderBy('createdAt','asc'), limit(100)), snap=>{ renderFsMessages(snap.docs.map(d=>({ id:d.id, ...d.data() }))); });
}

function renderFsMessages(messages) {
  const container=document.getElementById('chatFsMessages');
  if (!messages.length) { container.innerHTML=`<div style="text-align:center;padding:60px 20px;flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center"><div style="font-size:48px;margin-bottom:16px">üîí</div><div style="font-family:var(--font-mono);font-size:12px;color:var(--text-muted);line-height:1.8">Conversation chiffr√©e<br><span style="color:var(--gold)">Soyez le premier √† √©crire</span></div></div>`; return; }
  let lastDate=null, html='';
  messages.forEach(m=>{
    const isMine=m.senderId===currentUser.id;
    const msgDate=m.createdAt?.toDate?.()??new Date();
    const dateStr=msgDate.toLocaleDateString('fr-FR',{weekday:'short',day:'numeric',month:'short'});
    const timeStr=msgDate.toLocaleTimeString('fr-FR',{hour:'2-digit',minute:'2-digit'});
    if (dateStr!==lastDate) { html+=`<div class="msg-date-sep">${dateStr}</div>`; lastDate=dateStr; }
    html+=`<div class="msg-bubble-wrap ${isMine?'mine':''}">
      ${!isMine?'<div class="msg-avatar-sm">U</div>':''}
      <div class="msg-bubble">
        ${m.imageUrl?`<img class="msg-image" src="${m.imageUrl}" onclick="openImageViewer('${m.imageUrl}')">`:''} 
        ${m.text?escapeHtml(m.text):''}
        <div class="msg-time">${timeStr}</div>
      </div>
      ${isMine?'<div class="msg-avatar-sm">U</div>':''}
    </div>`;
  });
  container.innerHTML=html; container.scrollTop=container.scrollHeight;
}

window.sendFsMessage = async function() {
  const input=document.getElementById('chatFsInput'), text=input.value.trim();
  if (!text||!currentConvId) return;
  input.value=''; input.style.height='auto';
  try {
    await addDoc(collection(db,'conversations',currentConvId,'messages'), { text, senderId:currentUser.id, createdAt:serverTimestamp() });
    const upd={ lastMsg:text, lastAt:serverTimestamp(), participants:[currentUser.id,currentPeerId] };
    upd[`unread.${currentPeerId}`]=increment(1); upd[`unread.${currentUser.id}`]=0;
    await setDoc(doc(db,'conversations',currentConvId), upd, { merge:true });
  } catch(e) { console.error(e); showToast('Erreur envoi','error'); }
};

window.sendFsImageMsg = async function(e) {
  const file=e.target.files[0]; if (!file||!currentConvId) return;
  showToast('Upload...','info');
  try {
    const url=await uploadToCloudinary(file);
    await addDoc(collection(db,'conversations',currentConvId,'messages'), { imageUrl:url, senderId:currentUser.id, createdAt:serverTimestamp() });
    const upd={ lastMsg:'üì∏ Image', lastAt:serverTimestamp() }; upd[`unread.${currentPeerId}`]=increment(1);
    await setDoc(doc(db,'conversations',currentConvId), upd, { merge:true });
    e.target.value=''; showToast('Image envoy√©e!','success');
  } catch(err) { showToast('Erreur upload','error'); }
};

window.handleFsChatKey = function(e) { if (e.key==='Enter'&&!e.shiftKey) { e.preventDefault(); sendFsMessage(); } };

window.closeChatFullscreen = function() {
  const fs=document.getElementById('chatFullscreen');
  fs.style.transform='translateX(100%)';
  setTimeout(()=>{ fs.style.display='none'; fs.style.transform=''; fs.style.transition=''; }, 300);
  if (unsubMessages) { unsubMessages(); unsubMessages=null; }
  currentConvId=null; currentPeerId=null;
  loadConversations();
};

function watchUnreadCount() {
  if (!currentUser) return;
  onSnapshot(query(collection(db,'conversations'), where('participants','array-contains',currentUser.id)), snap=>{
    updateMsgBadge(snap.docs.reduce((acc,d)=>{ const data=d.data(); return acc+((data.unread&&data.unread[currentUser.id])||0); }, 0));
  });
}

// ===== USER POPUP =====
window.openUserPopup = function(userId, pseudo) {
  if (!userId||userId===currentUser?.id) return;
  popupUserId=userId; popupUserPseudo=pseudo;
  document.getElementById('popupAvatar').textContent=(pseudo||'?')[0].toUpperCase();
  document.getElementById('popupName').textContent=pseudo||'Anonyme';
  document.getElementById('popupPseudo').textContent='@'+(pseudo||'anon');
  document.getElementById('userPopupOverlay').classList.add('active');
};
window.closeUserPopup = function() { document.getElementById('userPopupOverlay').classList.remove('active'); popupUserId=null; popupUserPseudo=null; };
window.popupStartConv = function() { if (!popupUserId) return; closeUserPopup(); openChatFullscreen(getConvId(currentUser.id,popupUserId), popupUserId, popupUserPseudo||'anon'); };

// ===== MSGS TAB =====
window.switchMsgsTab = function(tab) {
  document.getElementById('tabInbox').classList.toggle('active', tab==='inbox');
  document.getElementById('tabRoom').classList.toggle('active', tab==='room');
  document.getElementById('inboxTab').style.display=tab==='inbox'?'flex':'none';
  document.getElementById('roomTab').style.display=tab==='room'?'flex':'none';
  if (tab==='inbox') loadConversations();
  else loadRoomMessages();
};

// ===== ANON SALON =====
async function updateRoomPresence() {
  try { await setDoc(doc(db,'room_presence',currentUser.id), { roomName:getRoomAnonName(), lastSeen:serverTimestamp() }); }
  catch(e) {}
}

function loadRoomMessages() {
  if (unsubRoom) unsubRoom();
  document.getElementById('roomMessages').innerHTML='<div class="loading"><div class="spinner"></div></div>';
  updateRoomPresence();
  onSnapshot(collection(db,'room_presence'), snap=>{
    const twoMinsAgo=Date.now()-2*60*1000;
    const online=snap.docs.filter(d=>{ const ts=d.data().lastSeen?.toDate?.()?.getTime()||0; return ts>twoMinsAgo; }).length;
    const el=document.getElementById('roomOnlineCount'); if (el) el.textContent=online+' en ligne';
  });
  unsubRoom=onSnapshot(query(collection(db,'room_messages'), orderBy('createdAt','desc'), limit(80)), snap=>{
    renderRoomMessages(snap.docs.map(d=>({ id:d.id, ...d.data() })).reverse());
  });
}

function renderRoomMessages(msgs) {
  const container=document.getElementById('roomMessages');
  const myRoomName=getRoomAnonName();
  if (!msgs.length) { container.innerHTML=`<div style="text-align:center;padding:50px 20px"><div style="font-size:48px;margin-bottom:12px">üåê</div><div style="font-family:var(--font-mono);font-size:11px;color:var(--text-muted);line-height:1.8">Salon anonyme vide.<br>Votre identit√© est <span style="color:var(--gold)">${myRoomName}</span></div></div>`; return; }
  container.innerHTML=msgs.map(m=>{
    const isMine=m.senderId===currentUser.id;
    const msgDate=m.createdAt?.toDate?.()??new Date();
    const timeStr=msgDate.toLocaleTimeString('fr-FR',{hour:'2-digit',minute:'2-digit'});
    return `<div class="room-msg ${isMine?'mine':''}"><div class="room-avatar">${(m.anonName||'An').substring(0,2)}</div><div><div class="room-sender">${isMine?`Vous (${m.anonName||myRoomName})`:m.anonName||'Anonyme'}</div><div class="room-bubble">${m.text?escapeHtml(m.text):''}<div class="room-time">${timeStr}</div></div></div></div>`;
  }).join('');
  container.scrollTop=container.scrollHeight;
}

window.sendRoomMessage = async function() {
  const input=document.getElementById('roomInput'), text=input.value.trim(); if (!text) return;
  input.value=''; input.style.height='auto';
  updateRoomPresence();
  try { await addDoc(collection(db,'room_messages'), { text, senderId:currentUser.id, anonName:getRoomAnonName(), createdAt:serverTimestamp() }); }
  catch(e) { console.error(e); showToast('Erreur envoi','error'); }
};

window.handleRoomKey = function(e) { if (e.key==='Enter'&&!e.shiftKey) { e.preventDefault(); sendRoomMessage(); } };

// ===== INIT =====
autoLogin();
</script>
</body>
</html>
