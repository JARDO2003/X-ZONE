<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<meta name="theme-color" content="#0a0a0a">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black">
<title>X-ZONE</title>
<link rel="manifest" href="manifest.json">
<link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'><rect width='32' height='32' fill='%23080808'/><text x='50%25' y='56%25' dominant-baseline='middle' text-anchor='middle' fill='%23c9a84c' font-size='20' font-family='serif' font-style='italic'>X</text></svg>">
<link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 180 180'><rect width='180' height='180' fill='%23080808'/><text x='50%25' y='56%25' dominant-baseline='middle' text-anchor='middle' fill='%23c9a84c' font-size='110' font-family='serif' font-style='italic'>X</text></svg>">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800&family=Playfair+Display:ital,wght@0,700;1,400&family=DM+Mono:wght@300;400;500&display=swap" rel="stylesheet">

<style>
:root {
  --gold: #c9a84c;
  --gold-light: #f0d080;
  --gold-dark: #8a6820;
  --bg: #080808;
  --bg2: #0f0f0f;
  --bg3: #161616;
  --bg4: #1e1e1e;
  --border: rgba(201,168,76,0.15);
  --border-bright: rgba(201,168,76,0.4);
  --text: #e8e8e8;
  --text-muted: #888;
  --danger: #c0392b;
  --success: #27ae60;
  --font-ui: 'Syne', sans-serif;
  --font-display: 'Playfair Display', serif;
  --font-mono: 'DM Mono', monospace;
}

*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

html { font-size: 16px; }

body {
  background: var(--bg);
  color: var(--text);
  font-family: var(--font-ui);
  min-height: 100vh;
  overflow-x: hidden;
}

/* SCROLLBAR */
::-webkit-scrollbar { width: 4px; }
::-webkit-scrollbar-track { background: var(--bg2); }
::-webkit-scrollbar-thumb { background: var(--gold-dark); border-radius: 2px; }

/* BACKGROUND GRAIN */
body::before {
  content: '';
  position: fixed;
  inset: 0;
  background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)' opacity='0.04'/%3E%3C/svg%3E");
  pointer-events: none;
  z-index: 0;
  opacity: 0.5;
}

/* PAGES */
.page { display: none; min-height: 100vh; position: relative; z-index: 1; }
.page.active { display: flex; flex-direction: column; }

/* ===== AUTH PAGE ===== */
#auth-page {
  align-items: center;
  justify-content: center;
  padding: 20px;
  background: radial-gradient(ellipse at 50% 0%, rgba(201,168,76,0.08) 0%, transparent 60%);
}

.auth-logo {
  text-align: center;
  margin-bottom: 40px;
}

.auth-logo .logo-text {
  font-family: var(--font-display);
  font-size: clamp(3rem, 12vw, 5rem);
  color: var(--gold);
  letter-spacing: -2px;
  line-height: 1;
  text-shadow: 0 0 60px rgba(201,168,76,0.3);
}

.auth-logo .tagline {
  font-family: var(--font-mono);
  font-size: 11px;
  color: var(--text-muted);
  letter-spacing: 4px;
  text-transform: uppercase;
  margin-top: 8px;
}

.auth-card {
  background: var(--bg2);
  border: 1px solid var(--border);
  border-radius: 16px;
  padding: clamp(24px, 6vw, 40px);
  width: 100%;
  max-width: 420px;
  box-shadow: 0 40px 80px rgba(0,0,0,0.6), 0 0 0 1px rgba(201,168,76,0.05);
}

.auth-tabs {
  display: flex;
  gap: 4px;
  background: var(--bg3);
  border-radius: 10px;
  padding: 4px;
  margin-bottom: 28px;
}

.auth-tab {
  flex: 1;
  padding: 10px;
  border: none;
  background: transparent;
  color: var(--text-muted);
  font-family: var(--font-ui);
  font-size: 13px;
  font-weight: 600;
  cursor: pointer;
  border-radius: 7px;
  transition: all 0.2s;
}

.auth-tab.active {
  background: var(--gold);
  color: var(--bg);
}

.form-group { margin-bottom: 16px; }

.form-label {
  display: block;
  font-family: var(--font-mono);
  font-size: 11px;
  color: var(--gold);
  letter-spacing: 2px;
  text-transform: uppercase;
  margin-bottom: 8px;
}

.form-input {
  width: 100%;
  background: var(--bg3);
  border: 1px solid var(--border);
  color: var(--text);
  font-family: var(--font-ui);
  font-size: 14px;
  padding: 12px 16px;
  border-radius: 10px;
  outline: none;
  transition: border-color 0.2s;
}

.form-input:focus { border-color: var(--gold); }
.form-input::placeholder { color: var(--text-muted); }

.btn {
  width: 100%;
  padding: 14px;
  border: none;
  border-radius: 10px;
  font-family: var(--font-ui);
  font-size: 14px;
  font-weight: 700;
  cursor: pointer;
  transition: all 0.2s;
  letter-spacing: 1px;
  text-transform: uppercase;
}

.btn-gold {
  background: linear-gradient(135deg, var(--gold-dark), var(--gold), var(--gold-light));
  color: var(--bg);
}

.btn-gold:hover { transform: translateY(-1px); box-shadow: 0 8px 24px rgba(201,168,76,0.3); }
.btn-gold:active { transform: translateY(0); }

.btn-outline {
  background: transparent;
  border: 1px solid var(--border-bright);
  color: var(--gold);
  margin-top: 10px;
}

.btn-outline:hover { background: rgba(201,168,76,0.08); }

.btn-ghost {
  background: var(--bg3);
  color: var(--text);
  border: 1px solid var(--border);
}

.fingerprint-btn {
  width: 100%;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 10px;
  padding: 14px;
  background: var(--bg3);
  border: 1px dashed var(--border-bright);
  border-radius: 10px;
  color: var(--gold);
  font-family: var(--font-ui);
  font-size: 14px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s;
  margin-top: 16px;
}

.fingerprint-btn:hover { background: rgba(201,168,76,0.05); }

.fingerprint-icon {
  font-size: 22px;
  animation: pulse 2s infinite;
}

@keyframes pulse {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.5; }
}

.auth-form { display: none; }
.auth-form.active { display: block; }

/* ===== APP SHELL ===== */
#app-page {
  flex-direction: column;
  max-width: 100vw;
}

/* TOP BAR */
.topbar {
  position: fixed;
  top: 0; left: 0; right: 0;
  height: 56px;
  background: rgba(8,8,8,0.95);
  backdrop-filter: blur(20px);
  border-bottom: 1px solid var(--border);
  display: flex;
  align-items: center;
  padding: 0 16px;
  gap: 12px;
  z-index: 100;
}

.topbar-logo {
  font-family: var(--font-display);
  font-size: 22px;
  color: var(--gold);
  font-style: italic;
  flex-shrink: 0;
}

.topbar-section {
  flex: 1;
  font-family: var(--font-mono);
  font-size: 11px;
  color: var(--text-muted);
  text-transform: uppercase;
  letter-spacing: 2px;
  text-align: center;
}

.topbar-actions {
  display: flex;
  align-items: center;
  gap: 8px;
  flex-shrink: 0;
}

.icon-btn {
  width: 36px; height: 36px;
  background: var(--bg3);
  border: 1px solid var(--border);
  border-radius: 8px;
  color: var(--text-muted);
  cursor: pointer;
  display: flex; align-items: center; justify-content: center;
  font-size: 16px;
  transition: all 0.2s;
  flex-shrink: 0;
}

.icon-btn:hover { border-color: var(--gold); color: var(--gold); }

.notif-dot {
  position: relative;
}
.notif-dot::after {
  content: '';
  position: absolute;
  top: 6px; right: 6px;
  width: 7px; height: 7px;
  background: var(--gold);
  border-radius: 50%;
  border: 1px solid var(--bg);
}

/* BOTTOM NAV */
.bottom-nav {
  position: fixed;
  bottom: 0; left: 0; right: 0;
  height: 60px;
  background: rgba(8,8,8,0.98);
  backdrop-filter: blur(20px);
  border-top: 1px solid var(--border);
  display: flex;
  align-items: stretch;
  z-index: 100;
}

.nav-item {
  flex: 1;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  gap: 4px;
  cursor: pointer;
  transition: all 0.2s;
  padding: 8px 0;
  border: none;
  background: none;
  color: var(--text-muted);
  position: relative;
}

.nav-item.active {
  color: var(--gold);
}

.nav-item.active::before {
  content: '';
  position: absolute;
  top: 0; left: 30%; right: 30%;
  height: 2px;
  background: var(--gold);
  border-radius: 0 0 4px 4px;
}

.nav-icon { font-size: 20px; }
.nav-label { font-family: var(--font-mono); font-size: 9px; letter-spacing: 1px; text-transform: uppercase; }

/* CONTENT */
.content {
  margin-top: 56px;
  margin-bottom: 60px;
  flex: 1;
  overflow-y: auto;
}

/* SECTION */
.section { display: none; }
.section.active { display: block; }

/* ===== FLUX (GLOBAL STREAM) ===== */
.flux-header {
  padding: 16px;
  border-bottom: 1px solid var(--border);
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 12px;
}

.section-title {
  font-family: var(--font-display);
  font-size: clamp(18px, 5vw, 22px);
  color: var(--gold);
  font-style: italic;
}

.compose-area {
  padding: 16px;
  background: var(--bg2);
  border-bottom: 1px solid var(--border);
}

.compose-inner {
  background: var(--bg3);
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 12px;
}

.compose-textarea {
  width: 100%;
  background: transparent;
  border: none;
  color: var(--text);
  font-family: var(--font-ui);
  font-size: 14px;
  resize: none;
  outline: none;
  min-height: 60px;
  line-height: 1.5;
}

.compose-textarea::placeholder { color: var(--text-muted); }

.compose-actions {
  display: flex;
  align-items: center;
  gap: 8px;
  margin-top: 10px;
  border-top: 1px solid var(--border);
  padding-top: 10px;
  flex-wrap: wrap;
}

.compose-meta {
  font-family: var(--font-mono);
  font-size: 10px;
  color: var(--text-muted);
  flex: 1;
  min-width: 120px;
}

.compose-meta span { color: var(--gold); }

.mini-btn {
  padding: 8px 12px;
  background: var(--bg4);
  border: 1px solid var(--border);
  border-radius: 8px;
  color: var(--text-muted);
  font-size: 14px;
  cursor: pointer;
  transition: all 0.2s;
  white-space: nowrap;
}

.mini-btn:hover { border-color: var(--gold); color: var(--gold); }

.send-btn {
  padding: 8px 16px;
  background: var(--gold);
  border: none;
  border-radius: 8px;
  color: var(--bg);
  font-family: var(--font-ui);
  font-size: 12px;
  font-weight: 700;
  cursor: pointer;
  letter-spacing: 1px;
  text-transform: uppercase;
  transition: all 0.2s;
}

.send-btn:hover { background: var(--gold-light); }

.posts-feed { padding: 8px; }

/* POST CARD */
.post-card {
  background: var(--bg2);
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 14px;
  margin-bottom: 8px;
  transition: border-color 0.2s;
  animation: slideIn 0.3s ease;
}

@keyframes slideIn {
  from { opacity: 0; transform: translateY(-10px); }
  to { opacity: 1; transform: translateY(0); }
}

@keyframes slideOut {
  to { opacity: 0; transform: translateY(-10px) scale(0.98); max-height: 0; padding: 0; margin: 0; overflow: hidden; }
}

.post-card:hover { border-color: var(--border-bright); }

.post-header {
  display: flex;
  align-items: center;
  gap: 10px;
  margin-bottom: 10px;
}

.post-avatar {
  width: 34px; height: 34px;
  border-radius: 50%;
  background: linear-gradient(135deg, var(--gold-dark), var(--bg3));
  border: 1px solid var(--border-bright);
  display: flex; align-items: center; justify-content: center;
  font-family: var(--font-mono);
  font-size: 11px;
  color: var(--gold);
  flex-shrink: 0;
  font-weight: 500;
}

.post-meta { flex: 1; min-width: 0; }

.post-pseudo {
  font-size: 13px;
  font-weight: 700;
  color: var(--text);
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.post-time {
  font-family: var(--font-mono);
  font-size: 10px;
  color: var(--text-muted);
}

.post-text {
  font-size: 14px;
  line-height: 1.6;
  color: var(--text);
  word-break: break-word;
  margin-bottom: 10px;
}

.post-image {
  width: 100%;
  border-radius: 8px;
  max-height: 300px;
  object-fit: cover;
  margin-bottom: 10px;
  cursor: pointer;
}

/* VIDEO PLAYER TIKTOK STYLE */
.post-video-wrap {
  position: relative;
  width: 100%;
  border-radius: 10px;
  overflow: hidden;
  margin-bottom: 10px;
  background: #000;
  cursor: pointer;
}

.post-video {
  width: 100%;
  max-height: 480px;
  object-fit: cover;
  display: block;
  border-radius: 10px;
}

.video-overlay {
  position: absolute;
  inset: 0;
  display: flex;
  align-items: center;
  justify-content: center;
  background: rgba(0,0,0,0.2);
  opacity: 0;
  transition: opacity 0.25s;
  border-radius: 10px;
  pointer-events: none;
}

.post-video-wrap.paused .video-overlay { opacity: 1; }

.play-icon {
  width: 54px; height: 54px;
  background: rgba(0,0,0,0.6);
  border-radius: 50%;
  display: flex; align-items: center; justify-content: center;
  font-size: 22px;
  color: white;
  backdrop-filter: blur(4px);
  border: 2px solid rgba(255,255,255,0.3);
}

.video-mute-btn {
  position: absolute;
  bottom: 38px; right: 10px;
  width: 30px; height: 30px;
  background: rgba(0,0,0,0.6);
  border: 1px solid rgba(255,255,255,0.2);
  border-radius: 50%;
  color: white;
  font-size: 13px;
  cursor: pointer;
  display: flex; align-items: center; justify-content: center;
  backdrop-filter: blur(4px);
  z-index: 5;
  transition: background 0.2s;
}

.video-mute-btn:hover { background: rgba(201,168,76,0.7); }

.video-duration {
  position: absolute;
  bottom: 38px; left: 10px;
  font-family: var(--font-mono);
  font-size: 10px;
  color: white;
  background: rgba(0,0,0,0.5);
  padding: 2px 6px;
  border-radius: 4px;
  pointer-events: none;
}

.video-progress {
  position: absolute;
  bottom: 0; left: 0; right: 0;
  height: 4px;
  background: rgba(255,255,255,0.15);
  cursor: pointer;
  z-index: 5;
}

.video-progress-fill {
  height: 100%;
  background: linear-gradient(90deg, var(--gold-dark), var(--gold));
  width: 0%;
  pointer-events: none;
}

/* DELETE BUTTON */
.delete-post-btn {
  background: none;
  border: none;
  color: var(--text-muted);
  cursor: pointer;
  padding: 4px 8px;
  border-radius: 6px;
  transition: all 0.2s;
  display: flex; align-items: center; gap: 4px;
  font-family: var(--font-mono);
  font-size: 11px;
  margin-left: auto;
}

.delete-post-btn:hover { color: var(--danger); background: rgba(192,57,43,0.1); }

.post-actions {
  display: flex;
  align-items: center;
  gap: 16px;
}

.vote-btn {
  background: none;
  border: none;
  color: var(--text-muted);
  font-size: 13px;
  cursor: pointer;
  display: flex; align-items: center; gap: 5px;
  font-family: var(--font-mono);
  transition: color 0.2s;
  padding: 4px 0;
}

.vote-btn:hover { color: var(--gold); }
.vote-btn.active-up { color: #4ade80; }
.vote-btn.active-down { color: #f87171; }

.post-score {
  font-family: var(--font-mono);
  font-size: 12px;
  color: var(--gold);
  margin: 0 4px;
}

/* ===== FACTIONS ===== */
.factions-header {
  padding: 16px;
  border-bottom: 1px solid var(--border);
}

.search-bar {
  display: flex;
  gap: 8px;
  margin-top: 12px;
}

.search-input {
  flex: 1;
  background: var(--bg3);
  border: 1px solid var(--border);
  color: var(--text);
  font-family: var(--font-ui);
  font-size: 13px;
  padding: 10px 14px;
  border-radius: 10px;
  outline: none;
  transition: border-color 0.2s;
}

.search-input:focus { border-color: var(--gold); }
.search-input::placeholder { color: var(--text-muted); }

.factions-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(min(100%, 180px), 1fr));
  gap: 10px;
  padding: 16px;
}

.faction-card {
  background: var(--bg2);
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 16px;
  cursor: pointer;
  transition: all 0.2s;
  position: relative;
  overflow: hidden;
}

.faction-card::before {
  content: '';
  position: absolute;
  top: 0; left: 0; right: 0;
  height: 2px;
  background: linear-gradient(90deg, transparent, var(--gold), transparent);
  opacity: 0;
  transition: opacity 0.2s;
}

.faction-card:hover { border-color: var(--border-bright); transform: translateY(-2px); }
.faction-card:hover::before { opacity: 1; }

.faction-emoji { font-size: 28px; margin-bottom: 8px; }

.faction-name {
  font-size: 14px;
  font-weight: 700;
  color: var(--text);
  margin-bottom: 4px;
}

.faction-tag {
  font-family: var(--font-mono);
  font-size: 10px;
  color: var(--gold);
}

.faction-members {
  font-family: var(--font-mono);
  font-size: 10px;
  color: var(--text-muted);
  margin-top: 8px;
}

/* CREATE FACTION BTN */
.create-faction-btn {
  display: flex;
  align-items: center;
  justify-content: center;
  flex-direction: column;
  gap: 8px;
  background: transparent;
  border: 1px dashed var(--border-bright);
  border-radius: 12px;
  padding: 16px;
  cursor: pointer;
  transition: all 0.2s;
  color: var(--gold);
  font-family: var(--font-ui);
  font-size: 12px;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 1px;
}

.create-faction-btn:hover { background: rgba(201,168,76,0.05); }

/* ===== MARKET ===== */
.market-header {
  padding: 16px;
  border-bottom: 1px solid var(--border);
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 12px;
}

.market-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(min(100%, 160px), 1fr));
  gap: 10px;
  padding: 16px;
}

.listing-card {
  background: var(--bg2);
  border: 1px solid var(--border);
  border-radius: 12px;
  overflow: hidden;
  cursor: pointer;
  transition: all 0.2s;
}

.listing-card:hover { border-color: var(--border-bright); transform: translateY(-2px); }

.listing-img {
  width: 100%;
  aspect-ratio: 1;
  object-fit: cover;
  background: var(--bg3);
  display: flex; align-items: center; justify-content: center;
  font-size: 32px;
  color: var(--border);
}

.listing-img img { width: 100%; height: 100%; object-fit: cover; }

.listing-body { padding: 10px; }

.listing-title {
  font-size: 12px;
  font-weight: 700;
  color: var(--text);
  margin-bottom: 4px;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.listing-price {
  font-family: var(--font-mono);
  font-size: 12px;
  color: var(--gold);
  display: flex; align-items: center; gap: 4px;
}

.listing-badge {
  display: inline-block;
  padding: 2px 6px;
  background: rgba(201,168,76,0.15);
  border: 1px solid var(--border-bright);
  border-radius: 4px;
  font-family: var(--font-mono);
  font-size: 9px;
  color: var(--gold);
  margin-top: 5px;
}

/* ===== PROFIL ===== */
.profile-section {
  padding: 24px 16px 16px;
  display: flex;
  flex-direction: column;
  align-items: center;
  text-align: center;
  border-bottom: 1px solid var(--border);
}

.profile-avatar {
  width: 80px; height: 80px;
  border-radius: 50%;
  background: linear-gradient(135deg, var(--gold-dark) 0%, var(--bg3) 100%);
  border: 2px solid var(--gold);
  display: flex; align-items: center; justify-content: center;
  font-family: var(--font-display);
  font-size: 28px;
  color: var(--gold);
  margin-bottom: 12px;
  box-shadow: 0 0 30px rgba(201,168,76,0.2);
}

.profile-name {
  font-family: var(--font-display);
  font-size: 22px;
  color: var(--gold);
  font-style: italic;
}

.profile-pseudo {
  font-family: var(--font-mono);
  font-size: 12px;
  color: var(--text-muted);
  margin-top: 4px;
}

.profile-id {
  font-family: var(--font-mono);
  font-size: 10px;
  color: var(--border-bright);
  margin-top: 8px;
  padding: 4px 12px;
  background: var(--bg3);
  border-radius: 20px;
}

.profile-stats {
  display: flex;
  gap: 24px;
  margin-top: 16px;
}

.stat { text-align: center; }
.stat-num {
  font-family: var(--font-mono);
  font-size: 20px;
  color: var(--gold);
  font-weight: 500;
}
.stat-label {
  font-size: 11px;
  color: var(--text-muted);
  text-transform: uppercase;
  letter-spacing: 1px;
}

.profile-menu {
  padding: 16px;
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.menu-item {
  display: flex;
  align-items: center;
  gap: 14px;
  padding: 14px 16px;
  background: var(--bg2);
  border: 1px solid var(--border);
  border-radius: 12px;
  cursor: pointer;
  transition: all 0.2s;
  text-decoration: none;
  color: var(--text);
  font-size: 14px;
  font-weight: 600;
}

.menu-item:hover { border-color: var(--border-bright); }
.menu-item-icon { font-size: 18px; width: 24px; text-align: center; }
.menu-item-arrow { margin-left: auto; color: var(--text-muted); font-size: 12px; }

.menu-item.danger { color: var(--danger); border-color: rgba(192,57,43,0.2); }
.menu-item.danger:hover { border-color: rgba(192,57,43,0.5); background: rgba(192,57,43,0.05); }

/* ===== MODAL ===== */
.modal-overlay {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.85);
  backdrop-filter: blur(8px);
  z-index: 200;
  display: none;
  align-items: flex-end;
  justify-content: center;
  padding: 16px;
}

.modal-overlay.active {
  display: flex;
  animation: fadeIn 0.2s ease;
}

@keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

.modal {
  background: var(--bg2);
  border: 1px solid var(--border-bright);
  border-radius: 20px 20px 16px 16px;
  padding: 24px;
  width: 100%;
  max-width: 480px;
  max-height: 90vh;
  overflow-y: auto;
  animation: slideUp 0.3s ease;
}

@keyframes slideUp {
  from { transform: translateY(40px); opacity: 0; }
  to { transform: translateY(0); opacity: 1; }
}

.modal-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 20px;
}

.modal-title {
  font-family: var(--font-display);
  font-size: 20px;
  color: var(--gold);
  font-style: italic;
}

.modal-close {
  width: 32px; height: 32px;
  background: var(--bg3);
  border: 1px solid var(--border);
  border-radius: 8px;
  color: var(--text-muted);
  cursor: pointer;
  display: flex; align-items: center; justify-content: center;
  font-size: 16px;
  transition: all 0.2s;
}

.modal-close:hover { color: var(--gold); border-color: var(--gold); }

/* TOAST */
.toast-container {
  position: fixed;
  top: 70px;
  left: 50%;
  transform: translateX(-50%);
  z-index: 300;
  display: flex;
  flex-direction: column;
  gap: 8px;
  pointer-events: none;
  width: calc(100% - 32px);
  max-width: 360px;
}

.toast {
  background: var(--bg3);
  border: 1px solid var(--border-bright);
  border-radius: 10px;
  padding: 12px 16px;
  font-size: 13px;
  color: var(--text);
  display: flex;
  align-items: center;
  gap: 10px;
  animation: toastIn 0.3s ease forwards;
  box-shadow: 0 8px 24px rgba(0,0,0,0.4);
}

.toast.success { border-color: rgba(39,174,96,0.5); }
.toast.error { border-color: rgba(192,57,43,0.5); }

@keyframes toastIn {
  from { opacity: 0; transform: translateY(-16px); }
  to { opacity: 1; transform: translateY(0); }
}

@keyframes toastOut {
  to { opacity: 0; transform: translateY(-16px); }
}

/* UPLOAD PREVIEW */
.upload-preview {
  display: none;
  position: relative;
  margin-bottom: 10px;
}

.upload-preview img {
  width: 100%;
  max-height: 200px;
  object-fit: cover;
  border-radius: 8px;
}

.upload-preview.active { display: block; }

.remove-upload {
  position: absolute;
  top: 8px; right: 8px;
  width: 28px; height: 28px;
  background: rgba(0,0,0,0.7);
  border: 1px solid var(--border);
  border-radius: 50%;
  color: var(--text);
  cursor: pointer;
  display: flex; align-items: center; justify-content: center;
  font-size: 14px;
}

/* LOADING */
.loading {
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 40px;
  color: var(--text-muted);
  font-family: var(--font-mono);
  font-size: 12px;
  letter-spacing: 2px;
}

.spinner {
  width: 20px; height: 20px;
  border: 2px solid var(--border);
  border-top-color: var(--gold);
  border-radius: 50%;
  animation: spin 0.8s linear infinite;
  margin-right: 10px;
}

@keyframes spin { to { transform: rotate(360deg); } }

/* EMPTY STATE */
.empty-state {
  text-align: center;
  padding: 60px 20px;
  color: var(--text-muted);
}

.empty-icon { font-size: 48px; margin-bottom: 12px; opacity: 0.5; }
.empty-title { font-size: 16px; font-weight: 600; margin-bottom: 6px; }
.empty-sub { font-size: 13px; }

/* IMAGE VIEWER */
.img-viewer {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.95);
  z-index: 400;
  display: none;
  align-items: center;
  justify-content: center;
}

.img-viewer.active { display: flex; }
.img-viewer img { max-width: 100%; max-height: 100%; object-fit: contain; }
.img-viewer-close {
  position: absolute;
  top: 16px; right: 16px;
  font-size: 28px;
  color: white;
  cursor: pointer;
  background: none;
  border: none;
}

/* FACTION DETAIL */
.faction-detail {
  display: none;
}

.faction-detail.active {
  display: block;
}

.faction-detail-header {
  padding: 20px 16px 16px;
  border-bottom: 1px solid var(--border);
  background: linear-gradient(180deg, rgba(201,168,76,0.05) 0%, transparent 100%);
}

.back-btn {
  display: flex;
  align-items: center;
  gap: 8px;
  background: none;
  border: none;
  color: var(--text-muted);
  font-family: var(--font-ui);
  font-size: 13px;
  cursor: pointer;
  margin-bottom: 12px;
  padding: 0;
}

.back-btn:hover { color: var(--gold); }

/* MARKET MODAL */
.crypto-address {
  font-family: var(--font-mono);
  font-size: 11px;
  background: var(--bg3);
  border: 1px solid var(--border);
  padding: 10px 12px;
  border-radius: 8px;
  word-break: break-all;
  color: var(--gold);
  margin-top: 8px;
  cursor: pointer;
  transition: border-color 0.2s;
}

.crypto-address:hover { border-color: var(--gold); }

/* TAGS */
.tag {
  display: inline-block;
  padding: 3px 8px;
  background: rgba(201,168,76,0.1);
  border: 1px solid var(--border);
  border-radius: 20px;
  font-family: var(--font-mono);
  font-size: 10px;
  color: var(--gold);
  margin: 2px;
}

/* FILTER TABS */
.filter-tabs {
  display: flex;
  gap: 6px;
  padding: 12px 16px;
  border-bottom: 1px solid var(--border);
  overflow-x: auto;
  -webkit-overflow-scrolling: touch;
}

.filter-tab {
  padding: 6px 12px;
  background: var(--bg3);
  border: 1px solid var(--border);
  border-radius: 20px;
  color: var(--text-muted);
  font-family: var(--font-mono);
  font-size: 11px;
  cursor: pointer;
  white-space: nowrap;
  transition: all 0.2s;
  flex-shrink: 0;
}

.filter-tab.active {
  background: rgba(201,168,76,0.15);
  border-color: var(--gold);
  color: var(--gold);
}

/* PWA INSTALL BANNER */
.install-banner {
  position: fixed;
  bottom: 70px;
  left: 16px; right: 16px;
  background: var(--bg2);
  border: 1px solid var(--border-bright);
  border-radius: 12px;
  padding: 14px 16px;
  display: flex;
  align-items: center;
  gap: 12px;
  z-index: 99;
  box-shadow: 0 8px 32px rgba(0,0,0,0.4);
  animation: slideUp 0.3s ease;
}

.install-banner.hidden { display: none; }

.install-banner-text { flex: 1; font-size: 13px; }
.install-banner-title { font-weight: 700; color: var(--gold); font-size: 13px; }
.install-banner-sub { font-size: 11px; color: var(--text-muted); margin-top: 2px; }

.install-btn {
  padding: 8px 14px;
  background: var(--gold);
  border: none;
  border-radius: 8px;
  color: var(--bg);
  font-family: var(--font-ui);
  font-size: 12px;
  font-weight: 700;
  cursor: pointer;
  flex-shrink: 0;
}

.install-close {
  background: none;
  border: none;
  color: var(--text-muted);
  cursor: pointer;
  font-size: 18px;
  flex-shrink: 0;
}

/* NOTIF PANEL */
.notif-panel {
  position: fixed;
  top: 56px; right: 0;
  width: min(320px, 100vw);
  max-height: calc(100vh - 56px);
  background: var(--bg2);
  border-left: 1px solid var(--border);
  border-bottom: 1px solid var(--border);
  overflow-y: auto;
  z-index: 150;
  transform: translateX(100%);
  transition: transform 0.3s ease;
}

.notif-panel.open { transform: translateX(0); }

.notif-header {
  padding: 16px;
  border-bottom: 1px solid var(--border);
  font-family: var(--font-display);
  font-size: 18px;
  color: var(--gold);
  font-style: italic;
}

.notif-item {
  padding: 14px 16px;
  border-bottom: 1px solid var(--border);
  font-size: 13px;
  transition: background 0.2s;
}

.notif-item:hover { background: var(--bg3); }
.notif-item.unread { border-left: 2px solid var(--gold); }
.notif-item-meta { font-family: var(--font-mono); font-size: 10px; color: var(--text-muted); margin-top: 4px; }

@media (max-width: 380px) {
  .factions-grid { grid-template-columns: 1fr 1fr; }
  .market-grid { grid-template-columns: 1fr 1fr; }
  .profile-stats { gap: 16px; }
  .compose-actions { gap: 6px; }
  .post-actions { gap: 10px; }
}

@media (max-width: 320px) {
  .topbar-section { display: none; }
  .factions-grid { grid-template-columns: 1fr 1fr; }
  .market-grid { grid-template-columns: 1fr; }
}

/* ===== MESSAGING ===== */
.msg-badge {
  position: absolute;
  top: 4px; right: 4px;
  min-width: 16px; height: 16px;
  background: var(--gold);
  border-radius: 8px;
  font-family: var(--font-mono);
  font-size: 9px;
  color: var(--bg);
  display: flex; align-items: center; justify-content: center;
  font-weight: 700;
  padding: 0 3px;
  border: 1px solid var(--bg);
  display: none;
}
.msg-badge.show { display: flex; }

/* CONV LIST */
.conv-list { padding: 8px; }

.conv-item {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 12px 14px;
  background: var(--bg2);
  border: 1px solid var(--border);
  border-radius: 12px;
  margin-bottom: 8px;
  cursor: pointer;
  transition: all 0.2s;
  position: relative;
}

.conv-item:hover { border-color: var(--border-bright); }
.conv-item.unread { border-left: 3px solid var(--gold); }

.conv-avatar {
  width: 42px; height: 42px;
  border-radius: 50%;
  background: linear-gradient(135deg, var(--gold-dark), var(--bg3));
  border: 1px solid var(--border-bright);
  display: flex; align-items: center; justify-content: center;
  font-family: var(--font-mono);
  font-size: 14px;
  color: var(--gold);
  flex-shrink: 0;
  font-weight: 500;
}

.conv-info { flex: 1; min-width: 0; }

.conv-name {
  font-size: 13px;
  font-weight: 700;
  color: var(--text);
  display: flex;
  align-items: center;
  gap: 6px;
}

.conv-anon-tag {
  font-family: var(--font-mono);
  font-size: 9px;
  color: var(--gold-dark);
  background: rgba(201,168,76,0.1);
  padding: 1px 5px;
  border-radius: 4px;
  border: 1px solid var(--border);
}

.conv-preview {
  font-size: 12px;
  color: var(--text-muted);
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  margin-top: 2px;
}

.conv-time {
  font-family: var(--font-mono);
  font-size: 10px;
  color: var(--text-muted);
  flex-shrink: 0;
  align-self: flex-start;
}

/* CHAT VIEW */
.chat-view {
  display: none;
  flex-direction: column;
  height: calc(100vh - 116px);
}

.chat-view.active { display: flex; }

.chat-header {
  padding: 12px 16px;
  border-bottom: 1px solid var(--border);
  display: flex;
  align-items: center;
  gap: 12px;
  background: var(--bg2);
  flex-shrink: 0;
}

.chat-back {
  background: none;
  border: none;
  color: var(--text-muted);
  font-size: 20px;
  cursor: pointer;
  padding: 0;
  line-height: 1;
  transition: color 0.2s;
}

.chat-back:hover { color: var(--gold); }

.chat-user-info { flex: 1; min-width: 0; }

.chat-user-name {
  font-size: 14px;
  font-weight: 700;
  color: var(--text);
  display: flex;
  align-items: center;
  gap: 6px;
}

.chat-anon-label {
  font-family: var(--font-mono);
  font-size: 10px;
  color: var(--text-muted);
  margin-top: 1px;
}

.online-dot {
  width: 8px; height: 8px;
  border-radius: 50%;
  background: #4ade80;
  display: inline-block;
  flex-shrink: 0;
}

.chat-messages {
  flex: 1;
  overflow-y: auto;
  padding: 12px;
  display: flex;
  flex-direction: column;
  gap: 8px;
}

/* MESSAGES */
.msg-bubble-wrap {
  display: flex;
  gap: 8px;
  animation: slideIn 0.2s ease;
}

.msg-bubble-wrap.mine {
  flex-direction: row-reverse;
}

.msg-avatar-sm {
  width: 28px; height: 28px;
  border-radius: 50%;
  background: linear-gradient(135deg, var(--gold-dark), var(--bg3));
  border: 1px solid var(--border-bright);
  display: flex; align-items: center; justify-content: center;
  font-family: var(--font-mono);
  font-size: 10px;
  color: var(--gold);
  flex-shrink: 0;
  align-self: flex-end;
}

.msg-bubble {
  max-width: 72%;
  padding: 10px 14px;
  border-radius: 18px;
  font-size: 13px;
  line-height: 1.5;
  word-break: break-word;
  position: relative;
}

.msg-bubble-wrap:not(.mine) .msg-bubble {
  background: var(--bg3);
  border: 1px solid var(--border);
  border-bottom-left-radius: 4px;
  color: var(--text);
}

.msg-bubble-wrap.mine .msg-bubble {
  background: linear-gradient(135deg, var(--gold-dark), #a07828);
  color: #fff;
  border-bottom-right-radius: 4px;
}

.msg-time {
  font-family: var(--font-mono);
  font-size: 9px;
  color: rgba(255,255,255,0.5);
  margin-top: 4px;
  text-align: right;
}

.msg-bubble-wrap:not(.mine) .msg-time {
  color: var(--text-muted);
  text-align: left;
}

.msg-image {
  max-width: 100%;
  border-radius: 12px;
  margin-bottom: 4px;
  cursor: pointer;
  display: block;
}

/* CHAT INPUT */
.chat-input-area {
  padding: 10px 12px;
  border-top: 1px solid var(--border);
  display: flex;
  align-items: flex-end;
  gap: 8px;
  background: var(--bg2);
  flex-shrink: 0;
}

.chat-input {
  flex: 1;
  background: var(--bg3);
  border: 1px solid var(--border);
  color: var(--text);
  font-family: var(--font-ui);
  font-size: 13px;
  padding: 10px 14px;
  border-radius: 22px;
  outline: none;
  resize: none;
  max-height: 100px;
  overflow-y: auto;
  line-height: 1.4;
  transition: border-color 0.2s;
}

.chat-input:focus { border-color: var(--gold); }
.chat-input::placeholder { color: var(--text-muted); }

.chat-send-btn {
  width: 40px; height: 40px;
  background: var(--gold);
  border: none;
  border-radius: 50%;
  color: var(--bg);
  font-size: 16px;
  cursor: pointer;
  display: flex; align-items: center; justify-content: center;
  transition: all 0.2s;
  flex-shrink: 0;
}

.chat-send-btn:hover { background: var(--gold-light); transform: scale(1.05); }
.chat-send-btn:active { transform: scale(0.95); }

.chat-attach-btn {
  width: 36px; height: 36px;
  background: var(--bg3);
  border: 1px solid var(--border);
  border-radius: 50%;
  color: var(--text-muted);
  font-size: 16px;
  cursor: pointer;
  display: flex; align-items: center; justify-content: center;
  transition: all 0.2s;
  flex-shrink: 0;
}

.chat-attach-btn:hover { border-color: var(--gold); color: var(--gold); }

/* NEW CONV BTN */
.new-conv-btn {
  position: fixed;
  bottom: 76px; right: 16px;
  width: 52px; height: 52px;
  background: linear-gradient(135deg, var(--gold-dark), var(--gold));
  border: none;
  border-radius: 50%;
  color: var(--bg);
  font-size: 22px;
  cursor: pointer;
  display: flex; align-items: center; justify-content: center;
  box-shadow: 0 4px 20px rgba(201,168,76,0.4);
  z-index: 90;
  transition: all 0.2s;
}

.new-conv-btn:hover { transform: scale(1.08); box-shadow: 0 6px 28px rgba(201,168,76,0.5); }

/* SEARCH USERS */
.user-search-result {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 12px 14px;
  background: var(--bg3);
  border: 1px solid var(--border);
  border-radius: 10px;
  margin-bottom: 8px;
  cursor: pointer;
  transition: all 0.2s;
}

.user-search-result:hover { border-color: var(--border-bright); background: var(--bg4); }

.anon-name-display {
  font-size: 13px;
  font-weight: 700;
  color: var(--text);
}

.anon-sub {
  font-family: var(--font-mono);
  font-size: 10px;
  color: var(--text-muted);
  margin-top: 2px;
}

/* TYPING INDICATOR */
.typing-indicator {
  display: flex;
  gap: 4px;
  align-items: center;
  padding: 8px 12px;
  background: var(--bg3);
  border-radius: 18px;
  border-bottom-left-radius: 4px;
  border: 1px solid var(--border);
  width: fit-content;
  display: none;
}

.typing-indicator.show { display: flex; }

.typing-dot {
  width: 6px; height: 6px;
  background: var(--text-muted);
  border-radius: 50%;
  animation: typingBounce 1.2s infinite;
}

.typing-dot:nth-child(2) { animation-delay: 0.2s; }
.typing-dot:nth-child(3) { animation-delay: 0.4s; }

@keyframes typingBounce {
  0%, 60%, 100% { transform: translateY(0); }
  30% { transform: translateY(-6px); opacity: 0.6; }
}

.msg-date-sep {
  text-align: center;
  font-family: var(--font-mono);
  font-size: 10px;
  color: var(--text-muted);
  margin: 8px 0;
  letter-spacing: 1px;
}

/* Msgs section layout */
#section-msgs {
  display: none;
  flex-direction: column;
}

#section-msgs.active {
  display: flex;
}

.msgs-list-view {
  flex: 1;
}

.msgs-header {
  padding: 16px;
  border-bottom: 1px solid var(--border);
  display: flex;
  align-items: center;
  justify-content: space-between;
}

.anon-notice {
  margin: 12px 16px;
  padding: 10px 14px;
  background: rgba(201,168,76,0.06);
  border: 1px solid var(--border);
  border-radius: 10px;
  font-family: var(--font-mono);
  font-size: 11px;
  color: var(--text-muted);
  line-height: 1.5;
}

.anon-notice span { color: var(--gold); }

</style>
</head>
<body>

<!-- IMAGE VIEWER -->
<div class="img-viewer" id="imgViewer">
  <button class="img-viewer-close" onclick="closeImageViewer()">‚úï</button>
  <img id="imgViewerSrc" src="" alt="">
</div>

<!-- TOAST CONTAINER -->
<div class="toast-container" id="toastContainer"></div>

<!-- NOTIF PANEL -->
<div class="notif-panel" id="notifPanel">
  <div class="notif-header">Notifications</div>
  <div id="notifList">
    <div class="loading"><div class="spinner"></div></div>
  </div>
</div>

<!-- INSTALL BANNER -->
<div class="install-banner hidden" id="installBanner">
  <div class="install-banner-text">
    <div class="install-banner-title">üì± Installer X-ZONE</div>
    <div class="install-banner-sub">Acc√®s instantan√©, fonctionne hors ligne</div>
  </div>
  <button class="install-btn" onclick="installPWA()">Installer</button>
  <button class="install-close" onclick="document.getElementById('installBanner').classList.add('hidden')">‚úï</button>
</div>

<!-- ===== AUTH PAGE ===== -->
<div id="auth-page" class="page active">
  <div class="auth-logo">
    <div class="logo-text">X‚ÄîZONE</div>
    <div class="tagline">// Espace Libre & Anonyme</div>
  </div>

  <div class="auth-card">
    <div class="auth-tabs">
      <button class="auth-tab active" onclick="switchAuthTab('login')">Connexion</button>
      <button class="auth-tab" onclick="switchAuthTab('register')">Cr√©er un compte</button>
    </div>

    <!-- LOGIN FORM -->
    <div class="auth-form active" id="loginForm">
      <div class="form-group">
        <label class="form-label">Pseudonyme</label>
        <input type="text" class="form-input" id="loginPseudo" placeholder="Votre pseudo..." autocomplete="username">
      </div>
      <div class="form-group">
        <label class="form-label">Mot de passe</label>
        <input type="password" class="form-input" id="loginPassword" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="current-password">
      </div>
      <button class="btn btn-gold" onclick="login()">Entrer dans la zone</button>
      <button class="fingerprint-btn" onclick="loginWithFingerprint()">
        <span class="fingerprint-icon">ü™™</span>
        Connexion par empreinte digitale
      </button>
    </div>

    <!-- REGISTER FORM -->
    <div class="auth-form" id="registerForm">
      <div class="form-group">
        <label class="form-label">Pr√©nom</label>
        <input type="text" class="form-input" id="regPrenom" placeholder="Votre pr√©nom..." autocomplete="given-name">
      </div>
      <div class="form-group">
        <label class="form-label">Nom</label>
        <input type="text" class="form-input" id="regNom" placeholder="Votre nom..." autocomplete="family-name">
      </div>
      <div class="form-group">
        <label class="form-label">Pseudonyme</label>
        <input type="text" class="form-input" id="regPseudo" placeholder="Choisissez un pseudo..." autocomplete="username">
      </div>
      <div class="form-group">
        <label class="form-label">Mot de passe</label>
        <input type="password" class="form-input" id="regPassword" placeholder="Minimum 6 caract√®res..." autocomplete="new-password">
      </div>
      <button class="btn btn-gold" onclick="register()">Rejoindre X-ZONE</button>
    </div>
  </div>
</div>

<!-- ===== APP PAGE ===== -->
<div id="app-page" class="page">
  <!-- TOP BAR -->
  <div class="topbar">
    <div class="topbar-logo">X</div>
    <div class="topbar-section" id="topbarSection">Le Flux</div>
    <div class="topbar-actions">
      <button class="icon-btn notif-dot" onclick="toggleNotif()" title="Notifications">üîî</button>
      <button class="icon-btn" onclick="toggleSearch()" title="Rechercher">üîç</button>
    </div>
  </div>

  <!-- CONTENT -->
  <div class="content">

    <!-- FLUX SECTION -->
    <div class="section active" id="section-flux">
      <div class="filter-tabs">
        <button class="filter-tab active" onclick="setFilter('all', this)">üî• Tout</button>
        <button class="filter-tab" onclick="setFilter('top', this)">‚≠ê Top</button>
        <button class="filter-tab" onclick="setFilter('media', this)">üì∏ M√©dias</button>
        <button class="filter-tab" onclick="setFilter('latest', this)">üïê R√©cent</button>
      </div>

      <div class="compose-area">
        <div class="compose-inner">
          <div class="upload-preview" id="uploadPreview">
            <img id="uploadPreviewImg" src="" alt="">
            <button class="remove-upload" onclick="removeUpload()">‚úï</button>
          </div>
          <textarea class="compose-textarea" id="postText" placeholder="Exprimez-vous librement..."></textarea>
          <div class="compose-actions">
            <span class="compose-meta">ID: <span id="sessionId">‚Äî</span></span>
            <button class="mini-btn" onclick="document.getElementById('imageUploadInput').click()">üì∏</button>
            <button class="mini-btn" onclick="document.getElementById('videoUploadInput').click()">üé¨</button>
            <input type="file" id="imageUploadInput" accept="image/*" style="display:none" onchange="handleImageSelect(event)">
            <input type="file" id="videoUploadInput" accept="video/*" style="display:none" onchange="handleVideoSelect(event)">
            <button class="send-btn" onclick="submitPost()">Poster</button>
          </div>
        </div>
      </div>

      <div class="posts-feed" id="postsFeed">
        <div class="loading"><div class="spinner"></div>Chargement...</div>
      </div>
    </div>

    <!-- FACTIONS SECTION -->
    <div class="section" id="section-factions">
      <div class="faction-detail" id="factionDetail">
        <!-- Dynamic content -->
      </div>

      <div id="factionsMain">
        <div class="factions-header">
          <div class="section-title">Factions</div>
          <div class="search-bar">
            <input type="text" class="search-input" id="factionSearch" placeholder="#tag ou nom..." oninput="filterFactions(this.value)">
          </div>
        </div>
        <div class="factions-grid" id="factionsGrid">
          <div class="loading"><div class="spinner"></div></div>
        </div>
      </div>
    </div>

    <!-- MARKET SECTION -->
    <div class="section" id="section-market">
      <div class="market-header">
        <div class="section-title">Black Market</div>
        <button class="mini-btn" onclick="openModal('createListingModal')">+ Annonce</button>
      </div>
      <div class="filter-tabs">
        <button class="filter-tab active" onclick="setMarketFilter('all', this)">Tout</button>
        <button class="filter-tab" onclick="setMarketFilter('BTC', this)">‚Çø Bitcoin</button>
        <button class="filter-tab" onclick="setMarketFilter('XMR', this)">‚¨° Monero</button>
        <button class="filter-tab" onclick="setMarketFilter('verified', this)">‚úî V√©rifi√©s</button>
      </div>
      <div class="market-grid" id="marketGrid">
        <div class="loading" style="grid-column:1/-1"><div class="spinner"></div>Chargement...</div>
      </div>
    </div>

    <!-- PROFIL SECTION -->
    <div class="section" id="section-profil">
      <div class="profile-section">
        <div class="profile-avatar" id="profileAvatarDisplay">?</div>
        <div class="profile-name" id="profileNameDisplay">‚Äî</div>
        <div class="profile-pseudo" id="profilePseudoDisplay">@‚Äî</div>
        <div class="profile-id" id="profileIdDisplay">ID: ‚Äî</div>
        <div class="profile-stats">
          <div class="stat">
            <div class="stat-num" id="statPosts">0</div>
            <div class="stat-label">Posts</div>
          </div>
          <div class="stat">
            <div class="stat-num" id="statVotes">0</div>
            <div class="stat-label">Votes</div>
          </div>
          <div class="stat">
            <div class="stat-num" id="statFactions">0</div>
            <div class="stat-label">Factions</div>
          </div>
        </div>
      </div>

      <div class="profile-menu">
        <div class="menu-item" onclick="openModal('notifSettingsModal')">
          <span class="menu-item-icon">üîî</span>
          Notifications Push
          <span class="menu-item-arrow">‚Ä∫</span>
        </div>
        <div class="menu-item" onclick="openModal('changePasswordModal')">
          <span class="menu-item-icon">üîê</span>
          Changer le mot de passe
          <span class="menu-item-arrow">‚Ä∫</span>
        </div>
        <div class="menu-item" onclick="setupFingerprint()">
          <span class="menu-item-icon">ü™™</span>
          Configurer l'empreinte digitale
          <span class="menu-item-arrow">‚Ä∫</span>
        </div>
        <div class="menu-item" onclick="openModal('aboutModal')">
          <span class="menu-item-icon">‚ÑπÔ∏è</span>
          √Ä propos de X-ZONE
          <span class="menu-item-arrow">‚Ä∫</span>
        </div>
        <div class="menu-item danger" onclick="logout()">
          <span class="menu-item-icon">üö™</span>
          D√©connexion
        </div>
      </div>
    </div>


    <!-- MESSAGES SECTION -->
    <div class="section" id="section-msgs">
      <!-- Conversations list view -->
      <div class="msgs-list-view" id="msgsListView">
        <div class="msgs-header">
          <div class="section-title">Messages</div>
        </div>
        <div class="anon-notice">
          üé≠ <span>Anonymat total</span> ‚Äî Tous les utilisateurs s'appellent <span>User</span> + code unique. Seul vous connaissez votre identit√© r√©elle.
        </div>
        <div class="conv-list" id="convList">
          <div class="loading"><div class="spinner"></div>Chargement...</div>
        </div>
      </div>

      <!-- Chat view -->
      <div class="chat-view" id="chatView">
        <div class="chat-header">
          <button class="chat-back" onclick="closeChatView()">‚Äπ</button>
          <div class="conv-avatar" id="chatAvatar" style="width:36px;height:36px;font-size:12px">?</div>
          <div class="chat-user-info">
            <div class="chat-user-name">
              <span id="chatUserName">User</span>
              <span class="online-dot" id="chatOnlineDot" style="display:none"></span>
            </div>
            <div class="chat-anon-label" id="chatAnonLabel">Utilisateur anonyme</div>
          </div>
        </div>
        <div class="chat-messages" id="chatMessages">
          <div class="loading"><div class="spinner"></div></div>
        </div>
        <div class="chat-input-area">
          <button class="chat-attach-btn" onclick="document.getElementById('chatImgInput').click()">üìé</button>
          <input type="file" id="chatImgInput" accept="image/*" style="display:none" onchange="sendImageMsg(event)">
          <textarea class="chat-input" id="chatInput" placeholder="Message..." rows="1"
            onkeydown="handleChatKey(event)"
            oninput="this.style.height='auto';this.style.height=this.scrollHeight+'px';notifyTyping()"></textarea>
          <button class="chat-send-btn" onclick="sendMessage()">‚û§</button>
        </div>
      </div>

      <!-- FAB new conversation -->
      <button class="new-conv-btn" id="newConvFab" onclick="openModal('newConvModal')" title="Nouvelle conversation">‚úâ</button>
    </div>

  </div><!-- end content -->

  <!-- BOTTOM NAV -->
  <nav class="bottom-nav">
    <button class="nav-item active" onclick="switchSection('flux', this)">
      <span class="nav-icon">‚ö°</span>
      <span class="nav-label">Flux</span>
    </button>
    <button class="nav-item" onclick="switchSection('factions', this)">
      <span class="nav-icon">üè¥</span>
      <span class="nav-label">Factions</span>
    </button>
    <button class="nav-item" onclick="switchSection('market', this)">
      <span class="nav-icon">üõí</span>
      <span class="nav-label">Market</span>
    </button>
    <button class="nav-item" onclick="switchSection('msgs', this)" style="position:relative">
      <span class="nav-icon">üí¨</span>
      <span class="nav-label">Messages</span>
      <span class="msg-badge" id="msgNavBadge">0</span>
    </button>
    <button class="nav-item" onclick="switchSection('profil', this)">
      <span class="nav-icon">üë§</span>
      <span class="nav-label">Profil</span>
    </button>
  </nav>
</div>

<!-- ===== MODALS ===== -->

<!-- NEW CONVERSATION MODAL -->
<div class="modal-overlay" id="newConvModal">
  <div class="modal">
    <div class="modal-header">
      <span class="modal-title">Nouvelle conversation</span>
      <button class="modal-close" onclick="closeModal('newConvModal')">‚úï</button>
    </div>
    <div class="anon-notice" style="margin:0 0 16px">
      üé≠ Les pseudos r√©els sont masqu√©s ‚Äî chaque utilisateur appara√Æt comme <span style="color:var(--gold)">User + code</span>
    </div>
    <div class="form-group">
      <label class="form-label">Rechercher un utilisateur</label>
      <input type="text" class="form-input" id="userSearchInput" placeholder="Tapez un pseudo..." oninput="searchUsers(this.value)">
    </div>
    <div id="userSearchResults" style="margin-top:8px"></div>
  </div>
</div>

<!-- CREATE FACTION -->
<div class="modal-overlay" id="createFactionModal">
  <div class="modal">
    <div class="modal-header">
      <span class="modal-title">Cr√©er une Faction</span>
      <button class="modal-close" onclick="closeModal('createFactionModal')">‚úï</button>
    </div>
    <div class="form-group">
      <label class="form-label">Nom de la faction</label>
      <input type="text" class="form-input" id="factionName" placeholder="Ex: Crypto Cartel">
    </div>
    <div class="form-group">
      <label class="form-label">Emoji</label>
      <input type="text" class="form-input" id="factionEmoji" placeholder="üè¥" maxlength="2">
    </div>
    <div class="form-group">
      <label class="form-label">Tags (s√©par√©s par des espaces)</label>
      <input type="text" class="form-input" id="factionTags" placeholder="#crypto #trading #anon">
    </div>
    <div class="form-group">
      <label class="form-label">Description</label>
      <textarea class="form-input" id="factionDesc" rows="3" placeholder="D√©crivez votre faction..." style="resize:vertical"></textarea>
    </div>
    <button class="btn btn-gold" onclick="createFaction()">Cr√©er la Faction</button>
  </div>
</div>

<!-- CREATE LISTING -->
<div class="modal-overlay" id="createListingModal">
  <div class="modal">
    <div class="modal-header">
      <span class="modal-title">Nouvelle Annonce</span>
      <button class="modal-close" onclick="closeModal('createListingModal')">‚úï</button>
    </div>
    <div class="form-group">
      <label class="form-label">Titre</label>
      <input type="text" class="form-input" id="listingTitle" placeholder="Ce que vous vendez...">
    </div>
    <div class="form-group">
      <label class="form-label">Description</label>
      <textarea class="form-input" id="listingDesc" rows="3" placeholder="D√©tails..." style="resize:vertical"></textarea>
    </div>
    <div class="form-group">
      <label class="form-label">Prix</label>
      <input type="text" class="form-input" id="listingPrice" placeholder="Ex: 0.001 BTC ou 5 XMR">
    </div>
    <div class="form-group">
      <label class="form-label">Crypto accept√©e</label>
      <select class="form-input" id="listingCrypto" style="cursor:pointer">
        <option value="BTC">‚Çø Bitcoin (BTC)</option>
        <option value="XMR">‚¨° Monero (XMR)</option>
      </select>
    </div>
    <div class="form-group">
      <label class="form-label">Adresse crypto</label>
      <input type="text" class="form-input" id="listingAddress" placeholder="Votre adresse de r√©ception...">
    </div>
    <div class="form-group">
      <label class="form-label">Image (optionnel)</label>
      <button class="mini-btn" style="width:100%;padding:12px" onclick="document.getElementById('listingImgInput').click()">üì∏ Ajouter une image</button>
      <input type="file" id="listingImgInput" accept="image/*" style="display:none" onchange="handleListingImage(event)">
      <div id="listingImgPreview" style="display:none;margin-top:8px">
        <img id="listingImgPreviewImg" style="width:100%;border-radius:8px;max-height:160px;object-fit:cover">
      </div>
    </div>
    <button class="btn btn-gold" onclick="createListing()">Publier l'annonce</button>
  </div>
</div>

<!-- NOTIF SETTINGS -->
<div class="modal-overlay" id="notifSettingsModal">
  <div class="modal">
    <div class="modal-header">
      <span class="modal-title">Notifications</span>
      <button class="modal-close" onclick="closeModal('notifSettingsModal')">‚úï</button>
    </div>
    <p style="color:var(--text-muted);font-size:13px;margin-bottom:20px">Activez les notifications push pour √™tre alert√© des nouveaux posts et messages dans vos factions.</p>
    <button class="btn btn-gold" onclick="requestPushPermission()">Activer les notifications</button>
    <button class="btn btn-outline" onclick="disablePush()" style="margin-top:10px">D√©sactiver</button>
  </div>
</div>

<!-- CHANGE PASSWORD -->
<div class="modal-overlay" id="changePasswordModal">
  <div class="modal">
    <div class="modal-header">
      <span class="modal-title">Changer mot de passe</span>
      <button class="modal-close" onclick="closeModal('changePasswordModal')">‚úï</button>
    </div>
    <div class="form-group">
      <label class="form-label">Ancien mot de passe</label>
      <input type="password" class="form-input" id="oldPassword" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
    </div>
    <div class="form-group">
      <label class="form-label">Nouveau mot de passe</label>
      <input type="password" class="form-input" id="newPassword" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
    </div>
    <button class="btn btn-gold" onclick="changePassword()">Mettre √† jour</button>
  </div>
</div>

<!-- ABOUT -->
<div class="modal-overlay" id="aboutModal">
  <div class="modal">
    <div class="modal-header">
      <span class="modal-title">√Ä propos</span>
      <button class="modal-close" onclick="closeModal('aboutModal')">‚úï</button>
    </div>
    <p style="font-family:var(--font-display);font-size:32px;color:var(--gold);font-style:italic;margin-bottom:16px">X‚ÄîZONE</p>
    <p style="color:var(--text-muted);font-size:13px;line-height:1.7">Plateforme de communication libre et anonyme. Z√©ro log. Z√©ro censure. Powered by cryptographie et d√©centralisation.</p>
    <div style="margin-top:16px;font-family:var(--font-mono);font-size:11px;color:var(--border-bright)">
      v1.0.0 ‚Äî Build 2025<br>
      üîí AES-256 Encrypted<br>
      üåê PWA Ready<br>
      ‚Çø Crypto Native
    </div>
  </div>
</div>

<!-- LISTING DETAIL -->
<div class="modal-overlay" id="listingDetailModal">
  <div class="modal">
    <div class="modal-header">
      <span class="modal-title" id="ldTitle">‚Äî</span>
      <button class="modal-close" onclick="closeModal('listingDetailModal')">‚úï</button>
    </div>
    <div id="ldImage" style="margin-bottom:16px;display:none">
      <img id="ldImg" style="width:100%;border-radius:10px;max-height:240px;object-fit:cover">
    </div>
    <p id="ldDesc" style="font-size:14px;color:var(--text-muted);margin-bottom:16px;line-height:1.6"></p>
    <div style="display:flex;align-items:center;gap:8px;margin-bottom:12px">
      <span style="font-family:var(--font-mono);font-size:18px;color:var(--gold)" id="ldPrice"></span>
      <span class="listing-badge" id="ldCrypto"></span>
    </div>
    <div style="font-family:var(--font-mono);font-size:12px;color:var(--text-muted);margin-bottom:6px">Adresse de paiement :</div>
    <div class="crypto-address" id="ldAddress" onclick="copyAddress()" title="Cliquer pour copier"></div>
    <div style="font-family:var(--font-mono);font-size:10px;color:var(--text-muted);margin-top:8px">üìã Cliquer pour copier l'adresse</div>
    <div style="font-family:var(--font-mono);font-size:10px;color:var(--border-bright);margin-top:8px" id="ldSeller"></div>
    <div style="display:flex;gap:8px;margin-top:16px" id="ldStars"></div>
  </div>
</div>

<!-- Firebase + App Scripts -->
<script type="module">
import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js';
import { getFirestore, collection, doc, addDoc, getDoc, getDocs, setDoc, updateDoc, query, orderBy, limit, onSnapshot, serverTimestamp, where, increment } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js';

const firebaseConfig = {
  apiKey: "AIzaSyDHRxGdHpM2RFtvGMhXOu3slrT2JlmyNLM",
  authDomain: "data-fae4a.firebaseapp.com",
  databaseURL: "https://data-fae4a-default-rtdb.firebaseio.com",
  projectId: "data-fae4a",
  storageBucket: "data-fae4a.firebasestorage.app",
  messagingSenderId: "1077301559347",
  appId: "1:1077301559347:web:3405ab3bc8e1010d9e6346",
  measurementId: "G-C631QW9NDN"
};

const CLOUDINARY = { cloudName: 'djxcqczh1', uploadPreset: 'database' };
const VAPID_PUBLIC = 'BLCbphULBOAUvzpAvs3LjmotBJiuKc_grJmqVyxDX-z8HZo46tECs5kvJU8C9ORGUKBAQRUJesF1b96EuQ885aI';

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// ===== STATE =====
let currentUser = null;
let currentFilter = 'all';
let currentMarketFilter = 'all';
let uploadedImageUrl = null;
let uploadedVideoUrl = null;
let listingImageUrl = null;
let unsubPosts = null;
let deferredPrompt = null;
let videoObserver = null;
let globalMuted = true;

// ===== UTILS =====
window.showToast = function(msg, type='info') {
  const c = document.getElementById('toastContainer');
  const t = document.createElement('div');
  t.className = `toast ${type}`;
  const icons = { success:'‚úÖ', error:'‚ùå', info:'‚ÑπÔ∏è' };
  t.innerHTML = `<span>${icons[type]||'‚ÑπÔ∏è'}</span><span>${msg}</span>`;
  c.appendChild(t);
  setTimeout(() => {
    t.style.animation = 'toastOut 0.3s ease forwards';
    setTimeout(() => t.remove(), 300);
  }, 3000);
};

window.openModal = function(id) {
  document.getElementById(id).classList.add('active');
};

window.closeModal = function(id) {
  document.getElementById(id).classList.remove('active');
  // Close if click outside
};

document.querySelectorAll('.modal-overlay').forEach(o => {
  o.addEventListener('click', e => {
    if (e.target === o) o.classList.remove('active');
  });
});

function generateId() {
  return Math.random().toString(36).substring(2, 9).toUpperCase();
}

function hashPassword(pwd) {
  let hash = 0;
  for (let i = 0; i < pwd.length; i++) {
    const char = pwd.charCodeAt(i);
    hash = ((hash << 5) - hash) + char;
    hash = hash & hash;
  }
  return Math.abs(hash).toString(16);
}

function timeAgo(ts) {
  if (!ts) return 'maintenant';
  const date = ts.toDate ? ts.toDate() : new Date(ts);
  const diff = (Date.now() - date.getTime()) / 1000;
  if (diff < 60) return '√† l\'instant';
  if (diff < 3600) return `il y a ${Math.floor(diff/60)}min`;
  if (diff < 86400) return `il y a ${Math.floor(diff/3600)}h`;
  return `il y a ${Math.floor(diff/86400)}j`;
}

// ===== AUTH =====
window.switchAuthTab = function(tab) {
  document.querySelectorAll('.auth-tab').forEach((t,i) => {
    t.classList.toggle('active', (i===0 && tab==='login') || (i===1 && tab==='register'));
  });
  document.getElementById('loginForm').classList.toggle('active', tab==='login');
  document.getElementById('registerForm').classList.toggle('active', tab==='register');
};
// Init default
document.getElementById('loginForm').classList.add('active');

window.register = async function() {
  const prenom = document.getElementById('regPrenom').value.trim();
  const nom = document.getElementById('regNom').value.trim();
  const pseudo = document.getElementById('regPseudo').value.trim();
  const password = document.getElementById('regPassword').value;

  if (!prenom || !nom || !pseudo || !password) return showToast('Tous les champs sont requis', 'error');
  if (password.length < 6) return showToast('Mot de passe trop court (min 6)', 'error');

  try {
    // Check pseudo uniqueness
    const snap = await getDocs(query(collection(db, 'users'), where('pseudo', '==', pseudo)));
    if (!snap.empty) return showToast('Ce pseudo est d√©j√† pris', 'error');

    const userId = generateId() + generateId();
    const userData = {
      prenom, nom, pseudo,
      passwordHash: hashPassword(password),
      userId,
      createdAt: serverTimestamp(),
      posts: 0,
      votes: 0,
      factions: 0
    };

    await setDoc(doc(db, 'users', userId), userData);
    localStorage.setItem('xzone_user_id', userId);
    localStorage.setItem('xzone_pseudo', pseudo);
    
    await loginUser({ ...userData, id: userId });
    showToast(`Bienvenue dans X-ZONE, @${pseudo}!`, 'success');
  } catch(e) {
    console.error(e);
    showToast('Erreur lors de la cr√©ation du compte', 'error');
  }
};

window.login = async function() {
  const pseudo = document.getElementById('loginPseudo').value.trim();
  const password = document.getElementById('loginPassword').value;

  if (!pseudo || !password) return showToast('Remplissez tous les champs', 'error');

  try {
    const snap = await getDocs(query(collection(db, 'users'), where('pseudo', '==', pseudo)));
    if (snap.empty) return showToast('Pseudo introuvable', 'error');

    const userDoc = snap.docs[0];
    const userData = userDoc.data();

    if (userData.passwordHash !== hashPassword(password)) return showToast('Mot de passe incorrect', 'error');

    localStorage.setItem('xzone_user_id', userDoc.id);
    localStorage.setItem('xzone_pseudo', pseudo);

    await loginUser({ ...userData, id: userDoc.id });
    showToast(`Content de te revoir, @${pseudo}!`, 'success');
  } catch(e) {
    console.error(e);
    showToast('Erreur de connexion', 'error');
  }
};

window.loginWithFingerprint = async function() {
  const storedUserId = localStorage.getItem('xzone_user_id');
  if (!storedUserId) return showToast('Aucun compte enregistr√© sur cet appareil', 'error');

  if (!window.PublicKeyCredential) return showToast('Biom√©trie non support√©e sur ce navigateur', 'error');

  try {
    // Check for stored credential
    const storedCredId = localStorage.getItem('xzone_cred_id');
    if (!storedCredId) return showToast('Configurez d\'abord l\'empreinte dans votre profil', 'error');

    const credential = await navigator.credentials.get({
      publicKey: {
        challenge: new Uint8Array(32),
        allowCredentials: [{
          type: 'public-key',
          id: Uint8Array.from(atob(storedCredId), c => c.charCodeAt(0))
        }],
        userVerification: 'required',
        timeout: 60000
      }
    });

    if (credential) {
      const snap = await getDoc(doc(db, 'users', storedUserId));
      if (!snap.exists()) return showToast('Utilisateur introuvable', 'error');
      const userData = snap.data();
      await loginUser({ ...userData, id: storedUserId });
      showToast(`Connect√© via empreinte, @${userData.pseudo}!`, 'success');
    }
  } catch(e) {
    console.error(e);
    showToast('√âchec de l\'authentification biom√©trique', 'error');
  }
};

window.setupFingerprint = async function() {
  if (!window.PublicKeyCredential) return showToast('Biom√©trie non support√©e sur ce navigateur', 'error');
  if (!currentUser) return;

  try {
    const credential = await navigator.credentials.create({
      publicKey: {
        challenge: new Uint8Array(32),
        rp: { name: 'X-ZONE', id: location.hostname || 'localhost' },
        user: {
          id: new TextEncoder().encode(currentUser.id),
          name: currentUser.pseudo,
          displayName: `${currentUser.prenom} ${currentUser.nom}`
        },
        pubKeyCredParams: [{ type: 'public-key', alg: -7 }],
        authenticatorSelection: { userVerification: 'required', authenticatorAttachment: 'platform' },
        timeout: 60000
      }
    });

    if (credential) {
      const credId = btoa(String.fromCharCode(...new Uint8Array(credential.rawId)));
      localStorage.setItem('xzone_cred_id', credId);
      showToast('Empreinte digitale configur√©e!', 'success');
    }
  } catch(e) {
    console.error(e);
    showToast('Impossible de configurer la biom√©trie', 'error');
  }
};

async function loginUser(userData) {
  currentUser = userData;
  
  // Update UI
  const initial = (userData.prenom || '?')[0].toUpperCase();
  document.getElementById('profileAvatarDisplay').textContent = initial;
  document.getElementById('profileNameDisplay').textContent = `${userData.prenom} ${userData.nom}`;
  document.getElementById('profilePseudoDisplay').textContent = `@${userData.pseudo}`;
  document.getElementById('profileIdDisplay').textContent = `ID: ${userData.userId || userData.id}`;
  document.getElementById('sessionId').textContent = userData.pseudo;
  document.getElementById('statPosts').textContent = userData.posts || 0;
  document.getElementById('statVotes').textContent = userData.votes || 0;
  document.getElementById('statFactions').textContent = userData.factions || 0;

  // Switch page
  document.getElementById('auth-page').classList.remove('active');
  document.getElementById('app-page').classList.add('active');

  // Load data
  loadPosts();
  loadFactions();
  loadMarket();
  loadNotifications();

  // Register push
  await tryRegisterPush();
  // Watch unread messages
  watchUnreadCount();
  // Hide msgs FAB initially
  const fab = document.getElementById('newConvFab');
  if (fab) fab.style.display = 'none';
}

window.logout = function() {
  if (unsubPosts) unsubPosts();
  currentUser = null;
  localStorage.removeItem('xzone_user_id');
  document.getElementById('app-page').classList.remove('active');
  document.getElementById('auth-page').classList.add('active');
  showToast('D√©connect√©', 'info');
};

// Auto login check
async function autoLogin() {
  const savedId = localStorage.getItem('xzone_user_id');
  if (!savedId) return;
  try {
    const snap = await getDoc(doc(db, 'users', savedId));
    if (snap.exists()) {
      await loginUser({ ...snap.data(), id: savedId });
    }
  } catch(e) { console.error(e); }
}

// ===== POSTS =====
window.submitPost = async function() {
  if (!currentUser) return;
  const text = document.getElementById('postText').value.trim();
  if (!text && !uploadedImageUrl) return showToast('√âcrivez quelque chose!', 'error');

  const postData = {
    text,
    imageUrl: uploadedImageUrl || null,
    videoUrl: uploadedVideoUrl || null,
    pseudo: currentUser.pseudo,
    userId: currentUser.id,
    score: 0,
    upvotes: 0,
    downvotes: 0,
    createdAt: serverTimestamp()
  };

  try {
    await addDoc(collection(db, 'posts'), postData);
    document.getElementById('postText').value = '';
    removeUpload();
    // Increment posts count
    await updateDoc(doc(db, 'users', currentUser.id), { posts: increment(1) });
    document.getElementById('statPosts').textContent = parseInt(document.getElementById('statPosts').textContent) + 1;
    showToast('Post publi√©!', 'success');
  } catch(e) {
    console.error(e);
    showToast('Erreur lors de la publication', 'error');
  }
};

function loadPosts() {
  if (unsubPosts) unsubPosts();
  const q = query(collection(db, 'posts'), orderBy('createdAt', 'desc'), limit(50));
  unsubPosts = onSnapshot(q, snap => {
    let posts = snap.docs.map(d => ({ id: d.id, ...d.data() }));
    
    if (currentFilter === 'top') posts.sort((a,b) => (b.score||0) - (a.score||0));
    else if (currentFilter === 'media') posts = posts.filter(p => p.imageUrl);

    renderPosts(posts);
  });
}

function renderPosts(posts) {
  const feed = document.getElementById('postsFeed');
  if (!posts.length) {
    feed.innerHTML = `<div class="empty-state"><div class="empty-icon">‚ö°</div><div class="empty-title">Aucun post</div><div class="empty-sub">Soyez le premier √† publier</div></div>`;
    return;
  }

  feed.innerHTML = posts.map(p => {
    const initial = (p.pseudo || '?')[0].toUpperCase();
    const userVotes = JSON.parse(localStorage.getItem('xzone_votes') || '{}');
    const myVote = userVotes[p.id];
    const isOwner = currentUser && p.userId === currentUser.id;

    const mediaHtml = p.videoUrl
      ? `<div class="post-video-wrap paused" id="vwrap-${p.id}" onclick="toggleVideo('${p.id}')">
           <video class="post-video" id="vid-${p.id}" src="${p.videoUrl}" loop playsinline preload="metadata" muted></video>
           <div class="video-overlay"><div class="play-icon">‚ñ∂</div></div>
           <div class="video-duration" id="vdur-${p.id}">0:00</div>
           <button class="video-mute-btn" id="vmute-${p.id}" onclick="event.stopPropagation();toggleMute('${p.id}')">üîá</button>
           <div class="video-progress" onclick="event.stopPropagation();seekVideo(event,'${p.id}')">
             <div class="video-progress-fill" id="vprog-${p.id}"></div>
           </div>
         </div>`
      : p.imageUrl
      ? `<img class="post-image" src="${p.imageUrl}" alt="" onclick="openImageViewer('${p.imageUrl}')">`
      : '';

    return `
    <div class="post-card" data-id="${p.id}">
      <div class="post-header">
        <div class="post-avatar">${initial}</div>
        <div class="post-meta">
          <div class="post-pseudo">@${p.pseudo || 'anon'}</div>
          <div class="post-time">${timeAgo(p.createdAt)}</div>
        </div>
        ${isOwner ? `<button class="delete-post-btn" onclick="deletePost('${p.id}')">üóë Supprimer</button>` : ''}
      </div>
      ${p.text ? `<div class="post-text">${escapeHtml(p.text)}</div>` : ''}
      ${mediaHtml}
      <div class="post-actions">
        <button class="vote-btn ${myVote==='up'?'active-up':''}" onclick="vote('${p.id}', 'up')">‚ñ≤ <span>${p.upvotes||0}</span></button>
        <span class="post-score">${p.score||0}</span>
        <button class="vote-btn ${myVote==='down'?'active-down':''}" onclick="vote('${p.id}', 'down')">‚ñº <span>${p.downvotes||0}</span></button>
        <button class="vote-btn" style="margin-left:auto" onclick="sharePost('${p.id}')">‚Üó</button>
      </div>
    </div>`;
  }).join('');

  // Init TikTok-style autoplay after render
  initVideoObserver();
  // Bind time updates
  posts.filter(p => p.videoUrl).forEach(p => bindVideoEvents(p.id));
}

function escapeHtml(text) {
  const map = {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'};
  return text.replace(/[&<>"']/g, m => map[m]);
}

window.vote = async function(postId, type) {
  const votes = JSON.parse(localStorage.getItem('xzone_votes') || '{}');
  if (votes[postId] === type) return; // Already voted

  const delta = type === 'up' ? 1 : -1;
  const prevDelta = votes[postId] ? (votes[postId]==='up' ? -1 : 1) : 0;

  votes[postId] = type;
  localStorage.setItem('xzone_votes', JSON.stringify(votes));

  try {
    const updates = { score: increment(delta + prevDelta) };
    if (type === 'up') updates.upvotes = increment(1);
    else updates.downvotes = increment(1);
    if (prevDelta) {
      if (votes[postId]==='up') updates.downvotes = increment(-1);
      else updates.upvotes = increment(-1);
    }
    await updateDoc(doc(db, 'posts', postId), updates);
  } catch(e) { console.error(e); }
};

window.sharePost = function(postId) {
  if (navigator.share) {
    navigator.share({ title: 'X-ZONE', text: 'Regarde ce post sur X-ZONE!', url: window.location.href });
  } else {
    navigator.clipboard.writeText(window.location.href + '?post=' + postId);
    showToast('Lien copi√©!', 'success');
  }
};

window.setFilter = function(filter, el) {
  currentFilter = filter;
  document.querySelectorAll('#section-flux .filter-tab').forEach(t => t.classList.remove('active'));
  el.classList.add('active');
  loadPosts();
};

// ===== IMAGE UPLOAD =====
window.handleImageSelect = async function(e) {
  const file = e.target.files[0];
  if (!file) return;
  showToast('Upload en cours...', 'info');

  try {
    const url = await uploadToCloudinary(file);
    uploadedImageUrl = url;
    document.getElementById('uploadPreviewImg').src = url;
    document.getElementById('uploadPreview').classList.add('active');
    showToast('Image upload√©e!', 'success');
  } catch(err) {
    showToast('Erreur upload image', 'error');
  }
};

window.removeUpload = function() {
  uploadedImageUrl = null;
  uploadedVideoUrl = null;
  document.getElementById('uploadPreview').classList.remove('active');
  document.getElementById('uploadPreviewImg').src = '';
  document.getElementById('imageUploadInput').value = '';
  document.getElementById('videoUploadInput').value = '';
};

async function uploadToCloudinary(file) {
  const fd = new FormData();
  fd.append('file', file);
  fd.append('upload_preset', CLOUDINARY.uploadPreset);
  const res = await fetch(`https://api.cloudinary.com/v1_1/${CLOUDINARY.cloudName}/image/upload`, { method:'POST', body: fd });
  const data = await res.json();
  if (!data.secure_url) throw new Error('Upload failed');
  return data.secure_url;
}

window.handleListingImage = async function(e) {
  const file = e.target.files[0];
  if (!file) return;
  try {
    listingImageUrl = await uploadToCloudinary(file);
    document.getElementById('listingImgPreviewImg').src = listingImageUrl;
    document.getElementById('listingImgPreview').style.display = 'block';
  } catch(e) { showToast('Erreur upload', 'error'); }
};

// ===== VIDEO UPLOAD =====
window.handleVideoSelect = async function(e) {
  const file = e.target.files[0];
  if (!file) return;
  if (file.size > 100 * 1024 * 1024) return showToast('Vid√©o trop lourde (max 100MB)', 'error');
  showToast('Upload vid√©o en cours...', 'info');

  try {
    const fd = new FormData();
    fd.append('file', file);
    fd.append('upload_preset', CLOUDINARY.uploadPreset);
    fd.append('resource_type', 'video');
    const res = await fetch(`https://api.cloudinary.com/v1_1/${CLOUDINARY.cloudName}/video/upload`, { method:'POST', body: fd });
    const data = await res.json();
    if (!data.secure_url) throw new Error('Upload failed');
    uploadedVideoUrl = data.secure_url;
    uploadedImageUrl = null;
    // Show preview with video
    document.getElementById('uploadPreviewImg').src = data.secure_url.replace('/upload/', '/upload/so_0,f_jpg/');
    document.getElementById('uploadPreview').classList.add('active');
    showToast('Vid√©o upload√©e!', 'success');
  } catch(err) {
    console.error(err);
    showToast('Erreur upload vid√©o', 'error');
  }
};

// ===== TIKTOK VIDEO PLAYER =====
function initVideoObserver() {
  if (videoObserver) videoObserver.disconnect();

  videoObserver = new IntersectionObserver((entries) => {
    entries.forEach(entry => {
      const wrap = entry.target;
      const vid = wrap.querySelector('video');
      if (!vid) return;

      if (entry.intersectionRatio >= 0.6) {
        // Auto-play when 60% visible
        vid.muted = globalMuted;
        vid.play().then(() => {
          wrap.classList.remove('paused');
          updateMuteBtn(vid.dataset.id, globalMuted);
        }).catch(() => {});
      } else {
        // Pause when leaving viewport
        vid.pause();
        wrap.classList.add('paused');
      }
    });
  }, { threshold: [0, 0.3, 0.6, 1.0] });

  document.querySelectorAll('.post-video-wrap').forEach(wrap => {
    videoObserver.observe(wrap);
  });
}

function bindVideoEvents(postId) {
  const vid = document.getElementById('vid-' + postId);
  if (!vid) return;
  vid.dataset.id = postId;

  vid.addEventListener('timeupdate', () => {
    if (!vid.duration) return;
    const pct = (vid.currentTime / vid.duration) * 100;
    const prog = document.getElementById('vprog-' + postId);
    if (prog) prog.style.width = pct + '%';

    const dur = document.getElementById('vdur-' + postId);
    if (dur) {
      const rem = vid.duration - vid.currentTime;
      const m = Math.floor(rem / 60);
      const s = Math.floor(rem % 60).toString().padStart(2, '0');
      dur.textContent = `-${m}:${s}`;
    }
  });

  vid.addEventListener('ended', () => {
    vid.currentTime = 0;
    vid.play();
  });
}

window.toggleVideo = function(postId) {
  const vid = document.getElementById('vid-' + postId);
  const wrap = document.getElementById('vwrap-' + postId);
  if (!vid || !wrap) return;

  if (vid.paused) {
    vid.muted = globalMuted;
    vid.play();
    wrap.classList.remove('paused');
  } else {
    vid.pause();
    wrap.classList.add('paused');
  }
};

window.toggleMute = function(postId) {
  const vid = document.getElementById('vid-' + postId);
  if (!vid) return;
  globalMuted = !globalMuted;
  // Apply to all playing videos
  document.querySelectorAll('.post-video').forEach(v => { v.muted = globalMuted; });
  updateMuteBtn(postId, globalMuted);
};

function updateMuteBtn(postId, muted) {
  // Update all mute buttons to reflect global state
  document.querySelectorAll('[id^="vmute-"]').forEach(btn => {
    btn.textContent = muted ? 'üîá' : 'üîä';
  });
}

window.seekVideo = function(e, postId) {
  const vid = document.getElementById('vid-' + postId);
  const bar = e.currentTarget;
  if (!vid || !vid.duration) return;
  const rect = bar.getBoundingClientRect();
  const pct = (e.clientX - rect.left) / rect.width;
  vid.currentTime = pct * vid.duration;
};

// ===== DELETE POST =====
window.deletePost = async function(postId) {
  if (!currentUser) return;
  if (!confirm('Supprimer ce post d√©finitivement?')) return;

  try {
    const { deleteDoc } = await import('https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js');
    await deleteDoc(doc(db, 'posts', postId));
    // Remove card from DOM instantly
    const card = document.querySelector(`.post-card[data-id="${postId}"]`);
    if (card) {
      card.style.animation = 'slideOut 0.3s ease forwards';
      setTimeout(() => card.remove(), 300);
    }
    showToast('Post supprim√©', 'success');
    // Decrement counter
    await updateDoc(doc(db, 'users', currentUser.id), { posts: increment(-1) });
    const el = document.getElementById('statPosts');
    if (el) el.textContent = Math.max(0, parseInt(el.textContent) - 1);
  } catch(e) {
    console.error(e);
    showToast('Erreur suppression', 'error');
  }
};

// ===== IMAGE VIEWER =====
window.openImageViewer = function(url) {
  document.getElementById('imgViewerSrc').src = url;
  document.getElementById('imgViewer').classList.add('active');
};

window.closeImageViewer = function() {
  document.getElementById('imgViewer').classList.remove('active');
};

// ===== FACTIONS =====
async function loadFactions() {
  try {
    const snap = await getDocs(collection(db, 'factions'));
    const factions = snap.docs.map(d => ({ id: d.id, ...d.data() }));
    renderFactions(factions);
  } catch(e) { console.error(e); }
}

function renderFactions(factions) {
  const grid = document.getElementById('factionsGrid');
  grid.innerHTML = `
    <button class="create-faction-btn" onclick="openModal('createFactionModal')">
      <span style="font-size:24px">+</span>
      <span>Cr√©er une Faction</span>
    </button>
    ${factions.map(f => `
    <div class="faction-card" onclick="openFaction('${f.id}')">
      <div class="faction-emoji">${f.emoji || 'üè¥'}</div>
      <div class="faction-name">${escapeHtml(f.name || '')}</div>
      <div class="faction-tag">${(f.tags || '').split(' ').slice(0,2).map(t => `<span class="tag">${t}</span>`).join('')}</div>
      <div class="faction-members">üë• ${f.members || 1} membres</div>
    </div>`).join('')}
  `;
}

window.filterFactions = function(query) {
  const q = query.toLowerCase();
  document.querySelectorAll('.faction-card:not(.create-faction-btn)').forEach(card => {
    const text = card.textContent.toLowerCase();
    card.style.display = text.includes(q) ? '' : 'none';
  });
};

window.openFaction = async function(factionId) {
  try {
    const snap = await getDoc(doc(db, 'factions', factionId));
    if (!snap.exists()) return;
    const f = snap.data();

    const detail = document.getElementById('factionDetail');
    const main = document.getElementById('factionsMain');
    
    // Load faction posts
    const postsSnap = await getDocs(query(collection(db, 'factions', factionId, 'posts'), orderBy('createdAt', 'desc'), limit(30)));
    const posts = postsSnap.docs.map(d => ({ id: d.id, ...d.data() }));

    detail.innerHTML = `
      <div class="faction-detail-header">
        <button class="back-btn" onclick="closeFaction()">‚Üê Retour</button>
        <div style="display:flex;align-items:center;gap:12px">
          <span style="font-size:36px">${f.emoji || 'üè¥'}</span>
          <div>
            <div style="font-size:18px;font-weight:700">${escapeHtml(f.name)}</div>
            <div style="font-size:12px;color:var(--text-muted)">${f.tags || ''}</div>
          </div>
        </div>
        <p style="font-size:13px;color:var(--text-muted);margin-top:10px;line-height:1.5">${escapeHtml(f.description || '')}</p>
      </div>
      <div class="compose-area">
        <div class="compose-inner">
          <textarea class="compose-textarea" id="factionPostText" placeholder="Poster dans cette faction..."></textarea>
          <div class="compose-actions">
            <button class="send-btn" onclick="submitFactionPost('${factionId}')">Poster</button>
          </div>
        </div>
      </div>
      <div class="posts-feed" id="factionPostsFeed">
        ${posts.length ? posts.map(p => `
          <div class="post-card">
            <div class="post-header">
              <div class="post-avatar">${(p.pseudo || '?')[0].toUpperCase()}</div>
              <div class="post-meta">
                <div class="post-pseudo">@${p.pseudo || 'anon'}</div>
                <div class="post-time">${timeAgo(p.createdAt)}</div>
              </div>
            </div>
            ${p.text ? `<div class="post-text">${escapeHtml(p.text)}</div>` : ''}
          </div>`).join('') : '<div class="empty-state"><div class="empty-icon">üè¥</div><div class="empty-title">Aucun post</div></div>'}
      </div>
    `;

    detail.classList.add('active');
    main.style.display = 'none';
  } catch(e) { console.error(e); }
};

window.closeFaction = function() {
  document.getElementById('factionDetail').classList.remove('active');
  document.getElementById('factionsMain').style.display = '';
};

window.submitFactionPost = async function(factionId) {
  const text = document.getElementById('factionPostText').value.trim();
  if (!text) return;
  try {
    await addDoc(collection(db, 'factions', factionId, 'posts'), {
      text, pseudo: currentUser.pseudo, userId: currentUser.id, createdAt: serverTimestamp()
    });
    document.getElementById('factionPostText').value = '';
    openFaction(factionId);
    showToast('Post√©!', 'success');
  } catch(e) { showToast('Erreur', 'error'); }
};

window.createFaction = async function() {
  const name = document.getElementById('factionName').value.trim();
  const emoji = document.getElementById('factionEmoji').value || 'üè¥';
  const tags = document.getElementById('factionTags').value.trim();
  const description = document.getElementById('factionDesc').value.trim();

  if (!name) return showToast('Nom requis', 'error');

  try {
    await addDoc(collection(db, 'factions'), {
      name, emoji, tags, description,
      ownerId: currentUser.id,
      ownerPseudo: currentUser.pseudo,
      members: 1,
      createdAt: serverTimestamp()
    });
    closeModal('createFactionModal');
    loadFactions();
    showToast(`Faction "${name}" cr√©√©e!`, 'success');
    document.getElementById('factionName').value = '';
    document.getElementById('factionEmoji').value = '';
    document.getElementById('factionTags').value = '';
    document.getElementById('factionDesc').value = '';
  } catch(e) {
    console.error(e);
    showToast('Erreur cr√©ation faction', 'error');
  }
};

// ===== MARKET =====
async function loadMarket() {
  try {
    const snap = await getDocs(query(collection(db, 'listings'), orderBy('createdAt', 'desc'), limit(40)));
    let listings = snap.docs.map(d => ({ id: d.id, ...d.data() }));
    
    if (currentMarketFilter !== 'all') {
      if (currentMarketFilter === 'verified') listings = listings.filter(l => l.verified);
      else listings = listings.filter(l => l.crypto === currentMarketFilter);
    }
    
    renderMarket(listings);
  } catch(e) { console.error(e); }
}

function renderMarket(listings) {
  const grid = document.getElementById('marketGrid');
  if (!listings.length) {
    grid.innerHTML = `<div class="empty-state" style="grid-column:1/-1"><div class="empty-icon">üõí</div><div class="empty-title">Aucune annonce</div><div class="empty-sub">Soyez le premier √† vendre</div></div>`;
    return;
  }
  grid.innerHTML = listings.map(l => `
    <div class="listing-card" onclick="openListing(${JSON.stringify(l).replace(/"/g,'&quot;')})">
      <div class="listing-img">
        ${l.imageUrl ? `<img src="${l.imageUrl}" alt="">` : 'üè∑Ô∏è'}
      </div>
      <div class="listing-body">
        <div class="listing-title">${escapeHtml(l.title || '')}</div>
        <div class="listing-price">${l.crypto === 'BTC' ? '‚Çø' : '‚¨°'} ${escapeHtml(l.price || '')}</div>
        ${l.verified ? '<div class="listing-badge">‚úî V√âRIFI√â</div>' : ''}
      </div>
    </div>`).join('');
}

window.openListing = function(listing) {
  document.getElementById('ldTitle').textContent = listing.title || '';
  document.getElementById('ldDesc').textContent = listing.description || '';
  document.getElementById('ldPrice').textContent = listing.price || '';
  document.getElementById('ldCrypto').textContent = listing.crypto || '';
  document.getElementById('ldAddress').textContent = listing.address || '‚Äî';
  document.getElementById('ldSeller').textContent = `Vendeur: @${listing.sellerPseudo || 'anon'}`;
  
  if (listing.imageUrl) {
    document.getElementById('ldImage').style.display = 'block';
    document.getElementById('ldImg').src = listing.imageUrl;
  } else {
    document.getElementById('ldImage').style.display = 'none';
  }

  // Rating stars
  const stars = listing.rating || 0;
  document.getElementById('ldStars').innerHTML = [1,2,3,4,5].map(i => 
    `<span style="font-size:20px;cursor:pointer;color:${i<=stars?'var(--gold)':'var(--border)'}" onclick="rateListing('${listing.id}',${i})">${i<=stars?'‚òÖ':'‚òÜ'}</span>`
  ).join('');

  openModal('listingDetailModal');
};

window.rateListing = async function(id, stars) {
  try {
    await updateDoc(doc(db, 'listings', id), { rating: stars });
    showToast(`Not√© ${stars}/5`, 'success');
  } catch(e) { console.error(e); }
};

window.copyAddress = function() {
  const addr = document.getElementById('ldAddress').textContent;
  navigator.clipboard.writeText(addr).then(() => showToast('Adresse copi√©e!', 'success'));
};

window.setMarketFilter = function(filter, el) {
  currentMarketFilter = filter;
  document.querySelectorAll('#section-market .filter-tab').forEach(t => t.classList.remove('active'));
  el.classList.add('active');
  loadMarket();
};

window.createListing = async function() {
  const title = document.getElementById('listingTitle').value.trim();
  const desc = document.getElementById('listingDesc').value.trim();
  const price = document.getElementById('listingPrice').value.trim();
  const crypto = document.getElementById('listingCrypto').value;
  const address = document.getElementById('listingAddress').value.trim();

  if (!title || !price || !address) return showToast('Titre, prix et adresse requis', 'error');

  try {
    await addDoc(collection(db, 'listings'), {
      title, description: desc, price, crypto, address,
      imageUrl: listingImageUrl || null,
      sellerId: currentUser.id,
      sellerPseudo: currentUser.pseudo,
      verified: false,
      rating: 0,
      createdAt: serverTimestamp()
    });
    closeModal('createListingModal');
    loadMarket();
    showToast('Annonce publi√©e!', 'success');
    // Reset
    ['listingTitle','listingDesc','listingPrice','listingAddress'].forEach(id => document.getElementById(id).value = '');
    listingImageUrl = null;
    document.getElementById('listingImgPreview').style.display = 'none';
  } catch(e) {
    console.error(e);
    showToast('Erreur publication annonce', 'error');
  }
};

// ===== NAVIGATION =====
window.switchSection = function(section, el) {
  document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
  document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
  document.getElementById('section-' + section).classList.add('active');
  el.classList.add('active');
  
  const labels = { flux: 'Le Flux', factions: 'Factions', market: 'Black Market', msgs: 'Messages', profil: 'Profil' };
  document.getElementById('topbarSection').textContent = labels[section] || '';

  // Hide FAB when not in msgs
  const fab = document.getElementById('newConvFab');
  if (fab) fab.style.display = section === 'msgs' ? 'flex' : 'none';

  if (section === 'msgs') {
    loadConversations();
  }
};

// ===== SEARCH TOGGLE =====
window.toggleSearch = function() {
  const s = document.getElementById('factionSearch');
  if (document.getElementById('section-factions').classList.contains('active')) {
    s.focus();
  }
  showToast('Utilisez la barre de recherche dans Factions', 'info');
};

// ===== NOTIFICATIONS =====
async function loadNotifications() {
  const list = document.getElementById('notifList');
  try {
    const snap = await getDocs(query(collection(db, 'notifications'), where('userId', '==', currentUser.id), orderBy('createdAt', 'desc'), limit(20)));
    const notifs = snap.docs.map(d => ({ id: d.id, ...d.data() }));
    
    if (!notifs.length) {
      list.innerHTML = '<div class="loading" style="font-size:12px">Aucune notification</div>';
      return;
    }
    
    list.innerHTML = notifs.map(n => `
      <div class="notif-item ${n.read ? '' : 'unread'}">
        <div>${escapeHtml(n.message || '')}</div>
        <div class="notif-item-meta">${timeAgo(n.createdAt)}</div>
      </div>`).join('');
  } catch(e) {
    list.innerHTML = '<div class="loading" style="font-size:12px">Aucune notification</div>';
  }
}

window.toggleNotif = function() {
  document.getElementById('notifPanel').classList.toggle('open');
  // Close on outside click
  setTimeout(() => {
    document.addEventListener('click', function handler(e) {
      if (!document.getElementById('notifPanel').contains(e.target) && !e.target.closest('.icon-btn')) {
        document.getElementById('notifPanel').classList.remove('open');
        document.removeEventListener('click', handler);
      }
    });
  }, 10);
};

// ===== PUSH NOTIFICATIONS =====
async function tryRegisterPush() {
  if (!('serviceWorker' in navigator) || !('PushManager' in window)) return;
  if (Notification.permission === 'denied') return;
  if (Notification.permission === 'granted') {
    await registerPushSubscription();
  }
}

window.requestPushPermission = async function() {
  const permission = await Notification.requestPermission();
  if (permission === 'granted') {
    await registerPushSubscription();
    showToast('Notifications activ√©es!', 'success');
    closeModal('notifSettingsModal');
  } else {
    showToast('Permission refus√©e', 'error');
  }
};

async function registerPushSubscription() {
  try {
    const reg = await navigator.serviceWorker.ready;
    const sub = await reg.pushManager.subscribe({
      userVisibleOnly: true,
      applicationServerKey: urlBase64ToUint8Array(VAPID_PUBLIC)
    });
    
    // Save subscription to Firestore
    await setDoc(doc(db, 'push_subscriptions', currentUser.id), {
      subscription: JSON.stringify(sub),
      userId: currentUser.id,
      pseudo: currentUser.pseudo,
      updatedAt: serverTimestamp()
    });
  } catch(e) { console.error('Push registration failed:', e); }
}

window.disablePush = async function() {
  try {
    const reg = await navigator.serviceWorker.ready;
    const sub = await reg.pushManager.getSubscription();
    if (sub) await sub.unsubscribe();
    showToast('Notifications d√©sactiv√©es', 'info');
    closeModal('notifSettingsModal');
  } catch(e) { console.error(e); }
};

function urlBase64ToUint8Array(base64String) {
  const padding = '='.repeat((4 - base64String.length % 4) % 4);
  const base64 = (base64String + padding).replace(/-/g, '+').replace(/_/g, '/');
  const rawData = window.atob(base64);
  const outputArray = new Uint8Array(rawData.length);
  for (let i = 0; i < rawData.length; ++i) outputArray[i] = rawData.charCodeAt(i);
  return outputArray;
}

// ===== CHANGE PASSWORD =====
window.changePassword = async function() {
  const oldPwd = document.getElementById('oldPassword').value;
  const newPwd = document.getElementById('newPassword').value;
  
  if (!oldPwd || !newPwd) return showToast('Remplissez tous les champs', 'error');
  if (newPwd.length < 6) return showToast('Nouveau mot de passe trop court', 'error');
  if (hashPassword(oldPwd) !== currentUser.passwordHash) return showToast('Ancien mot de passe incorrect', 'error');
  
  try {
    const newHash = hashPassword(newPwd);
    await updateDoc(doc(db, 'users', currentUser.id), { passwordHash: newHash });
    currentUser.passwordHash = newHash;
    closeModal('changePasswordModal');
    showToast('Mot de passe mis √† jour!', 'success');
    document.getElementById('oldPassword').value = '';
    document.getElementById('newPassword').value = '';
  } catch(e) { showToast('Erreur', 'error'); }
};

// ===== PWA INSTALL =====
window.addEventListener('beforeinstallprompt', e => {
  e.preventDefault();
  deferredPrompt = e;
  setTimeout(() => document.getElementById('installBanner').classList.remove('hidden'), 3000);
});

window.installPWA = function() {
  if (!deferredPrompt) return;
  deferredPrompt.prompt();
  deferredPrompt.userChoice.then(res => {
    deferredPrompt = null;
    document.getElementById('installBanner').classList.add('hidden');
    if (res.outcome === 'accepted') showToast('X-ZONE install√©!', 'success');
  });
};

// ===== SERVICE WORKER =====
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('sw.js').catch(e => console.log('SW not found:', e));
}

// ===== KEYBOARD EVENTS =====
document.addEventListener('keydown', e => {
  if (e.key === 'Escape') {
    document.querySelectorAll('.modal-overlay.active').forEach(m => m.classList.remove('active'));
    document.getElementById('imgViewer').classList.remove('active');
    document.getElementById('notifPanel').classList.remove('open');
  }
  if (e.ctrlKey && e.key === 'Enter') {
    const activeSection = document.querySelector('.section.active');
    if (activeSection && activeSection.id === 'section-flux') submitPost();
  }
});


// ===== ANONYMOUS NAMING =====
// Generate a deterministic anonymous display name from userId
function getAnonName(userId) {
  // Deterministic short code from userId
  const code = userId.substring(0, 4).toUpperCase();
  return `User-${code}`;
}

function getAnonInitial(userId) {
  return 'U';
}

// ===== CONVERSATIONS =====
let currentConvId = null;
let currentPeerId = null;
let unsubMessages = null;
let typingTimeout = null;

function getConvId(uid1, uid2) {
  return [uid1, uid2].sort().join('_');
}

async function loadConversations() {
  const list = document.getElementById('convList');
  list.innerHTML = '<div class="loading"><div class="spinner"></div>Chargement...</div>';
  
  try {
    const { query: q2, collection: col, where: wh, orderBy: ob, getDocs: gd } = await import('https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js');
    
    const snap = await getDocs(query(
      collection(db, 'conversations'),
      where('participants', 'array-contains', currentUser.id),
      orderBy('lastAt', 'desc'),
      limit(30)
    ));
    
    if (snap.empty) {
      list.innerHTML = `<div class="empty-state"><div class="empty-icon">üí¨</div><div class="empty-title">Aucune conversation</div><div class="empty-sub">Appuyez sur ‚úâ pour d√©marrer</div></div>`;
      return;
    }
    
    const convs = snap.docs.map(d => ({ id: d.id, ...d.data() }));
    
    list.innerHTML = convs.map(c => {
      const peerId = c.participants.find(p => p !== currentUser.id);
      const anonName = getAnonName(peerId);
      const hasUnread = c.unread && c.unread[currentUser.id] > 0;
      const preview = c.lastMsg ? (c.lastMsg.length > 40 ? c.lastMsg.substring(0, 40) + '‚Ä¶' : c.lastMsg) : 'D√©marrer la conversation';
      
      return `
      <div class="conv-item ${hasUnread ? 'unread' : ''}" onclick="openChat('${c.id}', '${peerId}')">
        <div class="conv-avatar">${getAnonInitial(peerId)}</div>
        <div class="conv-info">
          <div class="conv-name">
            ${anonName}
            <span class="conv-anon-tag">ANON</span>
          </div>
          <div class="conv-preview">${escapeHtml(preview)}</div>
        </div>
        <div class="conv-time">${c.lastAt ? timeAgo(c.lastAt) : ''}</div>
      </div>`;
    }).join('');
    
    // Update badge
    const totalUnread = convs.reduce((acc, c) => acc + ((c.unread && c.unread[currentUser.id]) || 0), 0);
    updateMsgBadge(totalUnread);
    
  } catch(e) {
    console.error(e);
    list.innerHTML = '<div class="empty-state"><div class="empty-icon">‚ö†Ô∏è</div><div class="empty-title">Erreur de chargement</div></div>';
  }
}

function updateMsgBadge(count) {
  const badge = document.getElementById('msgNavBadge');
  if (!badge) return;
  if (count > 0) {
    badge.textContent = count > 99 ? '99+' : count;
    badge.classList.add('show');
  } else {
    badge.classList.remove('show');
  }
}

async function openChat(convId, peerId) {
  currentConvId = convId;
  currentPeerId = peerId;
  
  const anonName = getAnonName(peerId);
  document.getElementById('chatUserName').textContent = anonName;
  document.getElementById('chatAnonLabel').textContent = `Identit√© masqu√©e ‚Ä¢ ${peerId.substring(0,8).toUpperCase()}`;
  document.getElementById('chatAvatar').textContent = 'U';
  
  // Switch views
  document.getElementById('msgsListView').style.display = 'none';
  document.getElementById('chatView').classList.add('active');
  document.getElementById('newConvFab').style.display = 'none';
  
  // Mark as read
  try {
    const upd = {};
    upd[`unread.${currentUser.id}`] = 0;
    await updateDoc(doc(db, 'conversations', convId), upd);
  } catch(e) {}
  
  // Load messages realtime
  loadMessages(convId);
  
  // Focus input
  setTimeout(() => document.getElementById('chatInput').focus(), 300);
}

function loadMessages(convId) {
  if (unsubMessages) unsubMessages();
  
  const msgs = document.getElementById('chatMessages');
  msgs.innerHTML = '<div class="loading"><div class="spinner"></div></div>';
  
  const q = query(
    collection(db, 'conversations', convId, 'messages'),
    orderBy('createdAt', 'asc'),
    limit(100)
  );
  
  unsubMessages = onSnapshot(q, snap => {
    const messages = snap.docs.map(d => ({ id: d.id, ...d.data() }));
    renderMessages(messages);
  });
}

function renderMessages(messages) {
  const container = document.getElementById('chatMessages');
  
  if (!messages.length) {
    container.innerHTML = `
      <div style="text-align:center;padding:40px 20px">
        <div style="font-size:40px;margin-bottom:12px">üîí</div>
        <div style="font-family:var(--font-mono);font-size:11px;color:var(--text-muted);line-height:1.7">
          Conversation chiffr√©e<br>
          <span style="color:var(--gold)">Identit√©s anonymis√©es</span>
        </div>
      </div>`;
    return;
  }
  
  let lastDate = null;
  let html = '';
  
  messages.forEach(m => {
    const isMine = m.senderId === currentUser.id;
    const msgDate = m.createdAt ? (m.createdAt.toDate ? m.createdAt.toDate() : new Date(m.createdAt)) : new Date();
    const dateStr = msgDate.toLocaleDateString('fr-FR', { day:'numeric', month:'short' });
    
    if (dateStr !== lastDate) {
      html += `<div class="msg-date-sep">${dateStr}</div>`;
      lastDate = dateStr;
    }
    
    const timeStr = msgDate.toLocaleTimeString('fr-FR', { hour:'2-digit', minute:'2-digit' });
    const anonName = isMine ? getAnonName(currentUser.id) : getAnonName(currentPeerId);
    
    html += `
    <div class="msg-bubble-wrap ${isMine ? 'mine' : ''}">
      ${!isMine ? `<div class="msg-avatar-sm">U</div>` : ''}
      <div class="msg-bubble">
        ${m.imageUrl ? `<img class="msg-image" src="${m.imageUrl}" onclick="openImageViewer('${m.imageUrl}')">` : ''}
        ${m.text ? escapeHtml(m.text) : ''}
        <div class="msg-time">${timeStr}</div>
      </div>
      ${isMine ? `<div class="msg-avatar-sm">U</div>` : ''}
    </div>`;
  });
  
  container.innerHTML = html;
  // Scroll to bottom
  container.scrollTop = container.scrollHeight;
}

window.sendMessage = async function() {
  const input = document.getElementById('chatInput');
  const text = input.value.trim();
  if (!text || !currentConvId) return;
  
  input.value = '';
  input.style.height = 'auto';
  
  try {
    const msgData = {
      text,
      senderId: currentUser.id,
      createdAt: serverTimestamp()
    };
    
    // Add message
    await addDoc(collection(db, 'conversations', currentConvId, 'messages'), msgData);
    
    // Update conversation metadata
    const convUpd = {
      lastMsg: text,
      lastAt: serverTimestamp(),
      participants: [currentUser.id, currentPeerId]
    };
    convUpd[`unread.${currentPeerId}`] = increment(1);
    convUpd[`unread.${currentUser.id}`] = 0;
    
    await setDoc(doc(db, 'conversations', currentConvId), convUpd, { merge: true });
    
  } catch(e) {
    console.error(e);
    showToast('Erreur envoi message', 'error');
  }
};

window.sendImageMsg = async function(e) {
  const file = e.target.files[0];
  if (!file || !currentConvId) return;
  showToast('Upload image...', 'info');
  
  try {
    const url = await uploadToCloudinary(file);
    
    await addDoc(collection(db, 'conversations', currentConvId, 'messages'), {
      imageUrl: url,
      senderId: currentUser.id,
      createdAt: serverTimestamp()
    });
    
    const convUpd = { lastMsg: 'üì∏ Image', lastAt: serverTimestamp() };
    convUpd[`unread.${currentPeerId}`] = increment(1);
    await setDoc(doc(db, 'conversations', currentConvId), convUpd, { merge: true });
    
    showToast('Image envoy√©e!', 'success');
    e.target.value = '';
  } catch(err) {
    showToast('Erreur upload', 'error');
  }
};

window.handleChatKey = function(e) {
  if (e.key === 'Enter' && !e.shiftKey) {
    e.preventDefault();
    sendMessage();
  }
};

window.notifyTyping = function() {
  // Simple typing indicator via Firestore (optional)
  clearTimeout(typingTimeout);
  typingTimeout = setTimeout(() => {}, 2000);
};

window.closeChatView = function() {
  if (unsubMessages) { unsubMessages(); unsubMessages = null; }
  currentConvId = null;
  currentPeerId = null;
  document.getElementById('chatView').classList.remove('active');
  document.getElementById('msgsListView').style.display = '';
  document.getElementById('newConvFab').style.display = 'flex';
  loadConversations();
};

// ===== USER SEARCH =====
window.searchUsers = async function(query) {
  const results = document.getElementById('userSearchResults');
  if (!query || query.length < 2) { results.innerHTML = ''; return; }
  
  try {
    // Search by pseudo
    const snap = await getDocs(collection(db, 'users'));
    const users = snap.docs
      .map(d => ({ id: d.id, ...d.data() }))
      .filter(u => u.id !== currentUser.id && u.pseudo && u.pseudo.toLowerCase().includes(query.toLowerCase()))
      .slice(0, 8);
    
    if (!users.length) {
      results.innerHTML = `<div style="color:var(--text-muted);font-size:13px;padding:12px">Aucun utilisateur trouv√©</div>`;
      return;
    }
    
    results.innerHTML = users.map(u => {
      const anonName = getAnonName(u.id);
      return `
      <div class="user-search-result" onclick="startConversation('${u.id}')">
        <div class="conv-avatar" style="width:36px;height:36px;font-size:12px">U</div>
        <div>
          <div class="anon-name-display">${anonName} <span class="conv-anon-tag">ANON</span></div>
          <div class="anon-sub">Identit√© masqu√©e</div>
        </div>
        <span style="margin-left:auto;color:var(--gold);font-size:18px">‚Ä∫</span>
      </div>`;
    }).join('');
    
  } catch(e) {
    console.error(e);
  }
};

window.startConversation = async function(peerId) {
  closeModal('newConvModal');
  document.getElementById('userSearchInput').value = '';
  document.getElementById('userSearchResults').innerHTML = '';
  
  const convId = getConvId(currentUser.id, peerId);
  
  // Ensure conversation doc exists
  try {
    await setDoc(doc(db, 'conversations', convId), {
      participants: [currentUser.id, peerId],
      lastMsg: '',
      lastAt: serverTimestamp(),
    }, { merge: true });
  } catch(e) { console.error(e); }
  
  // Switch to msgs section
  const navBtns = document.querySelectorAll('.nav-item');
  navBtns.forEach(b => b.classList.remove('active'));
  // Find msgs nav btn
  const msgsBtn = Array.from(navBtns).find(b => b.textContent.includes('Messages'));
  if (msgsBtn) msgsBtn.classList.add('active');
  
  document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
  document.getElementById('section-msgs').classList.add('active');
  document.getElementById('topbarSection').textContent = 'Messages';
  
  await openChat(convId, peerId);
};

// Watch for new messages globally to update badge
function watchUnreadCount() {
  if (!currentUser) return;
  onSnapshot(
    query(collection(db, 'conversations'), where('participants', 'array-contains', currentUser.id)),
    snap => {
      const total = snap.docs.reduce((acc, d) => {
        const data = d.data();
        return acc + ((data.unread && data.unread[currentUser.id]) || 0);
      }, 0);
      updateMsgBadge(total);
    }
  );
}

// ===== INIT =====
autoLogin();

</script>
</body>
</html>
